<!doctype html>
<html lang="de" class="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Life RPG</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --bg:#f8fafc;
      --fg:#111827; /* fast schwarz */
      --card:#ffffff;
      --muted:#6b7280;
      --primary:#0ea5e9;
      --border:#e5e7eb;
    }
    html.dark{
      color-scheme: dark;
      --bg:#0b0f16;
      --fg:#ffffff;
      --card:#0f1623;
      --muted:#cbd5e1;
      --primary:#38bdf8;
      --border:#1f2937;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial}
    .btn{border:1px solid var(--border);background:var(--card);color:var(--fg);border-radius:.75rem;padding:.6rem .9rem;display:inline-flex;gap:.5rem;align-items:center;justify-content:center}
    .btn-primary{background:var(--primary);color:#fff;border-color:transparent}
    .btn-danger{background:#ef4444;color:#fff;border-color:transparent}
    .input, select{width:100%;border-radius:.75rem;border:1px solid var(--border);padding:.6rem .8rem;background:var(--card);color:var(--fg)}
    .card{background:var(--card);border:1px solid var(--border);border-radius:1rem;padding:1rem}
    .muted{color:var(--muted)}
    .hidden{display:none}
    .view{display:none}
    .view.active{display:block}
    .safe-header{
      position:sticky;top:0;z-index:20;
      background:linear-gradient(to bottom, color-mix(in srgb, var(--card) 92%, transparent), var(--card));
      border-bottom:1px solid var(--border);
      padding-top:calc(env(safe-area-inset-top,0px) + .6rem);
      padding-bottom:.6rem;
    }
    .titlebar{
      display:flex;align-items:center;gap:.75rem;justify-content:space-between;
    }
    .titlebar h1{margin:0;font-size:1.125rem;font-weight:700}
    .titlebar .left, .titlebar .right{min-width:3rem;display:flex;align-items:center;gap:.5rem}
    .titlebar .center{flex:1;display:flex;justify-content:center}
    .menu-grid{display:grid;grid-template-columns:1fr;gap:.75rem}
    @media(min-width:480px){ .menu-grid{grid-template-columns:1fr 1fr} }
    /* Dashboard Zahlen immer klar lesbar */
    .stat{display:flex;flex-direction:column;gap:.25rem}
    .stat .label{font-size:.8rem;color:var(--muted)}
    .stat .value{font-size:1.4rem;font-weight:800;color:var(--fg)}
    .link{color:var(--primary);text-decoration:none}
    .back-btn{cursor:pointer}
    /* Scroll-Container */
    main{min-height:100dvh;display:flex;flex-direction:column}
    .container{max-width:720px;margin:0 auto;padding:0 1rem 2.5rem}
    /* Achievements/Milestones: Schriftfarbe folgt Vars → in DarkMode automatisch weiß */
    .chip{display:inline-flex;align-items:center;gap:.4rem;font-size:.8rem;border:1px solid var(--border);background:var(--card);padding:.25rem .5rem;border-radius:.6rem}
  </style>
</head>
<body>
  <main>
    <!-- Header -->
    <header class="safe-header">
      <div class="container">
        <div class="titlebar">
          <div class="left">
            <button id="btnBack" class="btn back-btn hidden" aria-label="Zurück">⬅︎</button>
          </div>
          <div class="center">
            <h1 id="title">Life RPG</h1>
          </div>
          <div class="right">
            <button id="btnTheme" class="btn" title="Dark/Light">🌓</button>
            <button id="btnMenu" class="btn" title="Hauptmenü">☰</button>
          </div>
        </div>
      </div>
    </header>

    <!-- VIEWS -->
    <section id="view-menu" class="view active">
      <div class="container">
        <div class="card" style="margin-top:.75rem;">
          <h2 class="text-lg font-bold" style="margin:0 0 .5rem 0;">Hauptmenü</h2>
          <div class="menu-grid">
            <button data-go="dashboard" class="btn">📊 Dashboard</button>
            <button data-go="log" class="btn">📝 Log</button>
            <button data-go="catalog" class="btn">📚 Katalog</button>
            <button data-go="categories" class="btn">🏷️ Kategorien</button>
            <button data-go="missions" class="btn">🗺️ Missionen</button>
            <button data-go="specials" class="btn">⏱️ Sonderaufgaben</button>
            <button data-go="milestones" class="btn">🎯 Meilensteine</button>
            <button data-go="continuity" class="btn">♻️ Kontinuität</button>
            <button data-go="settings" class="btn">⚙️ Einstellungen</button>
          </div>
        </div>
      </div>
    </section>

    <section id="view-dashboard" class="view">
      <div class="container">
        <div class="card" style="margin-top:.75rem;">
          <h2 class="text-lg font-bold" style="margin:0 0 .75rem 0;">Übersicht</h2>
          <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:.75rem">
            <div class="stat">
              <div class="label">Punkte</div>
              <div id="statPoints" class="value">0</div>
            </div>
            <div class="stat">
              <div class="label">Level</div>
              <div id="statLevel" class="value">1</div>
            </div>
            <div class="stat">
              <div class="label">Sparstand</div>
              <div>€ <span id="statSavings" class="value">0.00</span></div>
            </div>
          </div>
          <div style="margin-top:1rem" class="muted">
            Dies ist die Baseline. Funktionen kommen in Phasen 2–8 über die Patchpoints.
          </div>
        </div>
      </div>
    </section>

    <section id="view-log" class="view">
      <div class="container">
        <div class="card" style="margin-top:.75rem;">
          <h2 class="text-lg font-bold" style="margin:0 0 .75rem 0;">Log</h2>
          <div class="muted">In Phase 3 gibt es hier Schnellauswahl, Eintragen & Löschen/Undo.</div>
          <div id="logList" style="margin-top:.75rem;display:flex;flex-direction:column;gap:.5rem"></div>
        </div>
      </div>
    </section>

    <section id="view-catalog" class="view">
      <div class="container">
        <div class="card" style="margin-top:.75rem;">
          <h2 class="text-lg font-bold" style="margin:0 0 .75rem 0;">Katalog</h2>
          <div class="muted">In Phase 2 kannst du hier Quests mit Kategorien & Multiplikatoren anlegen.</div>
          <div id="catalogList" style="margin-top:.75rem"></div>
        </div>
      </div>
    </section>

    <section id="view-categories" class="view">
      <div class="container">
        <div class="card" style="margin-top:.75rem;">
          <h2 class="text-lg font-bold" style="margin:0 0 .75rem 0;">Kategorien</h2>
          <div class="muted">In Phase 2: Kategorien anlegen/verbinden („Sonstige“ inklusive).</div>
          <div id="catList" style="margin-top:.75rem"></div>
        </div>
      </div>
    </section>

    <section id="view-missions" class="view">
      <div class="container">
        <div class="card" style="margin-top:.75rem;">
          <h2 class="text-lg font-bold" style="margin:0 0 .75rem 0;">Missionen</h2>
          <div class="muted">In Phase 4: lineare/alternative Aufgaben, Freischaltung, Abschlussbonus = 4×.</div>
          <div id="missionList" style="margin-top:.75rem"></div>
        </div>
      </div>
    </section>

    <section id="view-specials" class="view">
      <div class="container">
        <div class="card" style="margin-top:.75rem;">
          <h2 class="text-lg font-bold" style="margin:0 0 .75rem 0;">Sonderaufgaben</h2>
          <div class="muted">In Phase 5: Cooldown-Aufgaben (z. B. Blumen gießen alle 7 Tage).</div>
          <div id="specialList" style="margin-top:.75rem"></div>
        </div>
      </div>
    </section>

    <section id="view-milestones" class="view">
      <div class="container">
        <div class="card" style="margin-top:.75rem;">
          <h2 class="text-lg font-bold" style="margin:0 0 .75rem 0;">Meilensteine</h2>
          <div class="muted">In Phase 6: zeigt nur den nächsten erreichbaren Meilenstein je Bereich.</div>
          <div id="msList" style="margin-top:.75rem"></div>
        </div>
      </div>
    </section>

    <section id="view-continuity" class="view">
      <div class="container">
        <div class="card" style="margin-top:.75rem;">
          <h2 class="text-lg font-bold" style="margin:0 0 .75rem 0;">Kontinuität</h2>
          <div class="muted">In Phase 7: Multiplikator & Inaktivitäts-Strafen, „heute erledigen“ Buttons.</div>
          <div id="contList" style="margin-top:.75rem"></div>
        </div>
      </div>
    </section>

    <section id="view-settings" class="view">
      <div class="container">
        <div class="card" style="margin-top:.75rem;display:flex;flex-direction:column;gap:.75rem">
          <h2 class="text-lg font-bold" style="margin:0">Einstellungen</h2>
          <div class="grid" style="display:grid;grid-template-columns:1fr 1fr;gap:.75rem">
            <label class="text-sm">€ pro Punkt
              <input id="sEuro" type="number" step="0.01" class="input" />
            </label>
            <label class="text-sm">Basis-Levelpunkte
              <input id="sBase" type="number" class="input" />
            </label>
            <label class="text-sm">Wachstum pro Level (z. B. 0.1)
              <input id="sGrowth" type="number" step="0.01" class="input" />
            </label>
          </div>
          <div style="display:flex;gap:.5rem;flex-wrap:wrap">
            <button id="btnExport" class="btn">Export</button>
            <input id="fileImport" type="file" accept="application/json" class="hidden" />
            <button id="btnImport" class="btn">Import</button>
            <button id="btnResetAll" class="btn btn-danger">Alles löschen</button>
          </div>
          <div class="muted">Dark/Light schaltest du oben rechts mit 🌓 um (wird gespeichert).</div>
        </div>
      </div>
    </section>
  </main>

  <script>
  (()=>{

    // ==============================
    //  STORAGE (v3) + MIGRATION
    // ==============================
    const KEY = "lifeRPG_v3";
    const OLD_KEYS = ["lifeRPG_p1","lifeRPG_v1","lifeRPG_v2"];
    const todayISO = ()=> new Date().toISOString().slice(0,10);

    const defaultState = {
      version:3,
      settings:{ euro:0.10, base:100, growth:0.10, theme:"light" },
      log:[],            // [{date, questId?, questName, points}]
      quests:[],         // [{id,name,points,isBoss:false,categories:[],multiplierByCat:{catId:mult}, penaltyDays:0, penaltyPoints:0}]
      categories:[],     // [{id,name, linkToCatId:null}]  "Sonstige" hat feste id 'cat_misc'
      missions:[],       // später
      specials:[],       // später
      milestones:{}      // später
    };

    function load(){
      // v3 vorhanden?
      const raw = localStorage.getItem(KEY);
      if(raw){
        try{
          const s = JSON.parse(raw);
          // Minimal-Fallbacks
          s.version = 3;
          s.settings = Object.assign({}, defaultState.settings, s.settings||{});
          s.categories = s.categories || [];
          // Stelle sicher, dass "Sonstige" existiert:
          if(!s.categories.find(c=>c.id==="cat_misc")){
            s.categories.unshift({id:"cat_misc",name:"Sonstige",linkToCatId:null});
          }
          return s;
        }catch(e){
          console.warn("v3 state defekt, fallback auf Migration", e);
        }
      }
      // Migration aus alten Keys
      for(const k of OLD_KEYS){
        const r = localStorage.getItem(k);
        if(!r) continue;
        try{
          const o = JSON.parse(r);
          return migrateFromOld(o);
        }catch(e){
          console.warn("Migration fehlgeschlagen von", k, e);
        }
      }
      // Neu
      const fresh = structuredClone(defaultState);
      // Standard-Kategorie „Sonstige“
      fresh.categories.push({id:"cat_misc",name:"Sonstige",linkToCatId:null});
      save(fresh);
      return fresh;
    }

    function migrateFromOld(old){
      const s = structuredClone(defaultState);

      // SETTINGS
      if(old && old.settings){
        s.settings.euro   = typeof old.settings.euro   === "number" ? old.settings.euro   : s.settings.euro;
        s.settings.base   = typeof old.settings.base   === "number" ? old.settings.base   : s.settings.base;
        s.settings.growth = typeof old.settings.growth === "number" ? old.settings.growth : s.settings.growth;
      }

      // LOG
      if(Array.isArray(old.log)){
        s.log = old.log.map(e=>({
          date: e.date || todayISO(),
          questId: null,
          questName: e.quest || e.name || "Unbenannt",
          points: Number(e.points||0)
        }));
      }

      // KATALOG → QUESTS
      if(Array.isArray(old.catalog)){
        s.quests = old.catalog.map((q,i)=>({
          id: "q_"+(i+1),
          name: q.name || ("Quest "+(i+1)),
          points: Number(q.points||0),
          isBoss: !!q.boss,
          categories: [], // Phase 2
          multiplierByCat:{}, // Phase 2
          penaltyDays: 0, penaltyPoints: 0
        }));
      }else{
        // Falls nichts da ist: eine Starter-Quest
        s.quests = [
          {id:"q_1",name:"Erste Quest",points:10,isBoss:false,categories:[],multiplierByCat:{}, penaltyDays:0, penaltyPoints:0}
        ];
      }

      // Kategorien: noch leer, aber „Sonstige“ anlegen
      s.categories.push({id:"cat_misc",name:"Sonstige",linkToCatId:null});

      save(s);
      // alten Key NICHT löschen – nur falls Nutzer zurückspringen will
      return s;
    }

    function save(state){ localStorage.setItem(KEY, JSON.stringify(state)); }

    let state = load();

    // ==============================
    //  THEME (persist)
    // ==============================
    function applyTheme(){
      const root = document.documentElement;
      root.classList.toggle("dark", state.settings.theme==="dark");
      root.classList.toggle("light", state.settings.theme!=="dark");
    }
    function toggleTheme(){
      state.settings.theme = (state.settings.theme==="dark"?"light":"dark");
      save(state); applyTheme();
    }
    applyTheme();

    // ==============================
    //  NAVIGATION
    // ==============================
    let viewStack = ["menu"]; // für Back
    const titleEl = document.getElementById("title");
    const btnBack = document.getElementById("btnBack");
    const btnMenu = document.getElementById("btnMenu");
    const btnTheme= document.getElementById("btnTheme");

    const titles = {
      menu:"Life RPG",
      dashboard:"Dashboard",
      log:"Log",
      catalog:"Katalog",
      categories:"Kategorien",
      missions:"Missionen",
      specials:"Sonderaufgaben",
      milestones:"Meilensteine",
      continuity:"Kontinuität",
      settings:"Einstellungen"
    };

    function show(view, push=true){
      // Alle Views aus
      document.querySelectorAll(".view").forEach(v=>v.classList.remove("active"));
      // Gewünschte an
      const id = "view-"+view;
      const el = document.getElementById(id);
      if(!el){ console.warn("View nicht gefunden:", id); return; }
      el.classList.add("active");

      // Titel + Back
      titleEl.textContent = titles[view] || "Life RPG";
      const atRoot = (view==="menu");
      btnBack.classList.toggle("hidden", atRoot);

      // Stack
      if(push){
        if(!atRoot) viewStack.push(view);
        else viewStack = ["menu"];
      }

      // Render minimal
      if(view==="dashboard") renderDashboard();
      if(view==="log") renderLog();
      if(view==="catalog") renderCatalog();
      if(view==="categories") renderCategories();
      if(view==="missions") renderMissions();
      if(view==="specials") renderSpecials();
      if(view==="milestones") renderMilestones();
      if(view==="continuity") renderContinuity();
      if(view==="settings") renderSettings();
    }

    function goBack(){
      if(viewStack.length<=1){ show("menu", false); return; }
      viewStack.pop(); // current
      const prev = viewStack.pop() || "menu";
      show(prev, true);
    }

    // Hauptmenü-Buttons
    document.querySelectorAll('#view-menu [data-go]').forEach(btn=>{
      btn.addEventListener('click', ()=> show(btn.getAttribute('data-go')));
    });
    btnMenu.addEventListener("click", ()=>show("menu"));
    btnBack.addEventListener("click", goBack);
    btnTheme.addEventListener("click", toggleTheme);

    // ==============================
    //  BASIS-BERECHNUNG
    // ==============================
    function totalPoints(){
      return state.log.reduce((s,e)=> s + Number(e.points||0), 0);
    }
    function levelForPoints(p){
      let lvl=1, need=state.settings.base;
      while(p>=need){ lvl++; p-=need; need = Math.round(need*(1+state.settings.growth)); }
      return Math.max(1,lvl);
    }
    function totalSavings(){ return totalPoints() * Number(state.settings.euro||0); }

    // ==============================
    //  RENDER: Dashboard (minimal)
    // ==============================
    function renderDashboard(){
      document.getElementById("statPoints").textContent = totalPoints();
      document.getElementById("statLevel").textContent  = levelForPoints(totalPoints());
      document.getElementById("statSavings").textContent= totalSavings().toFixed(2);
    }

    // ==============================
    //  RENDER: Log (nur Anzeige)
    // ==============================
    function renderLog(){
      const list = document.getElementById("logList");
      if(!state.log.length){
        list.innerHTML = `<div class="muted">Noch keine Einträge.</div>`;
        return;
      }
      list.innerHTML = state.log.slice().reverse().map(e=>{
        const name = e.questName || (state.quests.find(q=>q.id===e.questId)?.name ?? "Quest");
        const pts = Number(e.points||0);
        return `<div class="card" style="display:flex;justify-content:space-between;align-items:center;">
          <div>
            <div><b>${name}</b></div>
            <div class="muted" style="font-size:.85rem">${e.date}</div>
          </div>
          <div style="font-weight:700">${pts>0?"+":""}${pts}</div>
        </div>`;
      }).join("");
    }

    // ==============================
    //  RENDER: Platzhalter anderer Views
    // ==============================
    function renderCatalog(){
      const box = document.getElementById("catalogList");
      if(!state.quests.length){ box.innerHTML = `<div class="muted">Noch keine Quests.</div>`; return; }
      box.innerHTML = state.quests.map(q=>`
        <div class="card" style="display:flex;justify-content:space-between;gap:.75rem;align-items:center;margin-bottom:.5rem">
          <div>
            <div><b>${q.name}</b></div>
            <div class="muted" style="font-size:.85rem">${q.points} Punkte ${q.isBoss?"• 👑 Boss":""}</div>
          </div>
          <span class="chip">ID: ${q.id}</span>
        </div>
      `).join("");
    }
    function renderCategories(){
      const box = document.getElementById("catList");
      if(!state.categories.length){ box.innerHTML = `<div class="muted">Noch keine Kategorien.</div>`; return; }
      box.innerHTML = state.categories.map(c=>`
        <div class="card" style="display:flex;justify-content:space-between;gap:.75rem;align-items:center;margin-bottom:.5rem">
          <div><b>${c.name}</b>${c.id==="cat_misc"?" <span class='chip'>Sonstige</span>":""}</div>
          ${c.linkToCatId ? `<span class="chip">verknüpft</span>`:""}
        </div>
      `).join("");
    }
    function renderMissions(){
      document.getElementById("missionList").innerHTML =
        `<div class="muted">Noch keine Missionen.</div>`;
    }
    function renderSpecials(){
      document.getElementById("specialList").innerHTML =
        `<div class="muted">Noch keine Sonderaufgaben.</div>`;
    }
    function renderMilestones(){
      document.getElementById("msList").innerHTML =
        `<div class="muted">Noch keine Meilensteine. (Phase 6)</div>`;
    }
    function renderContinuity(){
      document.getElementById("contList").innerHTML =
        `<div class="muted">Noch leer. (Phase 7)</div>`;
    }

    // ==============================
    //  Einstellungen (wirksam)
    // ==============================
    function renderSettings(){
      const s = state.settings;
      document.getElementById("sEuro").value   = s.euro;
      document.getElementById("sBase").value   = s.base;
      document.getElementById("sGrowth").value = s.growth;
    }

    document.getElementById("sEuro").addEventListener("change", e=>{
      state.settings.euro = Number(e.target.value||0);
      save(state); renderDashboard();
    });
    document.getElementById("sBase").addEventListener("change", e=>{
      state.settings.base = Number(e.target.value||100);
      save(state); renderDashboard();
    });
    document.getElementById("sGrowth").addEventListener("change", e=>{
      state.settings.growth = Number(e.target.value||0.1);
      save(state); renderDashboard();
    });

    document.getElementById("btnExport").addEventListener("click", ()=>{
      const blob = new Blob([JSON.stringify(state,null,2)],{type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "life_rpg_backup_v3.json";
      a.click();
    });
    document.getElementById("btnImport").addEventListener("click", ()=>{
      document.getElementById("fileImport").click();
    });
    document.getElementById("fileImport").addEventListener("change", e=>{
      const f=e.target.files?.[0]; if(!f) return;
      const reader=new FileReader();
      reader.onload=()=>{
        try{
          const incoming = JSON.parse(reader.result);
          if(!incoming || typeof incoming!=="object") throw "invalid";
          incoming.version = 3;
          // Safety: „Sonstige“ sicherstellen
          incoming.categories = incoming.categories || [];
          if(!incoming.categories.find(c=>c.id==="cat_misc")){
            incoming.categories.unshift({id:"cat_misc",name:"Sonstige",linkToCatId:null});
          }
          state = incoming; save(state);
          // Soft-refresh view
          const current = (viewStack[viewStack.length-1]||"menu");
          show(current,false);
          renderDashboard();
        }catch(err){ alert("Import fehlgeschlagen."); }
      };
      reader.readAsText(f);
    });

    document.getElementById("btnResetAll").addEventListener("click", ()=>{
      if(!confirm("Wirklich ALLE Daten löschen?")) return;
      state = structuredClone(defaultState);
      // „Sonstige“
      state.categories.push({id:"cat_misc",name:"Sonstige",linkToCatId:null});
      save(state);
      show("menu",false);
      renderDashboard();
    });

    // ==============================
    //  Startsicht
    // ==============================
    show("menu", false);

    // === PATCHPOINT: PHASE_2 ===
    // (Hier wird Phase 2 Code eingefügt – Katalog & Kategorien Logik)

    // === PATCHPOINT: PHASE_3 ===
    // (Hier wird Phase 3 Code eingefügt – Log: Eintragen, Schnellauswahl, Undo)

    // === PATCHPOINT: PHASE_4 ===
    // (Hier wird Phase 4 Code eingefügt – Missionen Freischaltung, 4× Bonus)

    // === PATCHPOINT: PHASE_5 ===
    // (Hier wird Phase 5 Code eingefügt – Sonderaufgaben mit Cooldown)

    // === PATCHPOINT: PHASE_6 ===
    // (Hier wird Phase 6 Code eingefügt – Meilensteine (nur „nächster“ sichtbar))

    // === PATCHPOINT: PHASE_7 ===
    // (Hier wird Phase 7 Code eingefügt – Kontinuität: Multiplikator/Strafen)

    // === PATCHPOINT: PHASE_8 ===
    // (Hier wird Phase 8 Code eingefügt – Kategorie-Verknüpfungen & Negativ-Kats.)

  })();
  </script>
</body>
</html>
