<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Life RPG</title>
  <script>
    tailwind = { config: { darkMode: 'class' } };
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --safe-top: env(safe-area-inset-top); }
    /* Light default: schwarz */
    html:not(.dark) body { background:#f8fafc; color:#000; }
    /* Dark: dunkler Hintergrund, Text hell */
    .dark body { background:#0b1220; color:#e5e7eb; }
    .tab { display:none; } .tab.active { display:block; }
    .btn { border-radius:.75rem; padding:.5rem 1rem; border:1px solid; border-color:#cbd5e1; background:#fff; color:#000; }
    .dark .btn { border-color:#334155; background:#111827; color:#e5e7eb; }
    .input { width:100%; border-radius:.75rem; border:1px solid #cbd5e1; padding:.5rem .75rem; background:#fff; color:#000; }
    .dark .input { border-color:#334155; background:#0f172a; color:#e5e7eb; }
    header.safe { padding-top: calc(var(--safe-top) + 28px); }
    /* Karten in beiden Themes sauber */
    .card { border:1px solid; border-color:#e2e8f0; background:#fff; }
    .dark .card { border-color:#334155; background:#0f172a; }
    /* Achievements: im hellen schwarz, im dunklen wei√ü */
    .ach { color:#000; } .dark .ach { color:#fff; }
    .ach.ok { background:#fde68a; } .ach.nok { background:#f1f5f9; }
    .dark .ach.ok { background:#7c5800; } .dark .ach.nok { background:#0f172a; border:1px solid #334155; }
    /* Dashboard KPIs: im hellen schwarz, im dunklen wei√ü */
    .kpi { color:#000; } .dark .kpi { color:#fff; }
  </style>
</head>
<body>
  <div class="max-w-xl mx-auto min-h-screen flex flex-col">
    <!-- Header -->
    <header class="safe px-4 pt-4 pb-3 sticky top-0 bg-white/85 dark:bg-slate-900/85 backdrop-blur z-10 border-b border-slate-200 dark:border-slate-700">
      <div class="flex items-center justify-between">
        <button id="btnHome" class="btn text-sm">‚ò∞ Men√º</button>
        <h1 class="text-xl font-bold">üéÆ Life RPG</h1>
        <button id="themeToggle" class="btn text-sm">üåô/‚òÄÔ∏è</button>
      </div>
    </header>

    <!-- Main -->
    <main class="flex-1 px-4 pb-8 space-y-4">
      <!-- Hauptmen√º: untereinander -->
      <section id="tab-home" class="tab active space-y-2">
        <h2 class="text-lg font-bold">Hauptmen√º</h2>
        <div class="flex flex-col gap-2">
          <button class="btn text-left" data-goto="dashboard">üìä Dashboard</button>
          <button class="btn text-left" data-goto="log">üìù Log</button>
          <button class="btn text-left" data-goto="catalog">üìö Katalog</button>
          <button class="btn text-left" data-goto="special">‚≠ê Sonderaufgaben</button>
          <button class="btn text-left" data-goto="categories">üè∑Ô∏è Kategorien</button>
          <button class="btn text-left" data-goto="milestones">üéØ Meilensteine</button>
          <button class="btn text-left" data-goto="settings">‚öôÔ∏è Einstellungen</button>
          <button class="btn text-left" data-goto="chat">üí¨ Chat</button>
        </div>
      </section>

      <!-- Dashboard -->
      <section id="tab-dashboard" class="tab space-y-4">
        <div class="grid grid-cols-3 gap-3 text-sm">
          <div class="card p-3 rounded">
            <div>Punkte</div>
            <div id="totalPoints" class="text-lg font-bold kpi">0</div>
          </div>
          <div class="card p-3 rounded">
            <div>Level</div>
            <div id="currentLevel" class="text-lg font-bold kpi">1</div>
          </div>
          <div class="card p-3 rounded">
            <div>Sparstand</div>
            <div>‚Ç¨<span id="savingsTotal" class="text-lg font-bold kpi">0.00</span></div>
          </div>
        </div>

        <div>
          <h3 class="font-bold">Level-Fortschritt</h3>
          <div id="levelBar"></div>
        </div>

        <div>
          <h3 class="font-bold">Achievements</h3>
          <div id="achievements" class="space-y-2"></div>
        </div>

        <div>
          <h3 class="font-bold">Statistik (letzte 14 Tage)</h3>
          <canvas id="statsChart" class="w-full h-40 rounded card"></canvas>
        </div>

        <div>
          <h3 class="font-bold">Heute offen</h3>
          <div id="todaySuggestions" class="space-y-2"></div>
        </div>

        <div>
          <h3 class="font-bold">Tagesziel</h3>
          <div id="dailyGoalBox" class="p-2 rounded card text-sm"></div>
        </div>

        <div class="pt-2">
          <button class="btn" data-goto="home">‚üµ Zur√ºck zum Hauptmen√º</button>
        </div>
      </section>

      <!-- Log -->
      <section id="tab-log" class="tab space-y-4">
        <div class="space-y-2">
          <input type="date" id="logDate" class="input" />
          <div class="grid gap-2">
            <select id="logQuick" class="input">
              <option value="">‚Äì Schnellauswahl aus Katalog ‚Äì</option>
            </select>
            <div id="logChips" class="flex flex-wrap gap-2"></div>
          </div>
          <input type="text" id="logQuest" class="input" placeholder="Questname (oder aus Schnellauswahl w√§hlen)" />
          <div class="grid grid-cols-2 gap-2">
            <input type="number" id="logPoints" class="input" placeholder="Punkte (optional)" />
            <input type="number" id="logMalus" class="input" placeholder="Malus (z. B. -10)" />
          </div>
          <button id="btnAddEntry" class="btn bg-blue-600 text-white">Eintragen</button>
        </div>
        <div id="logList" class="space-y-1 text-sm"></div>

        <div class="pt-2">
          <button class="btn" data-goto="home">‚üµ Zur√ºck zum Hauptmen√º</button>
        </div>
      </section>

      <!-- Katalog -->
      <section id="tab-catalog" class="tab space-y-4">
        <div class="space-y-2">
          <input id="qName" class="input" placeholder="Questname" />
          <input id="qPoints" type="number" class="input" placeholder="Punkte" />
          <label class="text-sm">Kategorie (optional)
            <input id="qCat" class="input" placeholder="z. B. Sport, Handwerk" />
          </label>
          <div class="flex items-center gap-2">
            <label class="text-sm flex items-center gap-2"><input id="qBoss" type="checkbox" />Bossquest</label>
            <label class="text-sm flex items-center gap-2"><input id="qNegative" type="checkbox" />Negativ-Kategorie</label>
            <input id="qNegImpact" type="number" class="input" placeholder="Negativ-Impact (z. B. 30)" />
          </div>
          <button id="btnAddQuest" class="btn bg-blue-600 text-white">Zur Liste hinzuf√ºgen</button>
        </div>
        <div id="catalogList" class="mt-2 space-y-2"></div>

        <div class="pt-2">
          <button class="btn" data-goto="home">‚üµ Zur√ºck zum Hauptmen√º</button>
        </div>
      </section>

      <!-- Sonderaufgaben -->
      <section id="tab-special" class="tab space-y-4">
        <h3 class="font-bold text-lg">Sonderaufgaben (Cooldown)</h3>
        <div class="grid grid-cols-3 gap-2">
          <input id="spName" class="input col-span-3" placeholder="Name (z. B. Blumen gie√üen)" />
          <input id="spPoints" type="number" class="input" placeholder="Punkte" />
          <input id="spDays" type="number" class="input" placeholder="Alle X Tage" />
          <button id="btnAddSpecial" class="btn bg-blue-600 text-white col-span-3">Hinzuf√ºgen</button>
        </div>
        <p class="text-xs text-slate-500">Nach dem Erledigen wird die Aufgabe f√ºr die angegebene Anzahl Tage gesperrt.</p>

        <div>
          <h4 class="font-bold mt-2">Jetzt verf√ºgbar</h4>
          <div id="specialAvail" class="space-y-2"></div>
        </div>

        <div>
          <h4 class="font-bold mt-4">Gesperrt</h4>
          <div id="specialLocked" class="space-y-2 text-slate-600"></div>
        </div>

        <div class="pt-2">
          <button class="btn" data-goto="home">‚üµ Zur√ºck zum Hauptmen√º</button>
        </div>
      </section>

      <!-- Kategorien -->
      <section id="tab-categories" class="tab space-y-4">
        <h3 class="font-bold text-lg">Kategorien</h3>

        <div class="card p-3 rounded space-y-2">
          <h4 class="font-bold">Neue Kategorie</h4>
          <div class="grid grid-cols-3 gap-2">
            <input id="catName" class="input col-span-2" placeholder="Name (z. B. Sport)" />
            <select id="catType" class="input">
              <option value="pos">Positiv</option>
              <option value="neg">Negativ</option>
            </select>
            <button id="btnAddCat" class="btn bg-blue-600 text-white col-span-3">Hinzuf√ºgen</button>
          </div>
        </div>

        <div class="card p-3 rounded space-y-2">
          <h4 class="font-bold">Kategorie-Verkn√ºpfungen (kein globaler Bonus)</h4>
          <div class="grid grid-cols-5 gap-2">
            <input id="linkFrom" class="input col-span-2" placeholder="von (z. B. Handwerk)" />
            <input id="linkTo" class="input col-span-2" placeholder="zu (z. B. Sport)" />
            <input id="linkBonus" class="input" type="number" step="1" placeholder="% z. B. 20" />
            <button id="btnAddLink" class="btn bg-blue-600 text-white col-span-5">Link hinzuf√ºgen</button>
          </div>
          <div id="linkList" class="text-sm"></div>
        </div>

        <div>
          <h4 class="font-bold">√úbersicht</h4>
          <div id="categoryTotals" class="space-y-2"></div>
        </div>

        <div class="pt-2">
          <button class="btn" data-goto="home">‚üµ Zur√ºck zum Hauptmen√º</button>
        </div>
      </section>

      <!-- Meilensteine -->
      <section id="tab-milestones" class="tab space-y-4">
        <h3 class="font-bold text-lg">Meilensteine (jeweils nur n√§chster sichtbar)</h3>
        <div id="milestoneBoxes" class="space-y-3"></div>

        <div class="pt-2">
          <button class="btn" data-goto="home">‚üµ Zur√ºck zum Hauptmen√º</button>
        </div>
      </section>

      <!-- Einstellungen -->
      <section id="tab-settings" class="tab space-y-4">
        <div class="space-y-2">
          <label class="text-sm">‚Ç¨ pro Punkt
            <input id="sEuro" type="number" step="0.01" class="input">
          </label>
          <label class="text-sm">Basis-Inkrement
            <input id="sBase" type="number" class="input">
          </label>
          <label class="text-sm">Wachstum (z. B. 0.1 = +10%)
            <input id="sGrowth" type="number" step="0.01" class="input">
          </label>
          <label class="text-sm">Tagesziel (Eintr√§ge pro Tag)
            <input id="sDailyGoal" type="number" class="input">
          </label>
          <label class="text-sm">Theme
            <select id="sTheme" class="input">
              <option value="light">Hell</option>
              <option value="dark">Dunkel</option>
              <option value="auto">System</option>
            </select>
          </label>
        </div>
        <div class="mt-4 space-y-2">
          <button id="btnExport" class="btn">Export</button>
          <input type="file" id="fileImport" class="hidden" accept="application/json" />
          <button id="btnImport" class="btn">Import</button>
          <button id="btnReset" class="btn bg-red-600 text-white">Alles l√∂schen</button>
        </div>

        <div class="pt-2">
          <button class="btn" data-goto="home">‚üµ Zur√ºck zum Hauptmen√º</button>
        </div>
      </section>

      <!-- Chat -->
      <section id="tab-chat" class="tab space-y-3">
        <div id="chatLog" class="h-64 overflow-y-auto card p-2 rounded text-sm"></div>
        <div class="flex gap-2">
          <input id="chatInput" class="input flex-1" placeholder="Frag nach Vorschl√§gen (‚ÄûWas soll ich machen?‚Äú) oder nenne eine Quest" />
          <button id="btnChatSend" class="btn bg-blue-600 text-white">Senden</button>
        </div>

        <div class="pt-2">
          <button class="btn" data-goto="home">‚üµ Zur√ºck zum Hauptmen√º</button>
        </div>
      </section>
    </main>
  </div>

  <script>
  // ====== STATE ======
  const SKEY = "lifeRPG_p1";
  const defaultState = {
    log: [],
    settings: { euro: 0.1, base: 100, growth: 0.1, dailyGoal: 3, theme: "light" },
    catalog: [
      {name:"Sport",points:20,boss:false,category:"Sport",negative:false,negImpact:0},
      {name:"Kein Essen bestellt",points:10,boss:false,category:"Ern√§hrung",negative:false,negImpact:0},
      {name:"Aufr√§umen",points:5,boss:false,category:"Ordnung",negative:false,negImpact:0}
    ],
    rewards: [],
    specialTasks: [], // {name, points, everyDays, lastDone}
    milestonesClaimed: [], // ['quests-100', ...]
    categories: [ {name:"Sport",type:"pos"}, {name:"Ern√§hrung",type:"pos"}, {name:"Ordnung",type:"pos"} ],
    categoryLinks: [] // {from:'Handwerk', to:'Sport', bonus:20}
  };

  function load(){
    try{
      const s = JSON.parse(localStorage.getItem(SKEY));
      if(!s) return structuredClone(defaultState);
      return migrate(s);
    }catch{
      return structuredClone(defaultState);
    }
  }
  function save(){ localStorage.setItem(SKEY, JSON.stringify(state)); }

  function migrate(s){
    s.settings = Object.assign({euro:0.1,base:100,growth:0.1,dailyGoal:3,theme:"light"}, s.settings||{});
    s.catalog = (s.catalog||[]).map(q=>({
      boss:false, category:"", negative:false, negImpact:0, ...q
    }));
    s.specialTasks = s.specialTasks || [];
    s.milestonesClaimed = s.milestonesClaimed || [];
    s.categories = s.categories || [];
    s.categoryLinks = s.categoryLinks || [];
    return s;
  }
  let state = load();

  // ====== HELPERS ======
  const todayISO = () => new Date().toISOString().slice(0,10);
  function totalPoints(){ return state.log.reduce((s,e)=>s+(e.points||0),0); }
  function euro(v){ return (v||0).toFixed(2); }
  function levelForPoints(p){
    let lvl=1, need=state.settings.base;
    while(p>=need){ lvl++; p-=need; need=Math.round(need*(1+state.settings.growth)); }
    return lvl;
  }
  function streakCount(){
    const days=[...new Set(state.log.map(e=>e.date))].sort();
    if(days.length===0) return 0;
    let streak=1;
    for(let i=days.length-1;i>0;i--){
      const d1=new Date(days[i]), d0=new Date(days[i-1]);
      const diff=(d1-d0)/(1000*60*60*24);
      if(diff===1) streak++; else break;
    }
    return streak;
  }
  // Streak-Multiplikator (max 20%)
  const STREAK_PER_DAY = 0.02, STREAK_MAX = 0.2;
  function computePoints(base){
    const mult = Math.min(STREAK_MAX, streakCount()*STREAK_PER_DAY);
    return Math.round((base||0) * (1+mult));
  }

  // Theme
  function applyTheme(){
    const t = state.settings.theme;
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    const dark = (t==='dark') || (t==='auto' && prefersDark);
    document.documentElement.classList.toggle('dark', dark);
  }

  // ====== NAV ======
  function goto(tabId){
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    document.getElementById("tab-"+tabId).classList.add("active");
    if(tabId==='dashboard') renderStats();
    if(tabId==='log') fillLogQuick();
    if(tabId==='categories') renderCategories();
  }
  function bindMenu(){
    document.getElementById("btnHome").onclick=()=>goto('home');
    document.querySelectorAll("[data-goto]").forEach(b=> b.onclick=()=>goto(b.getAttribute("data-goto")));
    document.getElementById("themeToggle").onclick=()=>{
      state.settings.theme = state.settings.theme==='dark' ? 'light' : 'dark';
      save(); applyTheme();
    };
  }

  // ====== DASHBOARD ======
  function renderLevelProgress(){
    const total=totalPoints();
    const lvl=levelForPoints(total);
    let need=state.settings.base, sum=0;
    for(let i=1;i<lvl;i++){ sum+=need; need=Math.round(need*(1+state.settings.growth)); }
    const current = total - sum;
    const pct = Math.min(100, Math.round((current/need)*100));
    return `
      <div class="w-full bg-gray-200 dark:bg-slate-800 rounded h-3 overflow-hidden">
        <div class="bg-blue-500 h-3" style="width:${pct}%"></div>
      </div>
      <div class="text-xs mt-1">Noch ${Math.max(0,need-current)} Punkte bis Level ${lvl+1}</div>
    `;
  }
  function renderAchievements(){
    const total=totalPoints();
    const s=streakCount();
    const sportCount=state.log.filter(e=>(e.quest||"").toLowerCase().includes("sport")).length;
    const list=[
      {ok: total>=100, icon:"üèÖ", text:"100 Punkte erreicht"},
      {ok: s>=5, icon:"üî•", text:"5 Tage Streak"},
      {ok: sportCount>=10, icon:"üí™", text:"10x Sport gemacht"}
    ];
    return list.map(a=>`
      <div class="ach ${a.ok?'ok':'nok'} p-2 rounded border border-slate-200 dark:border-slate-700">
        ${a.icon} ${a.text} ${a.ok?'‚úÖ':'‚ùå'}
      </div>
    `).join("");
  }
  function renderStats(){
    const cvs=document.getElementById("statsChart");
    const ctx=cvs.getContext("2d");
    const W=cvs.width=cvs.clientWidth||300;
    const H=cvs.height=cvs.clientHeight||160;
    const today=new Date();
    const days=[];
    for(let i=13;i>=0;i--){
      const d=new Date(today); d.setDate(d.getDate()-i);
      const iso=d.toISOString().slice(0,10);
      const sum=state.log.filter(e=>e.date===iso).reduce((s,e)=>s+(e.points||0),0);
      days.push({label:iso.slice(5), value:sum});
    }
    ctx.clearRect(0,0,W,H);
    const max=Math.max(10,...days.map(d=>d.value));
    const barW=W/days.length*0.6;
    const dark=document.documentElement.classList.contains('dark');
    days.forEach((d,i)=>{
      const x=i*(W/days.length)+barW*0.2;
      const h=(d.value/max)*(H-22);
      const y=H-h-18;
      ctx.fillStyle = dark ? "#60a5fa" : "#3b82f6";
      ctx.fillRect(x,y,barW,h);
      ctx.fillStyle = dark ? "#94a3b8" : "#64748b";
      ctx.font="10px sans-serif";
      if(i%2===0) ctx.fillText(d.label,x,H-5);
    });
  }
  function renderTodaySuggestions(){
    const box=document.getElementById("todaySuggestions");
    const today=todayISO();
    const done=new Set(state.log.filter(e=>e.date===today).map(e=>e.quest));
    const available=state.catalog.filter(q=>!done.has(q.name)).slice(0,5);
    box.innerHTML = available.length
      ? available.map(q=>`<button data-sug="${q.name}" class="btn w-full text-left">‚ûï ${q.name} (+${q.points})</button>`).join("")
      : `<div class="text-slate-500 text-sm">Alles erledigt üéâ</div>`;
    box.querySelectorAll("[data-sug]").forEach(b=>{
      b.onclick=()=> quickAdd(b.getAttribute("data-sug"));
    });
  }
  function renderDailyGoal(){
    const box=document.getElementById("dailyGoalBox");
    const today=todayISO();
    const count=state.log.filter(e=>e.date===today).length;
    const goal=state.settings.dailyGoal||3;
    if(count>=goal){
      box.textContent = `‚úÖ Tagesziel erreicht (${count}/${goal}) üéâ`;
    }else{
      box.textContent = `üîÑ ${count}/${goal} erledigt ‚Äì noch ${goal-count} offen`;
    }
  }
  function renderDashboard(){
    document.getElementById("totalPoints").textContent = totalPoints();
    document.getElementById("currentLevel").textContent = levelForPoints(totalPoints());
    document.getElementById("savingsTotal").textContent = euro(totalPoints()*state.settings.euro);
    document.getElementById("levelBar").innerHTML = renderLevelProgress();
    document.getElementById("achievements").innerHTML = renderAchievements();
    renderStats();
    renderTodaySuggestions();
    renderDailyGoal();
  }

  // ====== LOG ======
  function fillLogQuick(){
    const sel=document.getElementById("logQuick");
    const chips=document.getElementById("logChips");
    sel.innerHTML = `<option value="">‚Äì Schnellauswahl aus Katalog ‚Äì</option>` +
      state.catalog.map(q=>`<option value="${q.name}">${q.boss?'üëë ':''}${q.name} (+${q.points})${q.category?` ‚Ä¢ ${q.category}`:''}${q.negative?' ‚Ä¢ Negativ':''}</option>`).join("");
    sel.onchange=()=>{
      const name=sel.value; if(!name) return;
      const q=state.catalog.find(x=>x.name===name);
      document.getElementById("logQuest").value = q.name;
      document.getElementById("logPoints").value = q.points;
    };
    const stats={}; state.log.forEach(e=>{ stats[e.quest]=(stats[e.quest]||0)+1; });
    const top=Object.entries(stats).sort((a,b)=>b[1]-a[1]).slice(0,6).map(([n])=>n);
    chips.innerHTML = top.map(n=>`<button class="btn text-xs" data-chip="${n}">‚ûï ${n}</button>`).join("") ||
      `<div class="text-xs text-slate-500">Noch keine Schnellvorschl√§ge ‚Äì trage ein paar Quests ein.</div>`;
    chips.querySelectorAll("[data-chip]").forEach(b=> b.onclick=()=> quickAdd(b.getAttribute("data-chip")));
  }
  function renderLogList(){
    const list=document.getElementById("logList");
    list.innerHTML = state.log.map(e=>{
      const neg=e.points<0;
      return `<div class="p-2 rounded border ${neg?'bg-red-50 dark:bg-red-900/30':'card'}">
        ${e.date} ‚Ä¢ ${e.quest}${e.cat?` <span class="text-xs opacity-70">(${e.cat}${e.negative?' ¬∑ Negativ':''}${e.catPoints?` +${e.catPoints} KP`:''})</span>`:''}
        <span class="${neg?'text-red-600':''}"> ${e.points>=0?'+':''}${e.points}</span>
      </div>`;
    }).join("") || "<div class='text-sm text-slate-500'>Noch keine Eintr√§ge.</div>";
  }
  function addLog(){
    const d=document.getElementById("logDate").value || todayISO();
    const name=(document.getElementById("logQuest").value||"").trim();
    const manualPts=Number(document.getElementById("logPoints").value||0);
    const malus=Number(document.getElementById("logMalus").value||0);

    if(!name && !manualPts){ alert("Bitte Questname oder Punkte angeben."); return; }

    const quest = state.catalog.find(q=> q.name.toLowerCase()===name.toLowerCase());
    // Kategorie-Logik
    let cat = quest?.category || "";
    let isNeg = !!quest?.negative;
    let catPts = quest ? quest.points : 0;

    // Gesamtpunkte (negativ-Kategorie zieht ab, ohne Streak-Bonus)
    let base = manualPts>0 ? manualPts : (quest ? quest.points : 0);
    let totalPts;
    if(isNeg){
      const impact = Math.abs(quest?.negImpact || base || 0);
      totalPts = -(impact) + (malus||0);
    }else{
      totalPts = computePoints(base||0) + (malus||0);
    }

    const entry = {
      date:d,
      quest: name || "(ohne Name)",
      points: Math.round(totalPts),
      base: base||0,
      cat: cat||undefined,
      catPoints: cat? catPts : 0,
      negative: isNeg || undefined
    };
    state.log.push(entry);

    save(); renderAll();
    document.getElementById("logQuest").value="";
    document.getElementById("logPoints").value="";
    document.getElementById("logMalus").value="";
    document.getElementById("logQuick").value="";
  }
  function quickAdd(questName){
    const q = state.catalog.find(x=>x.name===questName);
    if(!q){
      // fallback: normaler positiver Eintrag
      const pts=computePoints(5);
      state.log.push({date:todayISO(), quest:questName, points:pts, base:5});
      save(); renderAll();
      return;
    }
    // Negativ ‚Üî Positiv
    let points;
    if(q.negative){
      points = -Math.abs(q.negImpact || q.points || 0);
    }else{
      points = computePoints(q.points||0);
    }
    state.log.push({
      date:todayISO(),
      quest:q.name,
      points:Math.round(points),
      base:q.points||0,
      cat:q.category||undefined,
      catPoints:q.category ? (q.points||0) : 0,
      negative: q.negative || undefined
    });
    save(); renderAll();
  }

  // ====== KATALOG ======
  function renderCatalog(){
    const list=document.getElementById("catalogList");
    list.innerHTML = state.catalog.map((q,i)=>`
      <div class="p-2 rounded border ${q.boss?'bg-yellow-50 dark:bg-yellow-900/30':'card'} flex items-center justify-between">
        <div>
          <div class="font-medium">${q.boss?'üëë ':''}${q.name} (+${q.points})</div>
          <div class="text-xs opacity-70">${q.category||'Ohne Kategorie'}${q.negative?' ‚Ä¢ Negativ':''}${q.negative && q.negImpact?` ‚Ä¢ Impact-${q.negImpact}`:''}</div>
        </div>
        <div class="flex gap-2">
          <button class="btn text-sm" data-quick="${i}">‚ûï</button>
          <button class="btn text-sm" data-edit="${i}">‚úé</button>
          <button class="btn text-sm text-red-600" data-del="${i}">L√∂schen</button>
        </div>
      </div>
    `).join("") || "<div class='text-sm text-slate-500'>Noch keine Eintr√§ge im Katalog.</div>";

    list.querySelectorAll("[data-quick]").forEach(b=>{
      b.onclick=()=> quickAdd(state.catalog[Number(b.getAttribute("data-quick"))].name);
    });
    list.querySelectorAll("[data-del]").forEach(b=>{
      b.onclick=()=>{
        const idx=Number(b.getAttribute("data-del"));
        state.catalog.splice(idx,1); save(); renderAll();
      };
    });
    list.querySelectorAll("[data-edit]").forEach(b=>{
      b.onclick=()=>{
        const idx=Number(b.getAttribute("data-edit"));
        const q=state.catalog[idx];
        const name=prompt("Name:", q.name); if(name===null) return;
        const pts=prompt("Punkte:", q.points); if(pts===null) return;
        const cat=prompt("Kategorie (leer f√ºr keine):", q.category||""); if(cat===null) return;
        const boss=confirm("Bossquest? (OK = Ja, Abbrechen = Nein)") ? true : false;
        const neg=confirm("Negativ-Kategorie? (OK = Ja, Abbrechen = Nein)") ? true : false;
        let negImp = q.negImpact||0;
        if(neg){
          const t = prompt("Negativ-Impact (Abzug von Gesamtpunkten, z. B. 30):", String(q.negImpact||0));
          if(t===null) return;
          negImp = Number(t)||0;
        }
        Object.assign(q,{
          name: (name||"").trim()||q.name,
          points: Number(pts)||q.points,
          category: (cat||"").trim(),
          boss: boss,
          negative: neg,
          negImpact: neg ? Math.abs(negImp) : 0
        });
        save(); renderAll();
      };
    });
  }
  function addQuest(){
    const name=(document.getElementById("qName").value||"").trim();
    const points=Number(document.getElementById("qPoints").value||0);
    const category=(document.getElementById("qCat").value||"").trim();
    const boss=document.getElementById("qBoss").checked;
    const negative=document.getElementById("qNegative").checked;
    const negImpact=Math.abs(Number(document.getElementById("qNegImpact").value||0));
    if(!name || !points){ alert("Bitte Name und Punkte angeben."); return; }
    state.catalog.push({name,points,boss,category,negative,negImpact});
    save(); renderAll();
    document.getElementById("qName").value="";
    document.getElementById("qPoints").value="";
    document.getElementById("qCat").value="";
    document.getElementById("qBoss").checked=false;
    document.getElementById("qNegative").checked=false;
    document.getElementById("qNegImpact").value="";
  }

  // ====== SONDERAUFGABEN ======
  const daysBetween=(a,b)=> Math.floor((new Date(b)-new Date(a))/(1000*60*60*24));
  function spIsAvailable(t){ if(!t.lastDone) return true; return daysBetween(t.lastDone,todayISO()) >= Number(t.everyDays||1); }
  function spNextDate(t){ if(!t.lastDone) return todayISO(); const d=new Date(t.lastDone); d.setDate(d.getDate()+Number(t.everyDays||1)); return d.toISOString().slice(0,10); }
  function renderSpecial(){
    const avail=document.getElementById("specialAvail");
    const lock=document.getElementById("specialLocked");
    const list=state.specialTasks.map((t,i)=>({...t,i}));
    const available=list.filter(spIsAvailable), locked=list.filter(t=>!spIsAvailable(t));

    avail.innerHTML = available.length ? available.map(t=>`
      <div class="p-2 rounded card flex items-center justify-between">
        <div>
          <div class="font-medium">‚≠ê ${t.name}</div>
          <div class="text-xs opacity-70">+${t.points} Punkte ‚Ä¢ alle ${t.everyDays} Tage</div>
        </div>
        <div class="flex gap-2">
          <button class="btn text-sm" data-sp-done="${t.i}">Erledigt</button>
          <button class="btn text-sm" data-sp-edit="${t.i}">‚úé</button>
          <button class="btn text-sm text-red-600" data-sp-del="${t.i}">L√∂schen</button>
        </div>
      </div>
    `).join("") : `<div class="text-sm text-slate-500">Zurzeit nichts verf√ºgbar.</div>`;

    lock.innerHTML = locked.length ? locked.map(t=>{
      const nd=spNextDate(t);
      const rest=Math.max(0, daysBetween(todayISO(), nd));
      return `<div class="p-2 rounded border bg-gray-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700 flex items-center justify-between">
        <div><div class="font-medium">‚õî ${t.name}</div>
        <div class="text-xs">wieder am ${nd}${rest>0?` (in ${rest} Tagen)`:''}</div></div>
        <div class="flex gap-2">
          <button class="btn text-sm" data-sp-edit="${t.i}">‚úé</button>
          <button class="btn text-sm text-red-600" data-sp-del="${t.i}">L√∂schen</button>
        </div>
      </div>`;
    }).join("") : `<div class="text-sm text-slate-500">Keine gesperrten Aufgaben.</div>`;

    document.querySelectorAll("[data-sp-done]").forEach(b=>{
      b.onclick=()=>{
        const i=Number(b.getAttribute("data-sp-done"));
        const t=state.specialTasks[i]; if(!t) return;
        const pts=computePoints(Number(t.points||0));
        state.log.push({date:todayISO(), quest:`Sonder: ${t.name}`, points:pts, base:Number(t.points||0)});
        t.lastDone=todayISO(); save(); renderAll();
      };
    });
    document.querySelectorAll("[data-sp-del]").forEach(b=>{
      b.onclick=()=>{ const i=Number(b.getAttribute("data-sp-del")); if(confirm("L√∂schen?")){ state.specialTasks.splice(i,1); save(); renderAll(); } };
    });
    document.querySelectorAll("[data-sp-edit]").forEach(b=>{
      b.onclick=()=>{
        const i=Number(b.getAttribute("data-sp-edit"));
        const t=state.specialTasks[i]; if(!t) return;
        const name=prompt("Name:", t.name); if(name===null) return;
        const pts=prompt("Punkte:", t.points); if(pts===null) return;
        const days=prompt("Alle wie viele Tage?", t.everyDays); if(days===null) return;
        Object.assign(t,{ name:(name||"").trim()||t.name, points:Number(pts)||t.points, everyDays:Math.max(1,Number(days)||t.everyDays) });
        save(); renderAll();
      };
    });
  }
  function bindSpecialForm(){
    const btn=document.getElementById("btnAddSpecial");
    if(btn && !btn._bound){
      btn._bound=true;
      btn.onclick=()=>{
        const name=(document.getElementById("spName").value||"").trim();
        const pts=Number(document.getElementById("spPoints").value||0);
        const days=Math.max(1, Number(document.getElementById("spDays").value||0));
        if(!name || !pts || !days){ alert("Bitte Name, Punkte und Tage ausf√ºllen."); return; }
        state.specialTasks.push({name:name, points:pts, everyDays:days, lastDone:null});
        save(); renderAll();
        document.getElementById("spName").value="";
        document.getElementById("spPoints").value="";
        document.getElementById("spDays").value="";
      };
    }
  }

  // ====== KATEGORIEN ======
  function ensureCategory(name, type="pos"){
    if(!name) return;
    if(!state.categories.some(c=>c.name.toLowerCase()===name.toLowerCase())){
      state.categories.push({name, type});
    }
  }
  function categoryTotals(){
    // Summen anhand Log + Link-Effekte
    const totals = {}; // {catName: sum}
    const add=(cat, val)=>{ if(!cat) return; totals[cat]=(totals[cat]||0)+(val||0); };
    // direkte Kategorie-Punkte
    state.log.forEach(e=>{
      if(e.cat && e.catPoints) add(e.cat, e.catPoints);
    });
    // Link-Effekte
    state.categoryLinks.forEach(link=>{
      const from=link.from, to=link.to, bonus=Number(link.bonus||0)/100;
      if(!from||!to||!bonus) return;
      // Summe aller catPoints in 'from'
      const fromSum = state.log.filter(e=>e.cat===from).reduce((s,e)=>s+(e.catPoints||0),0);
      add(to, Math.round(fromSum*bonus));
    });
    return totals;
  }
  function renderCategories(){
    // Totals
    const totals = categoryTotals();
    const list=document.getElementById("categoryTotals");
    const cats = [...new Set([
      ...state.categories.map(c=>c.name),
      ...state.catalog.map(q=>q.category).filter(Boolean),
      ...Object.keys(totals)
    ])].filter(Boolean).sort((a,b)=>a.localeCompare(b));
    list.innerHTML = cats.map(name=>{
      const type = (state.categories.find(c=>c.name===name)?.type)||'pos';
      const sum = totals[name]||0;
      return `<div class="p-2 rounded card flex justify-between">
        <span>${type==='neg'?'üö´':'üè∑Ô∏è'} ${name}</span>
        <span class="font-bold">${sum} KP</span>
      </div>`;
    }).join("") || "<div class='text-sm text-slate-500'>Noch keine Kategorien.</div>";

    // Links
    const ll=document.getElementById("linkList");
    ll.innerHTML = state.categoryLinks.length
      ? state.categoryLinks.map((l,i)=>`<div class="flex justify-between items-center">
          <span>üîó ${l.from} ‚Üí ${l.to} (+${l.bonus}% nur f√ºr Kategorien)</span>
          <button class="btn text-sm" data-link-del="${i}">L√∂schen</button>
        </div>`).join("")
      : `<div class="text-sm text-slate-500">Keine Verkn√ºpfungen angelegt.</div>`;
    ll.querySelectorAll("[data-link-del]").forEach(b=>{
      b.onclick=()=>{ state.categoryLinks.splice(Number(b.getAttribute("data-link-del")),1); save(); renderCategories(); };
    });
  }
  function bindCategoriesForm(){
    const addCat=document.getElementById("btnAddCat");
    addCat.onclick=()=>{
      const name=(document.getElementById("catName").value||"").trim();
      const type=document.getElementById("catType").value||"pos";
      if(!name) return;
      ensureCategory(name,type);
      save(); renderCategories();
      document.getElementById("catName").value="";
    };
    const addLink=document.getElementById("btnAddLink");
    addLink.onclick=()=>{
      const from=(document.getElementById("linkFrom").value||"").trim();
      const to=(document.getElementById("linkTo").value||"").trim();
      const bonus=Number(document.getElementById("linkBonus").value||0);
      if(!from||!to||!bonus){ alert("Bitte von/zu/Bonus ausf√ºllen."); return; }
      state.categoryLinks.push({from,to,bonus:Math.max(1,Math.round(bonus))});
      save(); renderCategories();
      document.getElementById("linkFrom").value="";
      document.getElementById("linkTo").value="";
      document.getElementById("linkBonus").value="";
    };
  }

  // ====== MEILENSTEINE (nur n√§chster) ======
  const MS = {
    quests:  [ {count:100,reward:100},{count:200,reward:400},{count:500,reward:2500},{count:1000,reward:10000} ],
    boss:    [ {count:10,reward:100},{count:20,reward:200},{count:50,reward:2500},{count:100,reward:10000} ],
    missions:[ {count:5,reward:50},{count:10,reward:100},{count:20,reward:400},{count:50,reward:2500} ] // Missionen-Placeholder
  };
  const msKey=(group,count)=>`${group}-${count}`;

  function countQuestsDone(){ return state.log.filter(e=>typeof e.points==='number').length; }
  function countBossDone(){
    const bossNames=new Set(state.catalog.filter(q=>q.boss).map(q=>q.name));
    return state.log.filter(e=> bossNames.has(e.quest)).length;
  }
  function countMissionsDone(){ return 0; } // sp√§ter

  function nextMilestone(group, done){
    const conf=MS[group]; if(!conf) return null;
    for(const m of conf){
      const key=msKey(group,m.count);
      // Wenn noch nicht eingel√∂st ‚Üí dieser Meilenstein ist der ‚Äûaktive‚Äú
      if(!state.milestonesClaimed.includes(key)) return {key, ...m, reached: done>=m.count};
    }
    return null;
  }

  function renderMilestones(){
    const qDone=countQuestsDone();
    const bDone=countBossDone();
    const mDone=countMissionsDone();
    const groups=[
      {id:'quests',title:'üìö Quests gesamt', done:qDone},
      {id:'boss',title:'üëë Bossquests', done:bDone},
      {id:'missions',title:'üß≠ Missionen (bald)', done:mDone}
    ];
    const box=document.getElementById("milestoneBoxes");
    box.innerHTML = groups.map(g=>{
      const nxt=nextMilestone(g.id, g.done);
      if(!nxt) return `<div class="p-2 rounded card">${g.title}: Alle Meilensteine eingel√∂st ‚úÖ</div>`;
      return `<div class="p-2 rounded card flex items-center justify-between">
        <div>
          <div class="font-bold">${g.title}</div>
          <div class="text-sm">Ziel: ${nxt.count} ‚Ä¢ Belohnung: +${nxt.reward} Punkte</div>
          <div class="text-xs opacity-70">Fortschritt: ${g.done}/${nxt.count}</div>
        </div>
        <div>
          ${nxt.reached
            ? `<button class="btn bg-green-600 text-white" data-claim="${g.id}|${nxt.count}|${nxt.reward}">Einl√∂sen</button>`
            : `<span class="text-slate-500">Noch nicht erreicht</span>`}
        </div>
      </div>`;
    }).join("");

    box.querySelectorAll("[data-claim]").forEach(b=>{
      b.onclick=()=>{
        const [id,count,reward]=b.getAttribute("data-claim").split("|");
        const key=msKey(id,Number(count));
        if(state.milestonesClaimed.includes(key)) return;
        state.milestonesClaimed.push(key);
        state.log.push({date:todayISO(), quest:`Milestone: ${id} ${count}`, points:Number(reward)});
        save(); renderAll();
        alert(`üéØ Meilenstein eingel√∂st: ${id} ${count} (+${reward} Punkte)`);
      };
    });
  }

  // ====== SETTINGS ======
  function renderSettings(){
    const s=state.settings;
    s.euro ??= 0.1; s.base ??= 100; s.growth ??= 0.1; s.dailyGoal ??= 3; s.theme ??= "light";
    document.getElementById("sEuro").value=s.euro;
    document.getElementById("sBase").value=s.base;
    document.getElementById("sGrowth").value=s.growth;
    document.getElementById("sDailyGoal").value=s.dailyGoal;
    document.getElementById("sTheme").value=s.theme;

    document.getElementById("sEuro").onchange=e=>{ s.euro=Number(e.target.value||0); save(); renderAll(); };
    document.getElementById("sBase").onchange=e=>{ s.base=Number(e.target.value||100); save(); renderAll(); };
    document.getElementById("sGrowth").onchange=e=>{ s.growth=Number(e.target.value||0.1); save(); renderAll(); };
    document.getElementById("sDailyGoal").onchange=e=>{ s.dailyGoal=Number(e.target.value||1); save(); renderAll(); };
    document.getElementById("sTheme").onchange=e=>{ s.theme=e.target.value; save(); applyTheme(); };

    document.getElementById("btnExport").onclick=()=>{
      const blob=new Blob([JSON.stringify(state,null,2)],{type:"application/json"});
      const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="life_rpg_backup.json"; a.click();
    };
    document.getElementById("btnImport").onclick=()=> document.getElementById("fileImport").click();
    document.getElementById("fileImport").onchange=(e)=>{
      const f=e.target.files[0]; if(!f) return;
      const r=new FileReader();
      r.onload=()=>{ try{ state=migrate(JSON.parse(r.result)); save(); renderAll(); alert("Import erfolgreich."); }catch{ alert("Fehler beim Import."); } };
      r.readAsText(f);
    };
    document.getElementById("btnReset").onclick=()=>{
      if(confirm("Alles wirklich l√∂schen?")){ state=structuredClone(defaultState); save(); renderAll(); }
    };
  }

  // ====== CHAT (leicht) ======
  function chatAdd(msg, from="bot"){
    const log=document.getElementById("chatLog");
    const row=document.createElement("div");
    row.className=from==="user"?"text-right":"text-left text-blue-700";
    row.textContent=msg; log.appendChild(row); log.scrollTop=log.scrollHeight;
  }
  function processMessage(msg){
    const t=(msg||"").trim().toLowerCase();
    if((t.includes("was")&&t.includes("machen"))||t.includes("vorschlag")){
      const today=todayISO();
      const done=new Set(state.log.filter(e=>e.date===today).map(e=>e.quest));
      const open=state.catalog.filter(q=>!done.has(q.name)).slice(0,5);
      if(open.length===0) return ["üéâ Alles erledigt!"];
      open.forEach(q=> chatAdd(`‚ûï ${q.name} (+${q.points})`,"bot"));
      return ["üëâ Vorschl√§ge oben als Liste."];
    }
    if(t.includes("r√ºckg√§ngig")||t.includes("letzte quest")){
      if(state.log.length===0) return ["Kein Eintrag vorhanden."]; const last=state.log.pop(); save(); renderAll();
      return [`üóëÔ∏è Letzte Quest gel√∂scht: ${last.quest} (${last.points})`];
    }
    if(t.startsWith("zeige ")){
      const q=t.replace("zeige ","").trim();
      const res=state.log.filter(e=> (e.quest||"").toLowerCase().includes(q));
      if(res.length===0) return ["‚ùå Nichts gefunden."];
      return ["üîç Ergebnisse:", ...res.slice(-10).map(e=>`${e.date} ‚Ä¢ ${e.quest} (${e.points})`)];
    }
    const found=state.catalog.find(q=> t.includes(q.name.toLowerCase()));
    if(found){ quickAdd(found.name); return [`‚úÖ Eingetragen: ${found.name}`]; }
    if(msg.trim()){
      // neue normale Quest +5
      state.catalog.push({name:msg.trim(), points:5, boss:false, category:"", negative:false, negImpact:0});
      quickAdd(msg.trim());
      return [`‚ûï Neue Quest angelegt & eingetragen: ${msg.trim()} (+5)`.trim()];
    }
    return ["Ich habe dich nicht verstanden üòÖ"];
  }
  function bindChat(){
    const input=document.getElementById("chatInput");
    document.getElementById("btnChatSend").onclick=()=>{
      const txt=(input.value||"").trim(); if(!txt) return;
      chatAdd(txt,"user"); const res=processMessage(txt); (res||[]).forEach(r=>chatAdd(r,"bot")); input.value="";
    };
  }

  // ====== RENDER ALL ======
  function renderAll(){
    applyTheme();
    // KPIs
    renderDashboard();
    // Log
    document.getElementById("logDate").value=todayISO();
    fillLogQuick(); renderLogList();
    // Catalog
    renderCatalog();
    // Special
    renderSpecial(); bindSpecialForm();
    // Categories
    renderCategories(); bindCategoriesForm();
    // Settings
    renderSettings();
    // Milestones
    renderMilestones();
  }

  // ====== INIT ======
  (function init(){
    bindMenu();
    document.getElementById("btnAddEntry").onclick=addLog;
    document.getElementById("btnAddQuest").onclick=addQuest;
    bindChat();
    renderAll();
    window.addEventListener("resize", ()=>{ if(document.getElementById("tab-dashboard").classList.contains("active")) renderStats(); });
  })();
  </script>
</body>
</html>