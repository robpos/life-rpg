<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Life RPG — v2 Baseline</title>

  <!-- Tailwind (CDN) für schnelle, saubere UI -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* ---------- Design Tokens / Theme ---------- */
    html { color-scheme: light dark; }
    :root {
      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
    }
    body {
      --bg: #f8fafc;      /* hell */
      --fg: #111111;
      --card: #ffffff;
      --muted: #334155;
      --border: #e2e8f0;
      background: var(--bg);
      color: var(--fg);
      min-height: 100svh;
    }
    .dark body {
      --bg: #0b1220;      /* dunkel */
      --fg: #ffffff;
      --card: #0f172a;
      --muted: #cbd5e1;
      --border: #1f2a44;
      background: var(--bg);
      color: var(--fg);
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: .75rem;
    }

    /* ---------- Layout: Header & Views ---------- */
    header.app {
      position: sticky;
      top: 0;
      z-index: 20;
      background: var(--card);
      border-bottom: 1px solid var(--border);
      padding-top: calc(0.5rem + var(--safe-top)); /* Safe-area friendly */
    }
    .app-title {
      font-weight: 800;
      letter-spacing: .2px;
    }

    main.app {
      padding-bottom: calc(1rem + var(--safe-bottom));
    }

    .view { display: none; }
    .view.active { display: block; }

    /* Buttons & Inputs (hell/dunkel gut lesbar) */
    .btn {
      border-radius: .75rem;
      border: 1px solid var(--border);
      padding: .6rem .9rem;
      background: var(--card);
      color: var(--fg);
    }
    .btn-primary {
      background: #2563eb;
      color: #fff;
      border-color: #2563eb;
    }
    .btn-danger {
      background: #dc2626;
      color: #fff;
      border-color: #dc2626;
    }
    .input, select {
      width: 100%;
      border-radius: .75rem;
      border: 1px solid var(--border);
      padding: .55rem .8rem;
      background: var(--card);
      color: var(--fg);
    }

    /* Listenzeilen */
    .row { background: var(--card); border:1px solid var(--border); border-radius:.75rem; padding:.6rem .8rem; }

    /* Utility */
    .mono { font-feature-settings: "tnum"; font-variant-numeric: tabular-nums; }
  </style>
</head>
<body class="antialiased">

  <!-- ===== Header ===== -->
  <header class="app">
    <div class="max-w-2xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
      <button id="btnBack" class="btn px-3 py-2 hidden">
        ← Zurück
      </button>

      <h1 id="headerTitle" class="app-title text-xl text-center flex-1">
        Life RPG
      </h1>

      <button id="btnTheme" class="btn px-3 py-2" title="Hell/Dunkel umschalten">
        🌗
      </button>
    </div>
  </header>

  <!-- ===== Inhalt ===== -->
  <main class="app">
    <div class="max-w-2xl mx-auto px-4 space-y-6">

      <!-- ===== Hauptmenü ===== -->
      <section id="view-menu" class="view active">
        <!-- === MAINMENU === -->
        <div class="space-y-4">
          <div class="card p-4">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-sm text-slate-500 dark:text-slate-300">Willkommen</div>
                <div class="text-lg font-semibold">Was möchtest du tun?</div>
              </div>
              <div class="text-right">
                <div class="text-sm text-slate-500 dark:text-slate-300">Level</div>
                <div id="mmLevel" class="mono text-lg font-bold">—</div>
              </div>
            </div>
            <div class="mt-2 grid grid-cols-3 gap-3 text-center">
              <div class="row">
                <div class="text-xs text-slate-500 dark:text-slate-300">Punkte</div>
                <div id="mmPoints" class="mono text-lg font-bold">—</div>
              </div>
              <div class="row">
                <div class="text-xs text-slate-500 dark:text-slate-300">Sparstand</div>
                <div class="mono text-lg font-bold">€<span id="mmSavings">—</span></div>
              </div>
              <div class="row">
                <div class="text-xs text-slate-500 dark:text-slate-300">Einträge</div>
                <div id="mmEntries" class="mono text-lg font-bold">—</div>
              </div>
            </div>
          </div>

          <!-- Navigationsliste -->
          <div class="space-y-3">
            <button class="btn w-full flex items-center justify-between" data-go="dashboard">
              <span>📊 Dashboard</span>
              <span class="text-slate-500 dark:text-slate-300">Übersicht</span>
            </button>
            <button class="btn w-full flex items-center justify-between" data-go="log">
              <span>📝 Log</span>
              <span class="text-slate-500 dark:text-slate-300">Eintragen & Verlauf</span>
            </button>
            <button class="btn w-full flex items-center justify-between" data-go="catalog">
              <span>📚 Katalog</span>
              <span class="text-slate-500 dark:text-slate-300">Vorlagen</span>
            </button>
            <button class="btn w-full flex items-center justify-between" data-go="categories">
              <span>🗂️ Kategorien</span>
              <span class="text-slate-500 dark:text-slate-300">(inkl. negativ)</span>
            </button>
            <button class="btn w-full flex items-center justify-between" data-go="missions">
              <span>🧭 Missionen</span>
              <span class="text-slate-500 dark:text-slate-300">Schrittfolgen</span>
            </button>
            <button class="btn w-full flex items-center justify-between" data-go="milestones">
              <span>🏅 Meilensteine</span>
              <span class="text-slate-500 dark:text-slate-300">automatisch</span>
            </button>
            <button class="btn w-full flex items-center justify-between" data-go="settings">
              <span>⚙️ Einstellungen</span>
              <span class="text-slate-500 dark:text-slate-300">Export/Import</span>
            </button>
          </div>
        </div>
      </section>

      <!-- ===== Dashboard (leicht) ===== -->
      <section id="view-dashboard" class="view">
        <div class="space-y-4">
          <div class="grid md:grid-cols-3 gap-3">
            <div class="row">
              <div class="text-xs text-slate-500 dark:text-slate-300">Punkte</div>
              <div id="dbPoints" class="mono text-2xl font-extrabold">0</div>
            </div>
            <div class="row">
              <div class="text-xs text-slate-500 dark:text-slate-300">Level</div>
              <div id="dbLevel" class="mono text-2xl font-extrabold">1</div>
            </div>
            <div class="row">
              <div class="text-xs text-slate-500 dark:text-slate-300">Sparstand</div>
              <div class="mono text-2xl font-extrabold">€<span id="dbSavings">0.00</span></div>
            </div>
          </div>

          <div class="card p-4">
            <div class="font-semibold mb-2">Heute</div>
            <div id="dbToday" class="text-sm text-slate-600 dark:text-slate-300">Noch keine Einträge.</div>
          </div>
        </div>
      </section>

      <!-- ===== Log (minimal funktionsfähig) ===== -->
      <section id="view-log" class="view">
        <div class="space-y-4">
          <div class="card p-4 space-y-2">
            <div class="grid md:grid-cols-4 gap-2">
              <input id="logDate" type="date" class="input" />
              <input id="logQuest" class="input md:col-span-2" placeholder="Questname" />
              <input id="logPoints" type="number" class="input" placeholder="Punkte" />
            </div>
            <div class="flex gap-2">
              <button id="btnAddLog" class="btn btn-primary">Eintragen</button>
              <button id="btnUndo" class="btn">Rückgängig</button>
            </div>
          </div>

          <div class="card p-4">
            <div class="font-semibold mb-2">Verlauf</div>
            <div id="logList" class="space-y-2 text-sm"></div>
          </div>
        </div>
      </section>

      <!-- ===== Katalog (Stub) ===== -->
      <section id="view-catalog" class="view">
        <div class="space-y-4">
          <div class="card p-4 space-y-2">
            <div class="grid md:grid-cols-3 gap-2">
              <input id="catName" class="input md:col-span-2" placeholder="Neue Questvorlage (z. B. Sport)" />
              <input id="catPts" type="number" class="input" placeholder="Punkte" />
            </div>
            <button id="btnAddTemplate" class="btn btn-primary">Zur Liste hinzufügen</button>
          </div>

          <div class="card p-4">
            <div class="font-semibold mb-2">Vorlagen</div>
            <div id="catalogList" class="space-y-2"></div>
          </div>
        </div>
      </section>

      <!-- ===== Kategorien (Stub) ===== -->
      <section id="view-categories" class="view">
        <div class="space-y-4">
          <div class="card p-4">
            <div class="font-semibold mb-2">Kategorien (inkl. negativ)</div>
            <div id="catOverview" class="text-sm text-slate-600 dark:text-slate-300">
              Wird in Phase 3 ausgebaut. (Baseline zeigt nur Platzhalter)
            </div>
          </div>
        </div>
      </section>

      <!-- ===== Missionen (Stub) ===== -->
      <section id="view-missions" class="view">
        <div class="space-y-4">
          <div class="card p-4">
            <div class="font-semibold mb-2">Missionen</div>
            <div class="text-sm text-slate-600 dark:text-slate-300">
              Editor & Abhängigkeiten folgen in Phase 5.
            </div>
          </div>
        </div>
      </section>

      <!-- ===== Meilensteine (Stub) ===== -->
      <section id="view-milestones" class="view">
        <div class="space-y-4">
          <div class="card p-4">
            <div class="font-semibold mb-2">Meilensteine</div>
            <div class="text-sm text-slate-600 dark:text-slate-300">
              Automatische Generierung folgt in Phase 6.
            </div>
          </div>
        </div>
      </section>

      <!-- ===== Einstellungen ===== -->
      <section id="view-settings" class="view">
        <div class="space-y-4">
          <div class="card p-4 space-y-2">
            <div class="grid md:grid-cols-3 gap-2">
              <label class="text-sm">
                € pro Punkt
                <input id="setEuro" type="number" step="0.01" class="input" />
              </label>
              <label class="text-sm">
                Level-Basis
                <input id="setBase" type="number" class="input" />
              </label>
              <label class="text-sm">
                Wachstum
                <input id="setGrowth" type="number" step="0.01" class="input" />
              </label>
            </div>
          </div>

          <div class="card p-4 space-y-2">
            <div class="font-semibold">Daten</div>
            <div class="flex flex-wrap gap-2">
              <button id="btnExport" class="btn">Export</button>
              <input id="fileImport" type="file" accept="application/json" class="hidden" />
              <button id="btnImport" class="btn">Import</button>
              <button id="btnWipe" class="btn btn-danger">Alles löschen</button>
            </div>
            <div id="migInfo" class="text-xs text-slate-500 dark:text-slate-300 mt-1">
              Migration aus v1 erfolgt automatisch, falls vorhanden.
            </div>
          </div>
        </div>
      </section>

    </div>
  </main>

  <!-- ===== App Script ===== -->
  <script>
  ;(() => {
    // ---------- Storage Keys & Version ----------
    const KEY_V2 = "lifeRPG_v2";
    const KEY_V1 = "lifeRPG_p1";
    const SCHEMA_VERSION = 2;

    // ---------- Default State ----------
    const defaultState = {
      version: SCHEMA_VERSION,
      createdAt: new Date().toISOString(),
      settings: { euro: 0.10, base: 100, growth: 0.10, dark: false },
      log: [],                  // [{date, quest, points, base?}]
      catalog: [],              // [{name, points}]
      categories: [],           // Phase 3
      missions: [],             // Phase 5
      milestones: []            // Phase 6
    };

    // ---------- Load / Save ----------
    function loadV2() {
      try {
        const raw = localStorage.getItem(KEY_V2);
        if (!raw) return null;
        return JSON.parse(raw);
      } catch { return null; }
    }
    function saveV2() {
      localStorage.setItem(KEY_V2, JSON.stringify(state));
    }

    // ---------- Migration v1 -> v2 (sanft, einmalig) ----------
    function migrateFromV1() {
      try {
        const raw = localStorage.getItem(KEY_V1);
        if (!raw) return null;
        const v1 = JSON.parse(raw);
        const s = structuredClone(defaultState);

        // Übernehmen, wo vorhanden
        if (Array.isArray(v1.log)) s.log = v1.log;
        if (Array.isArray(v1.catalog)) s.catalog = v1.catalog;
        if (v1.settings) {
          s.settings.euro   = Number(v1.settings.euro ?? s.settings.euro);
          s.settings.base   = Number(v1.settings.base ?? s.settings.base);
          s.settings.growth = Number(v1.settings.growth ?? s.settings.growth);
        }
        s.version = SCHEMA_VERSION;
        return s;
      } catch {
        return null;
      }
    }

    // ---------- Ensure Schema / Defaults ----------
    function ensureSchema(obj) {
      const s = Object.assign({}, defaultState, obj || {});
      s.version = SCHEMA_VERSION;
      s.settings = Object.assign({}, defaultState.settings, s.settings || {});
      s.log = Array.isArray(s.log) ? s.log : [];
      s.catalog = Array.isArray(s.catalog) ? s.catalog : [];
      s.categories = Array.isArray(s.categories) ? s.categories : [];
      s.missions = Array.isArray(s.missions) ? s.missions : [];
      s.milestones = Array.isArray(s.milestones) ? s.milestones : [];
      return s;
    }

    // ---------- Init State ----------
    let state = loadV2();
    if (!state) {
      const migrated = migrateFromV1();
      state = ensureSchema(migrated || defaultState);
      saveV2();
    } else {
      state = ensureSchema(state);
      saveV2();
    }

    // ---------- Theme ----------
    function applyTheme() {
      const html = document.documentElement;
      if (state.settings.dark) html.classList.add("dark");
      else html.classList.remove("dark");
    }
    applyTheme();

    // ---------- Helpers ----------
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const todayISO = () => new Date().toISOString().slice(0,10);

    function totalPoints() { return state.log.reduce((s,e) => s + (Number(e.points)||0), 0); }
    function totalSavings() { return totalPoints() * Number(state.settings.euro || 0); }

    function levelForPoints(p) {
      let lvl=1, need=Number(state.settings.base||100), growth=Number(state.settings.growth||0.1);
      let pts=p;
      while (pts >= need) { lvl++; pts -= need; need = Math.round(need * (1 + growth)); }
      return Math.max(1,lvl);
    }

    // ---------- Router ----------
    let viewStack = ["menu"];
    const headerTitle = $("#headerTitle");
    const btnBack = $("#btnBack");

    function showView(id, push=true) {
      $$(".view").forEach(v => v.classList.remove("active"));
      $("#view-" + id).classList.add("active");

      // Header
      const titleMap = {
        menu: "Life RPG",
        dashboard: "Dashboard",
        log: "Log",
        catalog: "Katalog",
        categories: "Kategorien",
        missions: "Missionen",
        milestones: "Meilensteine",
        settings: "Einstellungen"
      };
      headerTitle.textContent = titleMap[id] || "Life RPG";

      // Back sichtbar außer im Menü
      if (id === "menu") {
        btnBack.classList.add("hidden");
      } else {
        btnBack.classList.remove("hidden");
      }

      if (push) {
        // gleiche Seite nicht doppelt stapeln
        if (viewStack[viewStack.length-1] !== id) viewStack.push(id);
      }
      renderAll();
    }

    btnBack.addEventListener("click", () => {
      // mindestens zum Menü
      if (viewStack.length <= 1) {
        viewStack = ["menu"];
        showView("menu", false);
      } else {
        viewStack.pop(); // aktuelle weg
        const prev = viewStack[viewStack.length-1] || "menu";
        showView(prev, false);
      }
    });

    // Menü-Buttons
    $$("#view-menu [data-go]").forEach(btn => {
      btn.addEventListener("click", () => showView(btn.dataset.go));
    });

    // Theme toggle
    $("#btnTheme").addEventListener("click", () => {
      state.settings.dark = !state.settings.dark;
      saveV2();
      applyTheme();
      renderAll();
    });

    // ---------- Views: Render ----------
    function renderMenu() {
      $("#mmLevel").textContent = levelForPoints(totalPoints());
      $("#mmPoints").textContent = totalPoints();
      $("#mmSavings").textContent = totalSavings().toFixed(2);
      $("#mmEntries").textContent = state.log.length;
    }

    function renderDashboard() {
      $("#dbPoints").textContent = totalPoints();
      $("#dbLevel").textContent = levelForPoints(totalPoints());
      $("#dbSavings").textContent = totalSavings().toFixed(2);

      const t = todayISO();
      const todayList = state.log.filter(e => e.date === t);
      $("#dbToday").textContent = todayList.length
        ? todayList.map(e => `${e.quest} (+${e.points})`).join(" · ")
        : "Noch keine Einträge.";
    }

    function renderLog() {
      $("#logDate").value = todayISO();

      const list = $("#logList");
      if (!list) return;
      if (state.log.length === 0) {
        list.innerHTML = `<div class="text-slate-500 dark:text-slate-300">Noch nichts eingetragen.</div>`;
        return;
      }
      list.innerHTML = state.log.slice().reverse().map(e =>
        `<div class="row flex items-center justify-between">
          <div>${e.date} • ${e.quest}</div>
          <div class="mono font-semibold">+${e.points}</div>
        </div>`
      ).join("");
    }

    function renderCatalog() {
      const wrap = $("#catalogList");
      if (!wrap) return;
      if (state.catalog.length === 0) {
        wrap.innerHTML = `<div class="text-slate-500 dark:text-slate-300">Noch keine Vorlagen.</div>`;
        return;
      }
      wrap.innerHTML = state.catalog.map((q,i) =>
        `<div class="row flex items-center justify-between">
          <div>📌 ${q.name} <span class="text-slate-500 dark:text-slate-300">(+${q.points})</span></div>
          <button class="btn text-xs" data-use="${i}">Eintragen</button>
        </div>`
      ).join("");

      // Schnell eintragen aus Vorlage
      wrap.querySelectorAll("[data-use]").forEach(btn => {
        btn.addEventListener("click", () => {
          const q = state.catalog[Number(btn.dataset.use)];
          const d = todayISO();
          state.log.push({date:d, quest:q.name, points:Number(q.points)||0, base:q.points});
          saveV2();
          renderAll();
          showView("log"); // direkt ins Log
        });
      });
    }

    function renderSettings() {
      $("#setEuro").value = state.settings.euro;
      $("#setBase").value = state.settings.base;
      $("#setGrowth").value = state.settings.growth;
    }

    function renderAll() {
      if ($("#view-menu").classList.contains("active")) renderMenu();
      if ($("#view-dashboard").classList.contains("active")) renderDashboard();
      if ($("#view-log").classList.contains("active")) renderLog();
      if ($("#view-catalog").classList.contains("active")) renderCatalog();
      if ($("#view-settings").classList.contains("active")) renderSettings();
    }

    // ---------- Events: Log ----------
    $("#btnAddLog").addEventListener("click", () => {
      const d = $("#logDate").value || todayISO();
      const q = ($("#logQuest").value || "").trim();
      const p = Number($("#logPoints").value || 0);
      if (!q) { alert("Bitte Questname eingeben."); return; }
      state.log.push({date:d, quest:q, points:p});
      saveV2();
      $("#logQuest").value = "";
      $("#logPoints").value = "";
      renderAll();
    });

    $("#btnUndo").addEventListener("click", () => {
      if (!state.log.length) return;
      state.log.pop();
      saveV2();
      renderAll();
    });

    // ---------- Events: Catalog ----------
    $("#btnAddTemplate").addEventListener("click", () => {
      const name = ($("#catName").value || "").trim();
      const pts  = Number($("#catPts").value || 0);
      if (!name || !pts) { alert("Name & Punkte angeben."); return; }
      state.catalog.push({name, points:pts});
      saveV2();
      $("#catName").value = "";
      $("#catPts").value = "";
      renderAll();
    });

    // ---------- Events: Settings ----------
    $("#setEuro").addEventListener("change", e => {
      state.settings.euro = Number(e.target.value || 0);
      saveV2(); renderAll();
    });
    $("#setBase").addEventListener("change", e => {
      state.settings.base = Number(e.target.value || 100);
      saveV2(); renderAll();
    });
    $("#setGrowth").addEventListener("change", e => {
      state.settings.growth = Number(e.target.value || 0.1);
      saveV2(); renderAll();
    });

    $("#btnExport").addEventListener("click", () => {
      const blob = new Blob([JSON.stringify(state,null,2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "life_rpg_backup_v2.json";
      a.click();
    });

    $("#btnImport").addEventListener("click", () => $("#fileImport").click());
    $("#fileImport").addEventListener("change", e => {
      const f = e.target.files[0];
      if (!f) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const incoming = JSON.parse(reader.result);
          // sanfte Zusammenführung: nur bekannte Felder
          state = ensureSchema(incoming);
          saveV2();
          renderAll();
          alert("Import erfolgreich.");
        } catch {
          alert("Fehler beim Import.");
        }
      };
      reader.readAsText(f);
    });

    $("#btnWipe").addEventListener("click", () => {
      if (!confirm("Wirklich ALLES löschen? (v2)")) return;
      state = ensureSchema(defaultState);
      saveV2();
      renderAll();
      showView("menu", false);
    });

    // ---------- Initial ----------
    // Start im Menü
    showView("menu", false);
    $("#logDate").value = todayISO();

    // Exponiere für Debug (optional)
    window._lifeRPG = { get state(){return state;}, save: saveV2, showView };

    /* === PATCHES ANCHOR — DO NOT REMOVE === */
  })();
  </script>

</body>
</html>