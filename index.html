<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Life RPG — v2 Baseline</title>

  <!-- Tailwind (CDN) für schnelle, saubere UI -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* ---------- Design Tokens / Theme ---------- */
    html { color-scheme: light dark; }
    :root {
      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
    }
    body {
      --bg: #f8fafc;      /* hell */
      --fg: #111111;
      --card: #ffffff;
      --muted: #334155;
      --border: #e2e8f0;
      background: var(--bg);
      color: var(--fg);
      min-height: 100svh;
    }
    .dark body {
      --bg: #0b1220;      /* dunkel */
      --fg: #ffffff;
      --card: #0f172a;
      --muted: #cbd5e1;
      --border: #1f2a44;
      background: var(--bg);
      color: var(--fg);
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: .75rem;
    }

    /* ---------- Layout: Header & Views ---------- */
    header.app {
      position: sticky;
      top: 0;
      z-index: 20;
      background: var(--card);
      border-bottom: 1px solid var(--border);
      padding-top: calc(0.5rem + var(--safe-top)); /* Safe-area friendly */
    }
    .app-title {
      font-weight: 800;
      letter-spacing: .2px;
    }

    main.app {
      padding-bottom: calc(1rem + var(--safe-bottom));
    }

    .view { display: none; }
    .view.active { display: block; }

    /* Buttons & Inputs (hell/dunkel gut lesbar) */
    .btn {
      border-radius: .75rem;
      border: 1px solid var(--border);
      padding: .6rem .9rem;
      background: var(--card);
      color: var(--fg);
    }
    .btn-primary {
      background: #2563eb;
      color: #fff;
      border-color: #2563eb;
    }
    .btn-danger {
      background: #dc2626;
      color: #fff;
      border-color: #dc2626;
    }
    .input, select {
      width: 100%;
      border-radius: .75rem;
      border: 1px solid var(--border);
      padding: .55rem .8rem;
      background: var(--card);
      color: var(--fg);
    }

    /* Listenzeilen */
    .row { background: var(--card); border:1px solid var(--border); border-radius:.75rem; padding:.6rem .8rem; }

    /* Utility */
    .mono { font-feature-settings: "tnum"; font-variant-numeric: tabular-nums; }
  </style>
</head>
<body class="antialiased">

  <!-- ===== Header ===== -->
  <header class="app">
    <div class="max-w-2xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
      <button id="btnBack" class="btn px-3 py-2 hidden">
        ← Zurück
      </button>

      <h1 id="headerTitle" class="app-title text-xl text-center flex-1">
        Life RPG
      </h1>

      <button id="btnTheme" class="btn px-3 py-2" title="Hell/Dunkel umschalten">
        🌗
      </button>
    </div>
  </header>

  <!-- ===== Inhalt ===== -->
  <main class="app">
    <div class="max-w-2xl mx-auto px-4 space-y-6">

      <!-- ===== Hauptmenü ===== -->
      <section id="view-menu" class="view active">
        <!-- === MAINMENU === -->
        <div class="space-y-4">
          <div class="card p-4">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-sm text-slate-500 dark:text-slate-300">Willkommen</div>
                <div class="text-lg font-semibold">Was möchtest du tun?</div>
              </div>
              <div class="text-right">
                <div class="text-sm text-slate-500 dark:text-slate-300">Level</div>
                <div id="mmLevel" class="mono text-lg font-bold">—</div>
              </div>
            </div>
            <div class="mt-2 grid grid-cols-3 gap-3 text-center">
              <div class="row">
                <div class="text-xs text-slate-500 dark:text-slate-300">Punkte</div>
                <div id="mmPoints" class="mono text-lg font-bold">—</div>
              </div>
              <div class="row">
                <div class="text-xs text-slate-500 dark:text-slate-300">Sparstand</div>
                <div class="mono text-lg font-bold">€<span id="mmSavings">—</span></div>
              </div>
              <div class="row">
                <div class="text-xs text-slate-500 dark:text-slate-300">Einträge</div>
                <div id="mmEntries" class="mono text-lg font-bold">—</div>
              </div>
            </div>
          </div>

          <!-- Navigationsliste -->
          <div class="space-y-3">
            <button class="btn w-full flex items-center justify-between" data-go="dashboard">
              <span>📊 Dashboard</span>
              <span class="text-slate-500 dark:text-slate-300">Übersicht</span>
            </button>
            <button class="btn w-full flex items-center justify-between" data-go="log">
              <span>📝 Log</span>
              <span class="text-slate-500 dark:text-slate-300">Eintragen & Verlauf</span>
            </button>
            <button class="btn w-full flex items-center justify-between" data-go="catalog">
              <span>📚 Katalog</span>
              <span class="text-slate-500 dark:text-slate-300">Vorlagen</span>
            </button>
            <button class="btn w-full flex items-center justify-between" data-go="categories">
              <span>🗂️ Kategorien</span>
              <span class="text-slate-500 dark:text-slate-300">(inkl. negativ)</span>
            </button>
            <button class="btn w-full flex items-center justify-between" data-go="missions">
              <span>🧭 Missionen</span>
              <span class="text-slate-500 dark:text-slate-300">Schrittfolgen</span>
            </button>
            <button class="btn w-full flex items-center justify-between" data-go="milestones">
              <span>🏅 Meilensteine</span>
              <span class="text-slate-500 dark:text-slate-300">automatisch</span>
            </button>
            <button class="btn w-full flex items-center justify-between" data-go="settings">
              <span>⚙️ Einstellungen</span>
              <span class="text-slate-500 dark:text-slate-300">Export/Import</span>
            </button>
          </div>
        </div>
      </section>

      <!-- ===== Dashboard (leicht) ===== -->
      <section id="view-dashboard" class="view">
        <div class="space-y-4">
          <div class="grid md:grid-cols-3 gap-3">
            <div class="row">
              <div class="text-xs text-slate-500 dark:text-slate-300">Punkte</div>
              <div id="dbPoints" class="mono text-2xl font-extrabold">0</div>
            </div>
            <div class="row">
              <div class="text-xs text-slate-500 dark:text-slate-300">Level</div>
              <div id="dbLevel" class="mono text-2xl font-extrabold">1</div>
            </div>
            <div class="row">
              <div class="text-xs text-slate-500 dark:text-slate-300">Sparstand</div>
              <div class="mono text-2xl font-extrabold">€<span id="dbSavings">0.00</span></div>
            </div>
          </div>

          <div class="card p-4">
            <div class="font-semibold mb-2">Heute</div>
            <div id="dbToday" class="text-sm text-slate-600 dark:text-slate-300">Noch keine Einträge.</div>
          </div>
        </div>
      </section>

      <!-- ===== Log (minimal funktionsfähig) ===== -->
      <section id="view-log" class="view">
        <div class="space-y-4">
          <div class="card p-4 space-y-2">
            <div class="grid md:grid-cols-4 gap-2">
              <input id="logDate" type="date" class="input" />
              <input id="logQuest" class="input md:col-span-2" placeholder="Questname" />
              <input id="logPoints" type="number" class="input" placeholder="Punkte" />
            </div>
            <div class="flex gap-2">
              <button id="btnAddLog" class="btn btn-primary">Eintragen</button>
              <button id="btnUndo" class="btn">Rückgängig</button>
            </div>
          </div>

          <div class="card p-4">
            <div class="font-semibold mb-2">Verlauf</div>
            <div id="logList" class="space-y-2 text-sm"></div>
          </div>
        </div>
      </section>

      <!-- ===== Katalog (Stub) ===== -->
      <section id="view-catalog" class="view">
        <div class="space-y-4">
          <div class="card p-4 space-y-2">
            <div class="grid md:grid-cols-3 gap-2">
              <input id="catName" class="input md:col-span-2" placeholder="Neue Questvorlage (z. B. Sport)" />
              <input id="catPts" type="number" class="input" placeholder="Punkte" />
            </div>
            <button id="btnAddTemplate" class="btn btn-primary">Zur Liste hinzufügen</button>
          </div>

          <div class="card p-4">
            <div class="font-semibold mb-2">Vorlagen</div>
            <div id="catalogList" class="space-y-2"></div>
          </div>
        </div>
      </section>

      <!-- ===== Kategorien (Stub) ===== -->
      <section id="view-categories" class="view">
        <div class="space-y-4">
          <div class="card p-4">
            <div class="font-semibold mb-2">Kategorien (inkl. negativ)</div>
            <div id="catOverview" class="text-sm text-slate-600 dark:text-slate-300">
              Wird in Phase 3 ausgebaut. (Baseline zeigt nur Platzhalter)
            </div>
          </div>
        </div>
      </section>

      <!-- ===== Missionen (Stub) ===== -->
      <section id="view-missions" class="view">
        <div class="space-y-4">
          <div class="card p-4">
            <div class="font-semibold mb-2">Missionen</div>
            <div class="text-sm text-slate-600 dark:text-slate-300">
              Editor & Abhängigkeiten folgen in Phase 5.
            </div>
          </div>
        </div>
      </section>

      <!-- ===== Meilensteine (Stub) ===== -->
      <section id="view-milestones" class="view">
        <div class="space-y-4">
          <div class="card p-4">
            <div class="font-semibold mb-2">Meilensteine</div>
            <div class="text-sm text-slate-600 dark:text-slate-300">
              Automatische Generierung folgt in Phase 6.
            </div>
          </div>
        </div>
      </section>

      <!-- ===== Einstellungen ===== -->
      <section id="view-settings" class="view">
        <div class="space-y-4">
          <div class="card p-4 space-y-2">
            <div class="grid md:grid-cols-3 gap-2">
              <label class="text-sm">
                € pro Punkt
                <input id="setEuro" type="number" step="0.01" class="input" />
              </label>
              <label class="text-sm">
                Level-Basis
                <input id="setBase" type="number" class="input" />
              </label>
              <label class="text-sm">
                Wachstum
                <input id="setGrowth" type="number" step="0.01" class="input" />
              </label>
            </div>
          </div>

          <div class="card p-4 space-y-2">
            <div class="font-semibold">Daten</div>
            <div class="flex flex-wrap gap-2">
              <button id="btnExport" class="btn">Export</button>
              <input id="fileImport" type="file" accept="application/json" class="hidden" />
              <button id="btnImport" class="btn">Import</button>
              <button id="btnWipe" class="btn btn-danger">Alles löschen</button>
            </div>
            <div id="migInfo" class="text-xs text-slate-500 dark:text-slate-300 mt-1">
              Migration aus v1 erfolgt automatisch, falls vorhanden.
            </div>
          </div>
        </div>
      </section>

    </div>
  </main>

  <!-- ===== App Script ===== -->
  <script>
  ;(() => {
    // ---------- Storage Keys & Version ----------
    const KEY_V2 = "lifeRPG_v2";
    const KEY_V1 = "lifeRPG_p1";
    const SCHEMA_VERSION = 2;

    // ---------- Default State ----------
    const defaultState = {
      version: SCHEMA_VERSION,
      createdAt: new Date().toISOString(),
      settings: { euro: 0.10, base: 100, growth: 0.10, dark: false },
      log: [],                  // [{date, quest, points, base?}]
      catalog: [],              // [{name, points}]
      categories: [],           // Phase 3
      missions: [],             // Phase 5
      milestones: []            // Phase 6
    };

    // ---------- Load / Save ----------
    function loadV2() {
      try {
        const raw = localStorage.getItem(KEY_V2);
        if (!raw) return null;
        return JSON.parse(raw);
      } catch { return null; }
    }
    function saveV2() {
      localStorage.setItem(KEY_V2, JSON.stringify(state));
    }

    // ---------- Migration v1 -> v2 (sanft, einmalig) ----------
    function migrateFromV1() {
      try {
        const raw = localStorage.getItem(KEY_V1);
        if (!raw) return null;
        const v1 = JSON.parse(raw);
        const s = structuredClone(defaultState);

        // Übernehmen, wo vorhanden
        if (Array.isArray(v1.log)) s.log = v1.log;
        if (Array.isArray(v1.catalog)) s.catalog = v1.catalog;
        if (v1.settings) {
          s.settings.euro   = Number(v1.settings.euro ?? s.settings.euro);
          s.settings.base   = Number(v1.settings.base ?? s.settings.base);
          s.settings.growth = Number(v1.settings.growth ?? s.settings.growth);
        }
        s.version = SCHEMA_VERSION;
        return s;
      } catch {
        return null;
      }
    }

    // ---------- Ensure Schema / Defaults ----------
    function ensureSchema(obj) {
      const s = Object.assign({}, defaultState, obj || {});
      s.version = SCHEMA_VERSION;
      s.settings = Object.assign({}, defaultState.settings, s.settings || {});
      s.log = Array.isArray(s.log) ? s.log : [];
      s.catalog = Array.isArray(s.catalog) ? s.catalog : [];
      s.categories = Array.isArray(s.categories) ? s.categories : [];
      s.missions = Array.isArray(s.missions) ? s.missions : [];
      s.milestones = Array.isArray(s.milestones) ? s.milestones : [];
      return s;
    }

    // ---------- Init State ----------
    let state = loadV2();
    if (!state) {
      const migrated = migrateFromV1();
      state = ensureSchema(migrated || defaultState);
      saveV2();
    } else {
      state = ensureSchema(state);
      saveV2();
    }

    // ---------- Theme ----------
    function applyTheme() {
      const html = document.documentElement;
      if (state.settings.dark) html.classList.add("dark");
      else html.classList.remove("dark");
    }
    applyTheme();

    // ---------- Helpers ----------
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const todayISO = () => new Date().toISOString().slice(0,10);

    function totalPoints() { return state.log.reduce((s,e) => s + (Number(e.points)||0), 0); }
    function totalSavings() { return totalPoints() * Number(state.settings.euro || 0); }

    function levelForPoints(p) {
      let lvl=1, need=Number(state.settings.base||100), growth=Number(state.settings.growth||0.1);
      let pts=p;
      while (pts >= need) { lvl++; pts -= need; need = Math.round(need * (1 + growth)); }
      return Math.max(1,lvl);
    }

    // ---------- Router ----------
    let viewStack = ["menu"];
    const headerTitle = $("#headerTitle");
    const btnBack = $("#btnBack");

    function showView(id, push=true) {
      $$(".view").forEach(v => v.classList.remove("active"));
      $("#view-" + id).classList.add("active");

      // Header
      const titleMap = {
        menu: "Life RPG",
        dashboard: "Dashboard",
        log: "Log",
        catalog: "Katalog",
        categories: "Kategorien",
        missions: "Missionen",
        milestones: "Meilensteine",
        settings: "Einstellungen"
      };
      headerTitle.textContent = titleMap[id] || "Life RPG";

      // Back sichtbar außer im Menü
      if (id === "menu") {
        btnBack.classList.add("hidden");
      } else {
        btnBack.classList.remove("hidden");
      }

      if (push) {
        // gleiche Seite nicht doppelt stapeln
        if (viewStack[viewStack.length-1] !== id) viewStack.push(id);
      }
      renderAll();
    }

    btnBack.addEventListener("click", () => {
      // mindestens zum Menü
      if (viewStack.length <= 1) {
        viewStack = ["menu"];
        showView("menu", false);
      } else {
        viewStack.pop(); // aktuelle weg
        const prev = viewStack[viewStack.length-1] || "menu";
        showView(prev, false);
      }
    });

    // Menü-Buttons
    $$("#view-menu [data-go]").forEach(btn => {
      btn.addEventListener("click", () => showView(btn.dataset.go));
    });

    // Theme toggle
    $("#btnTheme").addEventListener("click", () => {
      state.settings.dark = !state.settings.dark;
      saveV2();
      applyTheme();
      renderAll();
    });

    // ---------- Views: Render ----------
    function renderMenu() {
      $("#mmLevel").textContent = levelForPoints(totalPoints());
      $("#mmPoints").textContent = totalPoints();
      $("#mmSavings").textContent = totalSavings().toFixed(2);
      $("#mmEntries").textContent = state.log.length;
    }

    function renderDashboard() {
      $("#dbPoints").textContent = totalPoints();
      $("#dbLevel").textContent = levelForPoints(totalPoints());
      $("#dbSavings").textContent = totalSavings().toFixed(2);

      const t = todayISO();
      const todayList = state.log.filter(e => e.date === t);
      $("#dbToday").textContent = todayList.length
        ? todayList.map(e => `${e.quest} (+${e.points})`).join(" · ")
        : "Noch keine Einträge.";
    }

    function renderLog() {
      $("#logDate").value = todayISO();

      const list = $("#logList");
      if (!list) return;
      if (state.log.length === 0) {
        list.innerHTML = `<div class="text-slate-500 dark:text-slate-300">Noch nichts eingetragen.</div>`;
        return;
      }
      list.innerHTML = state.log.slice().reverse().map(e =>
        `<div class="row flex items-center justify-between">
          <div>${e.date} • ${e.quest}</div>
          <div class="mono font-semibold">+${e.points}</div>
        </div>`
      ).join("");
    }

    function renderCatalog() {
      const wrap = $("#catalogList");
      if (!wrap) return;
      if (state.catalog.length === 0) {
        wrap.innerHTML = `<div class="text-slate-500 dark:text-slate-300">Noch keine Vorlagen.</div>`;
        return;
      }
      wrap.innerHTML = state.catalog.map((q,i) =>
        `<div class="row flex items-center justify-between">
          <div>📌 ${q.name} <span class="text-slate-500 dark:text-slate-300">(+${q.points})</span></div>
          <button class="btn text-xs" data-use="${i}">Eintragen</button>
        </div>`
      ).join("");

      // Schnell eintragen aus Vorlage
      wrap.querySelectorAll("[data-use]").forEach(btn => {
        btn.addEventListener("click", () => {
          const q = state.catalog[Number(btn.dataset.use)];
          const d = todayISO();
          state.log.push({date:d, quest:q.name, points:Number(q.points)||0, base:q.points});
          saveV2();
          renderAll();
          showView("log"); // direkt ins Log
        });
      });
    }

    function renderSettings() {
      $("#setEuro").value = state.settings.euro;
      $("#setBase").value = state.settings.base;
      $("#setGrowth").value = state.settings.growth;
    }

    function renderAll() {
      if ($("#view-menu").classList.contains("active")) renderMenu();
      if ($("#view-dashboard").classList.contains("active")) renderDashboard();
      if ($("#view-log").classList.contains("active")) renderLog();
      if ($("#view-catalog").classList.contains("active")) renderCatalog();
      if ($("#view-settings").classList.contains("active")) renderSettings();
    }

    // ---------- Events: Log ----------
    $("#btnAddLog").addEventListener("click", () => {
      const d = $("#logDate").value || todayISO();
      const q = ($("#logQuest").value || "").trim();
      const p = Number($("#logPoints").value || 0);
      if (!q) { alert("Bitte Questname eingeben."); return; }
      state.log.push({date:d, quest:q, points:p});
      saveV2();
      $("#logQuest").value = "";
      $("#logPoints").value = "";
      renderAll();
    });

    $("#btnUndo").addEventListener("click", () => {
      if (!state.log.length) return;
      state.log.pop();
      saveV2();
      renderAll();
    });

    // ---------- Events: Catalog ----------
    $("#btnAddTemplate").addEventListener("click", () => {
      const name = ($("#catName").value || "").trim();
      const pts  = Number($("#catPts").value || 0);
      if (!name || !pts) { alert("Name & Punkte angeben."); return; }
      state.catalog.push({name, points:pts});
      saveV2();
      $("#catName").value = "";
      $("#catPts").value = "";
      renderAll();
    });

    // ---------- Events: Settings ----------
    $("#setEuro").addEventListener("change", e => {
      state.settings.euro = Number(e.target.value || 0);
      saveV2(); renderAll();
    });
    $("#setBase").addEventListener("change", e => {
      state.settings.base = Number(e.target.value || 100);
      saveV2(); renderAll();
    });
    $("#setGrowth").addEventListener("change", e => {
      state.settings.growth = Number(e.target.value || 0.1);
      saveV2(); renderAll();
    });

    $("#btnExport").addEventListener("click", () => {
      const blob = new Blob([JSON.stringify(state,null,2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "life_rpg_backup_v2.json";
      a.click();
    });

    $("#btnImport").addEventListener("click", () => $("#fileImport").click());
    $("#fileImport").addEventListener("change", e => {
      const f = e.target.files[0];
      if (!f) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const incoming = JSON.parse(reader.result);
          // sanfte Zusammenführung: nur bekannte Felder
          state = ensureSchema(incoming);
          saveV2();
          renderAll();
          alert("Import erfolgreich.");
        } catch {
          alert("Fehler beim Import.");
        }
      };
      reader.readAsText(f);
    });

    $("#btnWipe").addEventListener("click", () => {
      if (!confirm("Wirklich ALLES löschen? (v2)")) return;
      state = ensureSchema(defaultState);
      saveV2();
      renderAll();
      showView("menu", false);
    });

    // ---------- Initial ----------
    // Start im Menü
    showView("menu", false);
    $("#logDate").value = todayISO();

    // Exponiere für Debug (optional)
    window._lifeRPG = { get state(){return state;}, save: saveV2, showView };
    /* =========================
       PHASE 2 PATCH — LOG & CATALOG
       ========================== */
    ;(() => {
      // Wir befinden uns noch im selben IIFE, daher Zugriff auf state/save/renderAll möglich.
      const $  = sel => document.querySelector(sel);
      const $$ = sel => Array.from(document.querySelectorAll(sel));

      // ------- LOG: Suche & Schnellauswahl UI einmalig einbauen -------
      let logFilter = ""; // aktueller Textfilter

      function ensureLogEnhancementsUI() {
        const view = $("#view-log");
        if (!view) return;

        // 1) Schnellauswahl-Block (unter dem Eingabe-Form-Card)
        if (!$("#quickLogWrap")) {
          const formCard = view.querySelector(".card"); // erste Card im Log-View
          if (formCard) {
            const wrap = document.createElement("div");
            wrap.id = "quickLogWrap";
            wrap.className = "mt-3 p-3 card";

            wrap.innerHTML = `
              <div class="font-semibold mb-2">Schnellauswahl aus Katalog</div>
              <div class="grid md:grid-cols-4 gap-2 items-center">
                <select id="quickQuest" class="input md:col-span-2"></select>
                <input id="quickPts" type="number" class="input" placeholder="Punkte" />
                <button id="btnQuickAdd" class="btn btn-primary">Eintragen</button>
              </div>
            `;
            formCard.after(wrap);

            // Events werden unten in bindLogEnhancementEvents() gesetzt
          }
        }

        // 2) Suchfeld (über der Verlaufsliste in der zweiten Card)
        const listCard = view.querySelectorAll(".card")[1];
        if (listCard && !$("#logSearchWrap")) {
          const s = document.createElement("div");
          s.id = "logSearchWrap";
          s.className = "mb-3 flex items-center gap-2";
          s.innerHTML = `
            <input id="logSearch" class="input" placeholder="Suchen (Name oder Datum z.B. 2025-09-01)" />
            <button id="logSearchClear" class="btn">Leeren</button>
          `;
          listCard.prepend(s);
        }
      }

      function bindLogEnhancementEvents() {
        // Katalogoptionen befüllen
        const sel = $("#quickQuest");
        const pts = $("#quickPts");
        if (sel && pts) {
          sel.innerHTML = (state.catalog.length
            ? state.catalog.map((q,i)=>`<option value="${i}">${q.name} (+${q.points})</option>`).join("")
            : `<option value="">— Keine Vorlagen —</option>`
          );
          // Punkte-Autofill
          sel.addEventListener("change", () => {
            const idx = Number(sel.value);
            const q = state.catalog[idx];
            pts.value = q ? (q.points || 0) : "";
          });
          // Initial setzen
          if (state.catalog[0]) pts.value = state.catalog[0].points || 0;

          // Eintragen aus Schnellauswahl
          const btnQ = $("#btnQuickAdd");
          if (btnQ) {
            btnQ.onclick = () => {
              const idx = Number(sel.value);
              const q = state.catalog[idx];
              const valPts = Number(pts.value || (q?.points || 0));
              if (!q) { alert("Bitte eine Vorlage wählen."); return; }
              const d = $("#logDate")?.value || new Date().toISOString().slice(0,10);
              state.log.push({date:d, quest:q.name, points:valPts, base:q.points});
              saveV2();
              renderAll();
            };
          }
        }

        // Suche
        const inp = $("#logSearch");
        const clr = $("#logSearchClear");
        if (inp) {
          inp.oninput = () => {
            logFilter = (inp.value || "").trim().toLowerCase();
            renderLogEnhancedList(); // nur Liste neu zeichnen
          };
        }
        if (clr) {
          clr.onclick = () => {
            logFilter = "";
            if (inp) inp.value = "";
            renderLogEnhancedList();
          };
        }
      }

      // Hilfsfunktion: Filter anwenden und Liste mit Löschbuttons rendern
      function renderLogEnhancedList() {
        const list = $("#logList");
        if (!list) return;

        let items = state.log.slice(); // von alt nach neu
        if (logFilter) {
          items = items.filter(e =>
            (e.quest || "").toLowerCase().includes(logFilter) ||
            (e.date || "").toLowerCase().includes(logFilter)
          );
        }

        if (items.length === 0) {
          list.innerHTML = `<div class="text-slate-500 dark:text-slate-300">Keine passenden Einträge.</div>`;
          return;
        }

        // Wir zeigen neueste zuerst (reverse) — brauchen Original-Index zum Löschen.
        list.innerHTML = items.slice().reverse().map(e => {
          const idxOriginal = state.log.indexOf(e); // stabil, weil Referenzen identisch
          return `
            <div class="row flex items-center justify-between">
              <div>${e.date} • ${e.quest}</div>
              <div class="flex items-center gap-2">
                <div class="mono font-semibold">+${e.points}</div>
                <button class="btn text-xs" data-del="${idxOriginal}" title="Eintrag löschen">🗑️</button>
              </div>
            </div>
          `;
        }).join("");

        // Lösch-Events binden
        list.querySelectorAll("[data-del]").forEach(btn => {
          btn.addEventListener("click", () => {
            const idx = Number(btn.getAttribute("data-del"));
            if (idx >= 0 && idx < state.log.length) {
              state.log.splice(idx, 1);
              saveV2();
              renderAll();
            }
          });
        });
      }

      // Wir hängen uns an die bestehende renderLog() an
      const _renderLog = renderLog;
      renderLog = function() {
        _renderLog();
        ensureLogEnhancementsUI();
        bindLogEnhancementEvents();
        renderLogEnhancedList(); // ersetzt die einfache Liste
      };

      // ------- KATALOG: Löschen & Eintragen -------
      const _renderCatalog = renderCatalog;
      renderCatalog = function() {
        const wrap = $("#catalogList");
        if (!wrap) return;

        if (state.catalog.length === 0) {
          wrap.innerHTML = `<div class="text-slate-500 dark:text-slate-300">Noch keine Vorlagen.</div>`;
          return;
        }

        wrap.innerHTML = state.catalog.map((q,i) => `
          <div class="row flex items-center justify-between gap-2">
            <div>📌 ${q.name} <span class="text-slate-500 dark:text-slate-300">(+${q.points})</span></div>
            <div class="flex gap-2">
              <button class="btn text-xs" data-use="${i}">Eintragen</button>
              <button class="btn text-xs btn-danger" data-del="${i}">Löschen</button>
            </div>
          </div>
        `).join("");

        // Eintragen
        wrap.querySelectorAll("[data-use]").forEach(btn => {
          btn.addEventListener("click", () => {
            const q = state.catalog[Number(btn.dataset.use)];
            if (!q) return;
            const d = new Date().toISOString().slice(0,10);
            state.log.push({date:d, quest:q.name, points:Number(q.points)||0, base:q.points});
            saveV2();
            renderAll();
            showView("log", true);
          });
        });

        // Löschen
        wrap.querySelectorAll("[data-del]").forEach(btn => {
          btn.addEventListener("click", () => {
            const i = Number(btn.dataset.del);
            if (i >= 0) {
              state.catalog.splice(i,1);
              saveV2();
              renderAll();
            }
          });
        });
      };

      // Beim ersten Laden gleich aufräumen
      // (Falls Log-View schon aktiv ist)
      if ($("#view-log").classList.contains("active")) {
        ensureLogEnhancementsUI();
        bindLogEnhancementEvents();
        renderLogEnhancedList();
      }
    })();
    /* ===== END PHASE 2 PATCH ===== */
    /* =========================
       PHASE 3 PATCH — CATEGORIES
       ========================== */
    ;(() => {
      const $  = sel => document.querySelector(sel);
      const $$ = sel => Array.from(document.querySelectorAll(sel));

      // ---- State initialisieren / migrieren ----
      state.categories = state.categories || [
        { id:"cat_sonstige", name:"Sonstige", type:"positive", color:"#64748b" },
        { id:"cat_sport",    name:"Sport",    type:"positive", color:"#0ea5e9" },
        { id:"cat_haus",     name:"Handwerk", type:"positive", color:"#f59e0b" },
        { id:"cat_bad",      name:"Schlechter Lebensstil", type:"negative", color:"#ef4444" }
      ];
      // Katalog-Einträge erhalten optional: quest.categories = [{id, mult:number}]
      state.catalog.forEach(q => { q.categories = q.categories || []; });

      // Stelle sicher, dass "Sonstige" existiert
      function ensureMiscCategory(){
        if(!state.categories.find(c=>c.id==="cat_sonstige")){
          state.categories.unshift({ id:"cat_sonstige", name:"Sonstige", type:"positive", color:"#64748b" });
          saveV2();
        }
      }
      ensureMiscCategory();

      // ---- Helpers ----
      function findCat(id){ return state.categories.find(c=>c.id===id); }
      function catName(id){ return findCat(id)?.name || "Unbekannt"; }

      // Summe pro Kategorie (aus Log abgeleitet)
      function categoryTotals(){
        const sums = {};
        state.categories.forEach(c => sums[c.id] = 0);
        // Sammle pro Logeintrag die Quest und deren kategorisierte Punkte
        state.log.forEach(entry => {
          const q = state.catalog.find(x=>x.name===entry.quest);
          if(q && q.categories && q.categories.length){
            q.categories.forEach(ac => {
              const cat = findCat(ac.id);
              if(!cat) return;
              const base = (typeof entry.base === "number" ? entry.base : (q.points||0));
              const add  = Math.max(0, base * (Number(ac.mult)||1));
              sums[ac.id] += add;
            });
          }else{
            // keine Kategorie → "Sonstige"
            const base = (typeof entry.base === "number" ? entry.base : (q?.points||entry.points||0));
            const add = Math.max(0, base);
            sums["cat_sonstige"] = (sums["cat_sonstige"]||0) + add;
          }
        });
        return sums;
      }

      // ---- UI: Kategorie-Auswahl im Katalog-Formular (Mehrfachauswahl + Multiplikator) ----
      function ensureCatalogCategoryPicker(){
        const view = $("#view-catalog");
        if(!view) return;

        const formCard = view.querySelector(".card");
        if(!formCard) return;

        if(!$("#catAssignWrap")){
          const wrap = document.createElement("div");
          wrap.id = "catAssignWrap";
          wrap.className = "mt-3 p-3 card";
          wrap.innerHTML = `
            <div class="font-semibold mb-2">Kategorien & Multiplikatoren</div>
            <div id="catAssignRows" class="space-y-2"></div>
            <div class="flex flex-wrap gap-2 mt-2">
              <button id="btnAddCatRow" class="btn text-xs">+ Kategorie zuweisen</button>
              <button id="btnManageCats" class="btn text-xs">Kategorien verwalten</button>
            </div>
          `;
          formCard.after(wrap);

          // Event: neue Zuordnungzeile
          $("#btnAddCatRow").onclick = () => addCatAssignRow();
          // Event: Kategorien-Manager öffnen (unten implementiert)
          $("#btnManageCats").onclick = () => openCategoryManager();
        }
        // beim ersten Laden mindestens eine Zeile
        const rows = $("#catAssignRows");
        if (rows && rows.children.length === 0) addCatAssignRow();
      }

      function addCatAssignRow(pre = null){
        const rows = $("#catAssignRows");
        if(!rows) return;
        const div = document.createElement("div");
        div.className = "grid md:grid-cols-3 gap-2 items-center";
        div.innerHTML = `
          <select class="input catSel"></select>
          <input type="number" step="0.01" class="input catMult" placeholder="Multiplikator (z.B. 1, 1.5, 2)" />
          <button class="btn text-xs btn-danger catDel">Entfernen</button>
        `;
        rows.appendChild(div);

        const sel = div.querySelector(".catSel");
        const mult = div.querySelector(".catMult");
        sel.innerHTML = state.categories.map(c=>`<option value="${c.id}">${c.name} ${c.type==="negative"?"(negativ)":""}</option>`).join("");
        mult.value = pre?.mult ?? 1;
        if(pre?.id) sel.value = pre.id;

        div.querySelector(".catDel").onclick = () => div.remove();
      }

      // Beim Anlegen einer Quest die gewählten Kategorien mitspeichern
      const _bindCatalogForm = bindCatalogForm;
      bindCatalogForm = function(){
        _bindCatalogForm?.(); // falls vorhanden
        ensureCatalogCategoryPicker();

        // Abfangen des "Hinzufügen"-Buttons aus Phase 1/2
        const btn = $("#btnAddCatalog");
        if(btn && !btn._catPatched){
          btn._catPatched = true;
          btn.addEventListener("click", () => {
            const qName  = $("#qName")?.value.trim();
            const qPts   = Number($("#qPoints")?.value || 0);
            if(!qName || !qPts){ return; }

            // Kategorien einsammeln
            const rows = $$("#catAssignRows .grid");
            const assigns = rows.map(r => {
              const sel = r.querySelector(".catSel");
              const mult = r.querySelector(".catMult");
              return { id: sel.value, mult: Number(mult.value||1) || 1 };
            }).filter(a => a.id);

            // Neuen Katalogeintrag erzeugen oder existierenden updaten
            const existing = state.catalog.find(q=>q.name.toLowerCase()===qName.toLowerCase());
            if(existing){
              existing.points = qPts;
              existing.categories = assigns;
            }else{
              state.catalog.push({ name:qName, points:qPts, categories:assigns });
            }
            saveV2();
            renderAll();

            // Formular leeren
            if($("#qName"))  $("#qName").value = "";
            if($("#qPoints")) $("#qPoints").value = "";
            const cont = $("#catAssignRows"); if(cont) cont.innerHTML = "";
            addCatAssignRow();
          });
        }
      };

      // ---- Katalog-Liste: Zeige Kategorien-Badges & Editor pro Quest ----
      const _renderCatalog = renderCatalog;
      renderCatalog = function(){
        _renderCatalog?.();

        const wrap = $("#catalogList");
        if(!wrap) return;
        // Liste ersetzen, um Badges & "Kategorien bearbeiten" hinzuzufügen
        wrap.innerHTML = state.catalog.length ? state.catalog.map((q,i) => {
          const badges = (q.categories||[]).map(ac=>{
            const c = findCat(ac.id);
            const label = c ? c.name : "Unbekannt";
            return `<span class="px-2 py-1 rounded text-xs" style="background:${c?.color||'#e5e7eb'};color:#fff">${label}×${ac.mult||1}</span>`;
          }).join(" ");

          return `
            <div class="row flex items-center justify-between gap-2">
              <div class="flex flex-col">
                <div>📌 ${q.name} <span class="text-slate-500 dark:text-slate-300">(+${q.points})</span></div>
                <div class="flex flex-wrap gap-1 mt-1">${badges || `<span class="text-slate-500 dark:text-slate-300 text-xs">Sonstige</span>`}</div>
              </div>
              <div class="flex gap-2">
                <button class="btn text-xs" data-editcats="${i}">Kategorien</button>
                <button class="btn text-xs" data-use="${i}">Eintragen</button>
                <button class="btn text-xs btn-danger" data-del="${i}">Löschen</button>
              </div>
            </div>
          `;
        }).join("") : `<div class="text-slate-500 dark:text-slate-300">Noch keine Vorlagen.</div>`;

        // Re-bind „Eintragen“ + „Löschen“ (Phase 2 Logik)
        wrap.querySelectorAll("[data-use]").forEach(btn => {
          btn.onclick = () => {
            const q = state.catalog[Number(btn.dataset.use)];
            if(!q) return;
            const d = new Date().toISOString().slice(0,10);
            state.log.push({date:d, quest:q.name, points:Number(q.points)||0, base:q.points});
            saveV2();
            renderAll();
          };
        });
        wrap.querySelectorAll("[data-del]").forEach(btn => {
          btn.onclick = () => {
            const i = Number(btn.dataset.del);
            if(i>=0){ state.catalog.splice(i,1); saveV2(); renderAll(); }
          };
        });
        // Kategorien bearbeiten
        wrap.querySelectorAll("[data-editcats]").forEach(btn => {
          btn.onclick = () => openQuestCategoryEditor(Number(btn.dataset.editcats));
        });

        // Unterhalb: Kategorien-Karte (Übersicht + Totals + Manager öffnen)
        renderCategoryOverviewCard();
      };

      // ---- Kategorien-Übersicht Karte im Katalog-View ----
      function renderCategoryOverviewCard(){
        const view = $("#view-catalog");
        if(!view) return;
        let card = $("#catOverviewCard");
        if(!card){
          card = document.createElement("div");
          card.id = "catOverviewCard";
          card.className = "mt-4 p-3 card";
          view.appendChild(card);
        }
        const sums = categoryTotals();
        const rows = state.categories.map(c => `
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <span class="inline-block w-3 h-3 rounded" style="background:${c.color}"></span>
              <button class="underline text-left" data-cdetail="${c.id}">${c.name}${c.type==="negative"?" (negativ)":""}</button>
            </div>
            <div class="mono font-semibold">${(sums[c.id]||0).toFixed(0)} Pkt</div>
          </div>
        `).join("");

        card.innerHTML = `
          <div class="font-semibold mb-2">Kategorien (Punktesummen)</div>
          <div class="space-y-2">${rows}</div>
          <div class="mt-3 flex flex-wrap gap-2">
            <button class="btn text-xs" id="btnAddCategory">+ Kategorie anlegen</button>
            <button class="btn text-xs" id="btnManageCats2">Verwalten</button>
          </div>
        `;

        $("#btnAddCategory").onclick = () => quickAddCategory();
        $("#btnManageCats2").onclick = () => openCategoryManager();
        card.querySelectorAll("[data-cdetail]").forEach(btn => {
          btn.onclick = () => openCategoryDetail(btn.getAttribute("data-cdetail"));
        });
      }

      // ---- Quick Add einer Kategorie (Prompt) ----
      function quickAddCategory(){
        const name = prompt("Kategoriename?");
        if(!name) return;
        const type = (prompt("Typ (positive|negative)?","positive")||"positive").toLowerCase().startsWith("neg") ? "negative" : "positive";
        const color = prompt("Farbe (CSS/Hex, z.B. #0ea5e9)?", type==="negative" ? "#ef4444" : "#0ea5e9") || (type==="negative" ? "#ef4444" : "#0ea5e9");
        const id = "cat_"+Math.random().toString(36).slice(2,8);
        state.categories.push({id,name, type, color});
        saveV2(); renderAll();
      }

      // ---- Modal/Overlay: Kategorien-Manager ----
      function openCategoryManager(){
        closeModal();
        const m = ensureModal();
        const list = state.categories.map(c => `
          <div class="row flex items-center justify-between gap-2">
            <div class="flex items-center gap-2">
              <span class="inline-block w-3 h-3 rounded" style="background:${c.color}"></span>
              <div>${c.name} ${c.type==="negative"?"(negativ)":""}</div>
            </div>
            <div class="flex gap-2">
              <button class="btn text-xs" data-editc="${c.id}">Bearb.</button>
              ${c.id==="cat_sonstige"?"":`<button class="btn text-xs btn-danger" data-delc="${c.id}">Löschen</button>`}
            </div>
          </div>
        `).join("");

        m.content.innerHTML = `
          <div class="font-semibold mb-2">Kategorien verwalten</div>
          <div class="space-y-2">${list || "<div class='text-slate-500 dark:text-slate-300'>Keine Kategorien</div>"}</div>
          <div class="mt-3 flex gap-2">
            <button class="btn" id="cmNew">+ Neu</button>
            <button class="btn btn-ghost" id="cmClose">Schließen</button>
          </div>
        `;
        $("#cmClose").onclick = closeModal;
        $("#cmNew").onclick = quickAddCategoryAndRefresh;

        m.content.querySelectorAll("[data-editc]").forEach(btn=>{
          btn.onclick = () => editCategory(btn.getAttribute("data-editc"));
        });
        m.content.querySelectorAll("[data-delc]").forEach(btn=>{
          btn.onclick = () => deleteCategory(btn.getAttribute("data-delc"));
        });
      }
      function quickAddCategoryAndRefresh(){ quickAddCategory(); openCategoryManager(); }
      function editCategory(id){
        const c = findCat(id); if(!c) return;
        const name = prompt("Neuer Name:", c.name); if(!name) return;
        const type = (prompt("Typ (positive|negative)?", c.type)||c.type).toLowerCase().startsWith("neg") ? "negative" : "positive";
        const color = prompt("Farbe (CSS/Hex):", c.color) || c.color;
        c.name = name; c.type = type; c.color = color;
        saveV2(); openCategoryManager(); renderAll();
      }
      function deleteCategory(id){
        if(id==="cat_sonstige") return;
        if(!confirm("Kategorie löschen? Zuweisungen gehen verloren.")) return;
        // entferne aus Kategorie-Liste
        state.categories = state.categories.filter(c=>c.id!==id);
        // aus allen Quests entfernen
        state.catalog.forEach(q => {
          q.categories = (q.categories||[]).filter(ac=>ac.id!==id);
        });
        saveV2(); openCategoryManager(); renderAll();
      }

      // ---- Modal: Kategorie-Detail (Quests in dieser Kategorie + Mini-Meilensteine-Platzhalter) ----
      function openCategoryDetail(catId){
        const m = ensureModal();
        const cat = findCat(catId);
        const sums = categoryTotals();
        const quests = state.catalog.filter(q => (q.categories||[]).some(ac=>ac.id===catId));

        const qRows = quests.length ? quests.map(q=>{
          const mult = (q.categories||[]).find(ac=>ac.id===catId)?.mult || 1;
          return `<div class="row flex items-center justify-between">
            <div>${q.name}</div>
            <div class="text-xs text-slate-500 dark:text-slate-300">×${mult}</div>
          </div>`;
        }).join("") : `<div class="text-slate-500 dark:text-slate-300">Keine zugeordneten Quests.</div>`;

        m.content.innerHTML = `
          <div class="flex items-center justify-between mb-2">
            <div class="font-semibold">${cat?.name||"Kategorie"}</div>
            <div class="mono font-semibold">${(sums[catId]||0).toFixed(0)} Pkt</div>
          </div>
          <div class="space-y-2">${qRows}</div>
          <div class="mt-3 flex justify-end">
            <button class="btn btn-ghost" id="cdClose">Schließen</button>
          </div>
        `;
        $("#cdClose").onclick = closeModal;
      }

      // ---- Modal: Quest-Kategorie-Editor ----
      function openQuestCategoryEditor(qIndex){
        const q = state.catalog[qIndex]; if(!q) return;
        const m = ensureModal();

        const options = state.categories.map(c => {
          const pre = (q.categories||[]).find(ac=>ac.id===c.id);
          return `
            <div class="grid md:grid-cols-3 gap-2 items-center">
              <label class="flex items-center gap-2">
                <input type="checkbox" class="chkCat" value="${c.id}" ${pre?"checked":""} />
                <span class="inline-flex items-center gap-2">
                  <span class="inline-block w-3 h-3 rounded" style="background:${c.color}"></span>
                  ${c.name} ${c.type==="negative"?"(negativ)":""}
                </span>
              </label>
              <input type="number" step="0.01" class="input multCat" value="${pre?.mult ?? 1}" />
              <div class="text-xs text-slate-500 dark:text-slate-300">Multiplikator</div>
            </div>`;
        }).join("");

        m.content.innerHTML = `
          <div class="font-semibold mb-2">Kategorien für: ${q.name}</div>
          <div id="qceRows" class="space-y-2">${options}</div>
          <div class="mt-3 flex justify-between">
            <button class="btn" id="qceAddCat">+ Kategorie anlegen</button>
            <div class="flex gap-2">
              <button class="btn btn-ghost" id="qceCancel">Abbrechen</button>
              <button class="btn btn-primary" id="qceSave">Speichern</button>
            </div>
          </div>
        `;

        $("#qceCancel").onclick = closeModal;
        $("#qceAddCat").onclick = () => { quickAddCategoryAndRefresh(); openQuestCategoryEditor(qIndex); };
        $("#qceSave").onclick = () => {
          const rows = $$("#qceRows .grid");
          const assigns = rows.map(r=>{
            const chk = r.querySelector(".chkCat");
            const mult = r.querySelector(".multCat");
            if(!chk.checked) return null;
            return { id: chk.value, mult: Number(mult.value||1)||1 };
          }).filter(Boolean);
          q.categories = assigns;
          saveV2(); renderAll(); closeModal();
        };
      }

      // ---- Modal Grundgerüst (einfach) ----
      function ensureModal(){
        let modal = $("#modal");
        if(!modal){
          modal = document.createElement("div");
          modal.id = "modal";
          modal.className = "fixed inset-0 z-50 flex items-center justify-center";
          modal.innerHTML = `
            <div id="modalBg" class="absolute inset-0 bg-black/40"></div>
            <div class="relative w-[90%] max-w-xl card p-4">
              <button id="modalX" class="absolute top-2 right-2 btn text-xs">✕</button>
              <div id="modalContent"></div>
            </div>
          `;
          document.body.appendChild(modal);
          $("#modalBg").onclick = closeModal;
          $("#modalX").onclick = closeModal;
        }
        return { root: modal, content: $("#modalContent") };
      }
      function closeModal(){
        const m = $("#modal");
        if(m) m.remove();
      }

      // ---- Log-Render erweitern: (nur Liste neu aus Phase 2, Farben bleiben dunkel/hell-konform) ----
      // (Keine Änderung nötig — Kategorie-Summen werden im Katalog angezeigt.)

      // ---- Initiale Hooks ----
      // Falls „Katalog“ gerade offen ist, sofort UI ergänzen
      if ($("#view-catalog")?.classList.contains("active")) {
        ensureCatalogCategoryPicker();
        renderCategoryOverviewCard();
      }
    })();
    /* ===== END PHASE 3 PATCH ===== */
    /* === PATCHES ANCHOR — DO NOT REMOVE === */
  })();
      /* ===============================
       PHASE 3 HOTFIX — CATEGORIES
       Selbständig, defensiv, sichtbar
       =============================== */
    (function(){
      console.log("Phase3 Hotfix init");

      // ---- robuste Helfer / Fallbacks ----
      const $  = s => document.querySelector(s);
      const $$ = s => Array.from(document.querySelectorAll(s));
      // Falls state/SKEY fehlen, minimal anlegen
      window.SKEY  = window.SKEY || "lifeRPG_p1";
      window.state = window.state || {log:[], catalog:[], settings:{}};
      const doSave = typeof save==="function"
        ? save
        : () => localStorage.setItem(SKEY, JSON.stringify(state));
      const doRenderAll = typeof renderAll==="function"
        ? renderAll
        : () => {};

      // ---- Standard-IDs deiner App (wir unterstützen beide Varianten) ----
      const getCatalogView = () =>
        document.getElementById("view-catalog") ||
        document.getElementById("tab-catalog");

      const getCatalogList = () =>
        document.getElementById("catalogList") ||
        (getCatalogView() && getCatalogView().querySelector("#catalogList"));

      // ---- Kategorien-Grunddaten + Migration ----
      state.categories = state.categories || [
        { id:"cat_sonstige", name:"Sonstige", type:"positive", color:"#64748b" },
        { id:"cat_sport",    name:"Sport",    type:"positive", color:"#0ea5e9" },
        { id:"cat_haus",     name:"Handwerk", type:"positive", color:"#f59e0b" },
        { id:"cat_bad",      name:"Schlechter Lebensstil", type:"negative", color:"#ef4444" }
      ];
      // Katalogeinträge tragen categories: [{id, mult}] — falls fehlt: leeres Array
      state.catalog.forEach(q => { q.categories = q.categories || []; });

      // ---- Utils ----
      const findCat = id => state.categories.find(c=>c.id===id);
      function ensureMisc(){
        if(!findCat("cat_sonstige")){
          state.categories.unshift({ id:"cat_sonstige", name:"Sonstige", type:"positive", color:"#64748b" });
          doSave();
        }
      }
      ensureMisc();

      function categoryTotals(){
        const sums = {};
        state.categories.forEach(c => sums[c.id]=0);
        state.log.forEach(e=>{
          const q = state.catalog.find(x=>x.name===e.quest);
          if(q && q.categories && q.categories.length){
            q.categories.forEach(ac=>{
              const base = (typeof e.base==="number" ? e.base : (q.points||e.points||0));
              sums[ac.id] = (sums[ac.id]||0) + Math.max(0, base*(Number(ac.mult)||1));
            });
          }else{
            const base = (typeof e.base==="number" ? e.base : (q?.points||e.points||0));
            sums["cat_sonstige"] = (sums["cat_sonstige"]||0) + Math.max(0, base);
          }
        });
        return sums;
      }

      // ---- UI: Kategorie-Picker unter das bestehende Katalog-Formular hängen ----
      function ensureCatalogPicker(){
        const host = getCatalogView();
        if(!host) return;

        // finde das Formular (wir stützen uns auf vorhandene Felder qName/qPoints)
        const formCard =
          host.querySelector(".card") ||
          host.querySelector("div > .space-y-2") || // frühere Struktur
          host.querySelector("div"); // fallback

        if(!formCard) return;

        if(!$("#catAssignWrap")){
          const wrap = document.createElement("div");
          wrap.id = "catAssignWrap";
          wrap.className = "mt-3 p-3 card";
          wrap.innerHTML = `
            <div class="font-semibold mb-2">Kategorien & Multiplikatoren</div>
            <div id="catAssignRows" class="space-y-2"></div>
            <div class="flex flex-wrap gap-2 mt-2">
              <button id="btnAddCatRow" class="btn text-xs">+ Kategorie zuweisen</button>
              <button id="btnManageCats" class="btn text-xs">Kategorien verwalten</button>
            </div>
          `;
          // direkt NACH dem Formular
          formCard.after(wrap);
          $("#btnAddCatRow").onclick = () => addCatRow();
          $("#btnManageCats").onclick = () => openCatManager();
          // Mindestens 1 Zeile
          addCatRow();
        }
      }

      function addCatRow(pre=null){
        const cont = $("#catAssignRows"); if(!cont) return;
        const row = document.createElement("div");
        row.className = "grid md:grid-cols-3 gap-2 items-center";
        row.innerHTML = `
          <select class="input catSel"></select>
          <input type="number" step="0.01" class="input catMult" placeholder="Multiplikator (1, 1.5 …)" />
          <button class="btn text-xs btn-danger catDel">Entfernen</button>
        `;
        cont.appendChild(row);
        const sel = row.querySelector(".catSel");
        const mult= row.querySelector(".catMult");
        sel.innerHTML = state.categories.map(c=>`<option value="${c.id}">${c.name} ${c.type==="negative"?"(negativ)":""}</option>`).join("");
        mult.value = pre?.mult ?? 1;
        if(pre?.id) sel.value = pre.id;
        row.querySelector(".catDel").onclick = () => row.remove();
      }

      // ---- Hook: Beim „Quest hinzufügen“-Button Kategorien mitspeichern ----
      function hookAddQuest(){
        // alte IDs aus deinen Versionen:
        const btn = document.getElementById("btnAddQuest") || document.getElementById("btnAddCatalog");
        if(!btn || btn._catHooked) return;
        btn._catHooked = true;

        btn.addEventListener("click", () => {
          // kleine Verzögerung, damit dein bestehender Handler erst schreiben kann
          setTimeout(()=>{
            const qName = (document.getElementById("qName")||{}).value?.trim?.();
            if(!qName) return;
            const rows = $$("#catAssignRows .grid");
            const assigns = rows.map(r=>{
              const id = r.querySelector(".catSel")?.value;
              const mult = Number(r.querySelector(".catMult")?.value||1)||1;
              return id ? {id,mult} : null;
            }).filter(Boolean);

            const q = state.catalog.find(x=>x.name.toLowerCase()===qName.toLowerCase());
            if(q){
              q.categories = assigns;
              doSave();
              doRenderAll();
              // Picker zurücksetzen
              const cont = $("#catAssignRows"); if(cont){ cont.innerHTML=""; addCatRow(); }
            }
          }, 0);
        });
      }

      // ---- Katalog-Liste nach dem Rendern mit Badges anreichern ----
      function decorateCatalogList(){
        const list = getCatalogList();
        if(!list) return;

        // Wir versuchen, pro sichtbarem Eintrag den Namen zu finden und Badges zu ergänzen
        const rows = $$("#catalogList > div, #catalogList .row");
        rows.forEach(row=>{
          if(row._decorated) return;
          const text = row.textContent || "";
          const q = state.catalog.find(x => text.includes(x.name));
          if(!q) return;

          // Badge-Zeile unter den Namen injizieren
          const badges = (q.categories||[]).map(ac=>{
            const c = findCat(ac.id);
            const label = c ? c.name : "Unbekannt";
            const chip = document.createElement("span");
            chip.className = "px-2 py-1 rounded text-xs mr-1";
            chip.style.background = (c?.color||"#e5e7eb");
            chip.style.color = "#fff";
            chip.textContent = `${label}×${ac.mult||1}`;
            return chip;
          });

          // schon eine zweite Zeile? dann nicht doppeln
          if(!row.querySelector(".cat-badges")){
            const line = document.createElement("div");
            line.className = "cat-badges flex flex-wrap gap-1 mt-1";
            if(badges.length===0){
              const s = document.createElement("span");
              s.className="text-slate-500 dark:text-slate-300 text-xs";
              s.textContent="Sonstige";
              line.appendChild(s);
            }else{
              badges.forEach(b=>line.appendChild(b));
            }
            row.appendChild(line);
          }

          row._decorated = true;
        });
      }

      // ---- Kategorien-Übersichtskarte unter die Liste hängen ----
      function renderCategoryOverview(){
        const host = getCatalogView();
        if(!host) return;
        let card = document.getElementById("catOverviewCard");
        if(!card){
          card = document.createElement("div");
          card.id = "catOverviewCard";
          card.className = "mt-4 p-3 card";
          host.appendChild(card);
        }
        const sums = categoryTotals();
        const rows = state.categories.map(c=>`
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <span class="inline-block w-3 h-3 rounded" style="background:${c.color}"></span>
              <button class="underline text-left" data-cdetail="${c.id}">${c.name}${c.type==="negative"?" (negativ)":""}</button>
            </div>
            <div class="mono font-semibold">${(sums[c.id]||0).toFixed(0)} Pkt</div>
          </div>
        `).join("");

        card.innerHTML = `
          <div class="font-semibold mb-2">Kategorien (Punktesummen)</div>
          <div class="space-y-2">${rows}</div>
          <div class="mt-3 flex flex-wrap gap-2">
            <button class="btn text-xs" id="btnAddCategoryQuick">+ Kategorie anlegen</button>
            <button class="btn text-xs" id="btnManageCats2">Verwalten</button>
          </div>
        `;
        document.getElementById("btnAddCategoryQuick").onclick = () => { quickAddCategory(); renderCategoryOverview(); };
        document.getElementById("btnManageCats2").onclick = openCatManager;
        card.querySelectorAll("[data-cdetail]").forEach(b=>{
          b.onclick = () => openCategoryDetail(b.getAttribute("data-cdetail"));
        });
      }

      // ---- Quick Add / Manager / Detail (einfache Modals) ----
      function ensureModal(){
        let m = document.getElementById("modal");
        if(!m){
          m = document.createElement("div");
          m.id = "modal";
          m.className = "fixed inset-0 z-50 flex items-center justify-center";
          m.innerHTML = `
            <div id="modalBg" class="absolute inset-0 bg-black/40"></div>
            <div class="relative w-[90%] max-w-xl card p-4 bg-white dark:bg-slate-800">
              <button id="modalX" class="absolute top-2 right-2 btn text-xs">✕</button>
              <div id="modalContent"></div>
            </div>
          `;
          document.body.appendChild(m);
          $("#modalBg").onclick = closeModal;
          $("#modalX").onclick = closeModal;
        }
        return {root:m, content: document.getElementById("modalContent")};
      }
      function closeModal(){ const m=$("#modal"); if(m) m.remove(); }

      function quickAddCategory(){
        const name = prompt("Kategoriename?");
        if(!name) return;
        const type = (prompt("Typ (positive|negative)?","positive")||"positive").toLowerCase().startsWith("neg") ? "negative":"positive";
        const color= prompt("Farbe (z. B. #0ea5e9):", type==="negative"?"#ef4444":"#0ea5e9") || (type==="negative"?"#ef4444":"#0ea5e9");
        const id = "cat_"+Math.random().toString(36).slice(2,8);
        state.categories.push({id,name,type,color});
        doSave();
      }

      function openCatManager(){
        const m = ensureModal();
        const rows = state.categories.map(c=>`
          <div class="row flex items-center justify-between gap-2">
            <div class="flex items-center gap-2">
              <span class="inline-block w-3 h-3 rounded" style="background:${c.color}"></span>
              <div>${c.name} ${c.type==="negative"?"(negativ)":""}</div>
            </div>
            <div class="flex gap-2">
              <button class="btn text-xs" data-editc="${c.id}">Bearb.</button>
              ${c.id==="cat_sonstige"?"":`<button class="btn text-xs btn-danger" data-delc="${c.id}">Löschen</button>`}
            </div>
          </div>
        `).join("");

        m.content.innerHTML = `
          <div class="font-semibold mb-2">Kategorien verwalten</div>
          <div class="space-y-2">${rows || "<div class='text-slate-500 dark:text-slate-300'>Keine Kategorien</div>"}</div>
          <div class="mt-3 flex gap-2">
            <button class="btn" id="cmNew">+ Neu</button>
            <button class="btn btn-ghost" id="cmClose">Schließen</button>
          </div>
        `;
        $("#cmClose").onclick = closeModal;
        $("#cmNew").onclick = () => { quickAddCategory(); openCatManager(); };

        m.content.querySelectorAll("[data-editc]").forEach(btn=>{
          btn.onclick = ()=>{
            const id = btn.getAttribute("data-editc");
            const c = findCat(id); if(!c) return;
            const name = prompt("Neuer Name:", c.name); if(!name) return;
            const type = (prompt("Typ (positive|negative)?", c.type)||c.type).toLowerCase().startsWith("neg")?"negative":"positive";
            const color= prompt("Farbe:", c.color)||c.color;
            c.name=name; c.type=type; c.color=color;
            doSave(); openCatManager();
          };
        });
        m.content.querySelectorAll("[data-delc]").forEach(btn=>{
          btn.onclick = ()=>{
            const id = btn.getAttribute("data-delc");
            if(id==="cat_sonstige") return;
            if(!confirm("Kategorie löschen? Zuweisungen gehen verloren.")) return;
            state.categories = state.categories.filter(c=>c.id!==id);
            state.catalog.forEach(q=> q.categories = (q.categories||[]).filter(ac=>ac.id!==id));
            doSave(); openCatManager();
          };
        });
      }

      function openCategoryDetail(catId){
        const m = ensureModal();
        const cat  = findCat(catId);
        const sums = categoryTotals();
        const quests = state.catalog.filter(q => (q.categories||[]).some(ac=>ac.id===catId));
        const qRows = quests.length ? quests.map(q=>{
          const mult = (q.categories||[]).find(ac=>ac.id===catId)?.mult || 1;
          return `<div class="row flex items-center justify-between">
            <div>${q.name}</div><div class="text-xs text-slate-500 dark:text-slate-300">×${mult}</div>
          </div>`;
        }).join("") : `<div class="text-slate-500 dark:text-slate-300">Keine zugeordneten Quests.</div>`;

        m.content.innerHTML = `
          <div class="flex items-center justify-between mb-2">
            <div class="font-semibold">${cat?.name||"Kategorie"}</div>
            <div class="mono font-semibold">${(sums[catId]||0).toFixed(0)} Pkt</div>
          </div>
          <div class="space-y-2">${qRows}</div>
          <div class="mt-3 flex justify-end"><button class="btn btn-ghost" id="cdClose">Schließen</button></div>
        `;
        $("#cdClose").onclick = closeModal;
      }

      // ---- orchestrieren ----
      function refreshCategoriesUI(){
        ensureCatalogPicker();
        decorateCatalogList();
        renderCategoryOverview();
        hookAddQuest();
      }

      // Bei jedem globalen Render nachziehen (falls vorhanden)
      if(typeof renderAll==="function"){
        const _old = renderAll;
        window.renderAll = function(){
          _old();
          // Asynchron, damit DOM der Liste fertig ist
          setTimeout(refreshCategoriesUI, 0);
        };
      }

      // Initial beim Laden (für den Fall, dass renderAll nicht sofort läuft)
      document.addEventListener("DOMContentLoaded", ()=> setTimeout(refreshCategoriesUI, 0));
      // Und einmal jetzt sofort
      setTimeout(refreshCategoriesUI, 50);
    })();
  </script>

</body>
</html>