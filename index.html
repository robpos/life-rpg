<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Life RPG</title>
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background:#f8fafc; color:#0f172a; -webkit-tap-highlight-color:transparent; }
    .tab{display:none;}
    .tab.active{display:block;}
    .btn{border-radius:.75rem; padding:.5rem 1rem; border:1px solid #cbd5e1; background:#fff;}
    .input{width:100%; border-radius:.75rem; border:1px solid #cbd5e1; padding:.5rem .75rem; background:#fff;}
    .card{border:1px solid #e2e8f0; background:#fff; border-radius:1rem; padding:1rem;}
  </style>
</head>
<body>
  <div class="max-w-xl mx-auto min-h-screen flex flex-col">
    <!-- Header -->
    <header class="px-4 pt-6 pb-3 sticky top-0 bg-white/80 backdrop-blur z-10 border-b">
      <div class="flex items-center justify-between">
        <h1 class="text-2xl font-bold flex items-center gap-2">üéÆ Life RPG</h1>
        <span class="text-sm text-slate-500">Basis ¬∑ Migration aktiv</span>
      </div>
    </header>

    <!-- Main -->
    <main class="flex-1 px-4 pb-28 space-y-4">
      <!-- Dashboard -->
      <section id="tab-dashboard" class="tab active space-y-3">
        <div class="grid grid-cols-2 gap-3">
          <div class="card"><div class="text-xs text-slate-500">Gesamtpunkte</div><div id="totalPoints" class="text-3xl font-semibold">0</div></div>
          <div class="card"><div class="text-xs text-slate-500">Level</div><div id="currentLevel" class="text-3xl font-semibold">1</div></div>
          <div class="card"><div class="text-xs text-slate-500">Sparstand (‚Ç¨)</div><div id="savingsTotal" class="text-3xl font-semibold">0,00</div></div>
          <div class="card"><div class="text-xs text-slate-500">Streak (Tage)</div><div id="streakDays" class="text-3xl font-semibold">0</div></div>
        </div>

        <div class="card">
          <div class="font-semibold">Level-Fortschritt</div>
          <div class="w-full bg-slate-200 h-3 rounded mt-2">
            <div id="levelBar" class="h-3 rounded bg-blue-500" style="width:0%"></div>
          </div>
          <div id="levelText" class="text-xs text-slate-600 mt-1"></div>
        </div>

        <div class="card">
          <div class="font-semibold mb-2">Schnell loggen (frei)</div>
          <div class="grid grid-cols-1 gap-2">
            <input id="quickQuest" class="input" placeholder="z. B. 10 Liegest√ºtze" />
            <input id="quickPoints" type="number" class="input" placeholder="Punkte (z. B. 10)" />
            <button id="btnQuickAdd" class="btn bg-blue-600 text-white border-blue-600">+ Eintragen</button>
          </div>
          <div class="text-xs text-slate-500 mt-2">Nur zum Test. Katalog folgt separat.</div>
        </div>
      </section>

      <!-- Log -->
      <section id="tab-log" class="tab space-y-3">
        <div class="card space-y-2">
          <div class="font-semibold">Neuer Eintrag</div>
          <input type="date" id="logDate" class="input" />
          <input type="text" id="logQuest" class="input" placeholder="Questname" />
          <input type="number" id="logPoints" class="input" placeholder="Punkte" />
          <button id="btnAddEntry" class="btn bg-blue-600 text-white border-blue-600">Eintragen</button>
        </div>
        <div class="card">
          <div class="font-semibold mb-2">Eintr√§ge</div>
          <div id="logList" class="divide-y"></div>
        </div>
      </section>

      <!-- Catalog (Platzhalter, kommt in sp√§teren Schritten) -->
      <section id="tab-catalog" class="tab space-y-3">
        <div class="card">
          <div class="font-semibold">Katalog</div>
          <div class="text-sm text-slate-500">Wird im n√§chsten Schritt erg√§nzt. Bestehende Daten bleiben erhalten.</div>
        </div>
      </section>

      <!-- Settings -->
      <section id="tab-settings" class="tab space-y-3">
        <div class="card space-y-2">
          <div class="font-semibold">Einstellungen</div>
          <label class="text-sm">‚Ç¨ pro Punkt
            <input id="sEuro" type="number" step="0.01" class="input" />
          </label>
          <label class="text-sm">Level: Basis-Inkrement
            <input id="sBase" type="number" class="input" />
          </label>
          <label class="text-sm">Level: Wachstum (z. B. 0.10 = +10%)
            <input id="sGrowth" type="number" step="0.01" class="input" />
          </label>
          <label class="text-sm">Tagesziel (Anzahl Eintr√§ge)
            <input id="sDailyGoal" type="number" class="input" />
          </label>
          <div class="flex gap-2 pt-1">
            <button id="btnExport" class="btn">Export</button>
            <button id="btnImport" class="btn">Import</button>
            <input type="file" id="fileImport" class="hidden" accept="application/json" />
            <button id="btnWipe" class="btn bg-red-600 text-white border-red-600">Alles l√∂schen</button>
          </div>
        </div>
        <div class="text-xs text-slate-500 px-1">‚öôÔ∏è Migration ist aktiv ‚Äì alte Daten werden automatisch erg√§nzt, nichts geht verloren.</div>
      </section>

      <!-- Missions (Platzhalter) -->
      <section id="tab-missions" class="tab space-y-3">
        <div class="card">
          <div class="font-semibold">Missionen</div>
          <div class="text-sm text-slate-500">Kommt nach dem Katalog: mehrstufige Aufgabenketten & Freischaltung.</div>
        </div>
      </section>

      <!-- Chat (Platzhalter) -->
      <section id="tab-chat" class="tab space-y-3">
        <div class="card">
          <div class="font-semibold">Chat</div>
          <div class="text-sm text-slate-500">Wird sp√§ter aktiviert (Parsing, Vorschl√§ge, Buttons).</div>
        </div>
      </section>
    </main>

    <!-- Bottom Nav -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t">
      <div class="max-w-xl mx-auto grid grid-cols-5 text-center">
        <button data-tab="dashboard" class="py-3 text-blue-600">Dashboard</button>
        <button data-tab="log" class="py-3">Log</button>
        <button data-tab="catalog" class="py-3">Katalog</button>
        <button data-tab="missions" class="py-3">Missionen</button>
        <button data-tab="settings" class="py-3">Einstellungen</button>
      </div>
    </nav>
  </div>

  <script>
  // =========================================================
  // Life RPG ‚Äî Basis + Migration (Schritt 1)
  // Erweiterungen f√ºgst du IMMER oberhalb des Markers ein:
  // =======>>>>>  // [EXTENSION-POINT] F√úR K√úNFTIGE TEILE  <<<<<=======
  // =========================================================

  // ---------- Storage & Migration ----------
  const SKEY = "lifeRPG_p1"; // Beibehalten, damit bestehende Daten geladen werden

  const defaultState = {
    settings: {
      euro: 0.10,          // ‚Ç¨ pro Punkt
      base: 100,           // Level Basis-Inkrement
      growth: 0.10,        // Level Wachstum pro Stufe
      dailyGoal: 3,        // Tagesziel = mind. X Eintr√§ge/Tag
      streakPerDay: 0.02,  // +2% pro aktiven Tag
      streakMax: 0.20      // max +20%
    },
    catalog: [
      // nur als Start (falls leer) ‚Äì wird nicht doppelt, Migration √ºberschreibt NICHT vorhandene
      { name: "Sport", points: 20, category: "Gesundheit", boss: false },
      { name: "Kein Essen bestellt", points: 10, category: "Gesundheit", boss: false },
      { name: "Aufr√§umen", points: 5, category: "Ordnung", boss: false }
    ],
    rewards: [],
    missions: [],   // wird sp√§ter benutzt
    log: []         // {date, quest, points, base?}
  };

  function deepClone(v){ return JSON.parse(JSON.stringify(v)); }

  function migrate(stIn){
    let st = stIn && typeof stIn === "object" ? deepClone(stIn) : deepClone(defaultState);

    // Settings: fehlende Felder erg√§nzen
    st.settings = Object.assign({}, defaultState.settings, st.settings || {});

    // Arrays absichern
    if (!Array.isArray(st.catalog)) st.catalog = deepClone(defaultState.catalog);
    if (!Array.isArray(st.rewards)) st.rewards = [];
    if (!Array.isArray(st.missions)) st.missions = [];
    if (!Array.isArray(st.log)) st.log = [];

    // Katalogeintr√§ge vereinheitlichen
    st.catalog = st.catalog.map(q => ({
      name: String(q.name || "Unbenannte Quest"),
      points: Number(q.points || 0),
      category: q.category || "Allgemein",
      boss: !!q.boss
    }));

    // Logeintr√§ge vereinheitlichen + reparieren
    st.log = st.log.map(e => {
      const date = (e.date && typeof e.date === "string") ? e.date.slice(0,10) : new Date().toISOString().slice(0,10);
      const quest = String(e.quest || "Unbekannt");
      const points = Number(isFinite(e.points) ? e.points : 0);
      const base = Number(isFinite(e.base) ? e.base : points); // falls alt ohne base
      return { date, quest, points, base };
    });

    return st;
  }

  function load(){
    try{
      const raw = localStorage.getItem(SKEY);
      if(!raw){ 
        const initial = deepClone(defaultState);
        localStorage.setItem(SKEY, JSON.stringify(initial));
        return initial;
      }
      const parsed = JSON.parse(raw);
      return migrate(parsed);
    }catch(e){
      console.warn("Load/Migrate fallback:", e);
      const fallback = deepClone(defaultState);
      localStorage.setItem(SKEY, JSON.stringify(fallback));
      return fallback;
    }
  }

  function save(){
    localStorage.setItem(SKEY, JSON.stringify(state));
  }

  let state = load();

  // ---------- Helpers ----------
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const todayISO = () => new Date().toISOString().slice(0,10);
  const fmt = n => new Intl.NumberFormat("de-DE").format(n);
  const fmtE = n => new Intl.NumberFormat("de-DE",{minimumFractionDigits:2, maximumFractionDigits:2}).format(n);

  function streakDays(){
    // Anzahl an aufeinanderfolgenden Tagen mit >=1 Eintrag (bis inkl. heute)
    const set = new Set(state.log.map(e=>e.date));
    let s = 0; let cursor = todayISO();
    while(set.has(cursor)){
      s++;
      const d = new Date(cursor); d.setDate(d.getDate()-1);
      cursor = d.toISOString().slice(0,10);
    }
    return s;
  }

  function computePoints(base, dateISO){
    // Multiplikator durch Streak
    const s = streakDays();
    const mult = Math.min(state.settings.streakMax, Math.max(0, state.settings.streakPerDay * Math.max(0, s-1)));
    return Math.round(Number(base||0) * (1 + mult));
  }

  function progressiveThresholds(maxLevel, baseInc, growth){
    const thr=[0]; // Level1 ab 0
    for(let lv=2; lv<=maxLevel; lv++){
      const inc = Math.round(baseInc * Math.pow(1+growth, (lv-2))); // Stufe f√ºr √úbergang lv-1 -> lv
      thr[lv-1] = thr[lv-2] + inc;
    }
    return thr; // thr[i] = Mindestpunkte f√ºr Level i+1
  }

  function levelForPoints(totalPts){
    const base = Number(state.settings.base||100);
    const growth = Number(state.settings.growth||0.10);
    const thr = progressiveThresholds(100, base, growth); // bis Level 100
    let lvl = 1;
    for(let i=0;i<thr.length;i++){
      if(totalPts >= thr[i]) lvl = i+1; else break;
    }
    return { lvl, thr };
  }

  function totals(){
    const totalPts = state.log.reduce((s,e)=> s + Number(e.points||0), 0);
    const euro = Number(state.settings.euro||0);
    return { totalPts, savings: totalPts * euro };
  }

  // ---------- Render ----------
  function renderDashboard(){
    const { totalPts, savings } = totals();
    const { lvl, thr } = levelForPoints(totalPts);

    $("#totalPoints").textContent = fmt(totalPts);
    $("#savingsTotal").textContent = fmtE(savings);
    $("#currentLevel").textContent = lvl;
    $("#streakDays").textContent = fmt(streakDays());

    // Progressbar
    const prevThr = thr[lvl-1] || 0;
    const nextThr = thr[lvl] ?? (thr[thr.length-1] + (thr[thr.length-1]-thr[thr.length-2] || 100));
    const have = Math.max(0, totalPts - prevThr);
    const span = Math.max(1, nextThr - prevThr);
    const pct = Math.min(100, Math.round(100*have/span));
    $("#levelBar").style.width = pct + "%";
    $("#levelText").textContent = `Noch ${fmt(Math.max(0, nextThr-totalPts))} Punkte bis Level ${lvl+1}`;
  }

  function renderLog(){
    $("#logDate").value = todayISO();
    const rows = [...state.log].sort((a,b)=> new Date(b.date) - new Date(a.date));
    $("#logList").innerHTML = rows.map(e=>`
      <div class="py-2 flex items-start justify-between">
        <div class="text-sm">
          <div class="font-medium">${e.quest}</div>
          <div class="text-xs text-slate-500">${e.date}</div>
        </div>
        <div class="text-right text-sm font-semibold ${e.points<0?'text-red-600':''}">${e.points<0?'':'+'}${e.points}</div>
      </div>
    `).join("") || `<div class="py-6 text-center text-slate-400">Noch keine Eintr√§ge.</div>`;
  }

  function renderSettings(){
    $("#sEuro").value = state.settings.euro;
    $("#sBase").value = state.settings.base;
    $("#sGrowth").value = state.settings.growth;
    $("#sDailyGoal").value = state.settings.dailyGoal;
  }

  function renderAll(){
    renderDashboard();
    renderLog();
    renderSettings();
  }

  // ---------- Actions ----------
  function addLogEntry(dateISO, questName, basePoints){
    if(!questName) return;
    const pts = computePoints(Number(basePoints||0), dateISO);
    state.log.push({ date: dateISO, quest: questName, points: pts, base: Number(basePoints||pts) });
    save();
    renderAll();
  }

  // Buttons / Events
  $("#btnQuickAdd").addEventListener("click", ()=>{
    const q = $("#quickQuest").value.trim();
    const p = Number($("#quickPoints").value||0);
    if(!q || !p) return;
    addLogEntry(todayISO(), q, p);
    $("#quickQuest").value = "";
    $("#quickPoints").value = "";
  });

  $("#btnAddEntry").addEventListener("click", ()=>{
    const d = $("#logDate").value || todayISO();
    const q = $("#logQuest").value.trim();
    const p = Number($("#logPoints").value||0);
    if(!q || !p) return;
    addLogEntry(d, q, p);
    $("#logQuest").value = ""; $("#logPoints").value = "";
  });

  // Settings
  $("#sEuro").addEventListener("change", ()=>{ state.settings.euro = Number($("#sEuro").value||0); save(); renderAll(); });
  $("#sBase").addEventListener("change", ()=>{ state.settings.base = Number($("#sBase").value||100); save(); renderAll(); });
  $("#sGrowth").addEventListener("change", ()=>{ state.settings.growth = Number($("#sGrowth").value||0.10); save(); renderAll(); });
  $("#sDailyGoal").addEventListener("change", ()=>{ state.settings.dailyGoal = Number($("#sDailyGoal").value||1); save(); renderAll(); });

  // Export / Import / Wipe
  $("#btnExport").addEventListener("click", ()=>{
    const blob = new Blob([JSON.stringify(state,null,2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `life_rpg_backup_${Date.now()}.json`;
    a.click();
  });
  $("#btnImport").addEventListener("click", ()=> $("#fileImport").click() );
  $("#fileImport").addEventListener("change", (e)=>{
    const f = e.target.files?.[0];
    if(!f) return;
    const reader = new FileReader();
    reader.onload = ()=>{
      try{
        const incoming = JSON.parse(reader.result);
        state = migrate(incoming);
        save(); renderAll();
        alert("Import OK");
      }catch(err){
        alert("Import fehlgeschlagen.");
      }
    };
    reader.readAsText(f);
    e.target.value = "";
  });
  $("#btnWipe").addEventListener("click", ()=>{
    if(confirm("Wirklich ALLE Daten l√∂schen?")){
      localStorage.removeItem(SKEY);
      state = load(); // l√§dt default (inkl. Migration-Struktur)
      renderAll();
    }
  });

  // Bottom Nav
  $$(".grid [data-tab]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const tab = btn.getAttribute("data-tab");
      $$(".tab").forEach(t=> t.classList.remove("active"));
      $("#tab-"+tab).classList.add("active");
      $$(".grid [data-tab]").forEach(b=> b.classList.remove("text-blue-600"));
      btn.classList.add("text-blue-600");
      window.scrollTo({top:0, behavior:"smooth"});
    });
  });

  // Initial render
  renderAll();

  // =======>>>>>  // [EXTENSION-POINT] F√úR K√úNFTIGE TEILE  <<<<<=======
  // Ab Schritt 2 werden neue Features genau HIER eingef√ºgt.
  // Ich sage dir dann immer: "F√ºge Part X direkt √úBER dem EXTENSION-POINT ein."
  </script>
</body>
</html>