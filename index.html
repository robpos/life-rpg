<!doctype html>
<html lang="de" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Life RPG</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      color-scheme: light dark;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }
    html,body{ height:100%; }
    body{ background:#f8fafc; color:#0b0f19; }
    .dark body{ background:#0b0f19; color:#fff; }
    .appbar{
      position:sticky; top:0; z-index:20;
      padding-top: calc(12px + var(--safe-top));
      background: rgba(255,255,255,.85);
      backdrop-filter: blur(8px);
      border-bottom:1px solid #e2e8f0;
    }
    .dark .appbar{
      background: rgba(2,6,23,.75);
      border-bottom-color:#1f2937;
    }
    .container{ max-width: 680px; margin:0 auto; }
    .view{ display:none; }
    .view.active{ display:block; }
    .btn{ border:1px solid #cbd5e1; border-radius:12px; padding:.5rem .9rem; background:#fff; color:#0b0f19; }
    .btn:hover{ background:#f1f5f9; }
    .btn-ghost{ border-color:transparent; background:transparent; }
    .btn-danger{ border-color:#fecaca; color:#b91c1c; }
    .dark .btn{ background:#0f172a; color:#fff; border-color:#334155; }
    .dark .btn:hover{ background:#111827; }
    .card{ background:#fff; border:1px solid #e2e8f0; border-radius:14px; }
    .dark .card{ background:#0b1220; border-color:#1f2937; }
    input, select, textarea{
      background:#fff; color:#0b0f19; border:1px solid #cbd5e1; border-radius:12px; padding:.5rem .7rem; width:100%;
    }
    .dark input, .dark select, .dark textarea{
      background:#0f172a; color:#fff; border-color:#334155;
    }
    /* Log Liste in Dark: nicht hell */
    .log-row{ background:#fff; }
    .dark .log-row{ background:#0f172a; color:#fff; }
    .mono{ font-variant-numeric: tabular-nums; }
    .chip{ border-radius:999px; padding:.15rem .5rem; font-size:.75rem; line-height:1; }
    .link{ text-decoration:underline; cursor:pointer; }
  </style>
</head>
<body class="h-full">
  <div id="app" class="min-h-full flex flex-col">
    <!-- Top Bar -->
    <header class="appbar">
      <div class="container px-4 py-3 flex items-center gap-2">
        <button id="btnBack" class="btn btn-ghost px-2" title="Zur√ºck" style="display:none">‚Üê</button>
        <h1 id="title" class="text-xl font-bold">Life RPG</h1>
        <div class="grow"></div>
        <label class="flex items-center gap-2 text-sm">
          üåô
          <input id="toggleDark" type="checkbox">
        </label>
      </div>
    </header>

    <!-- Content -->
    <main class="container flex-1 px-4 pb-6 pt-4">
      <!-- Hauptmen√º -->
      <section id="view-menu" class="view active space-y-2">
        <h2 class="text-lg font-semibold mb-2">Hauptmen√º</h2>
        <div class="grid gap-2">
          <button data-nav="dashboard"  class="btn w-full text-left">üìä Dashboard</button>
          <button data-nav="log"        class="btn w-full text-left">üìù Log</button>
          <button data-nav="catalog"    class="btn w-full text-left">üìö Katalog</button>
          <button data-nav="categories" class="btn w-full text-left">üè∑Ô∏è Kategorien</button>
          <button data-nav="missions"   class="btn w-full text-left">üó∫Ô∏è Missionen</button>
          <button data-nav="specials"   class="btn w-full text-left">‚è≥ Sonderaufgaben</button>
          <button data-nav="milestones" class="btn w-full text-left">üéØ Meilensteine</button>
          <button data-nav="continuity" class="btn w-full text-left">üîÅ Kontinuit√§t</button>
          <button data-nav="settings"   class="btn w-full text-left">‚öôÔ∏è Einstellungen & Backup</button>
        </div>
      </section>

      <!-- Dashboard -->
      <section id="view-dashboard" class="view space-y-4">
        <div class="grid gap-2">
          <div class="card p-3">
            <div class="grid grid-cols-3 gap-2 text-center">
              <div>
                <div class="text-sm text-slate-500 dark:text-slate-300">Punkte</div>
                <div id="dTotal" class="text-2xl font-bold mono text-black dark:text-white">0</div>
              </div>
              <div>
                <div class="text-sm text-slate-500 dark:text-slate-300">Level</div>
                <div id="dLevel" class="text-2xl font-bold mono text-black dark:text-white">1</div>
              </div>
              <div>
                <div class="text-sm text-slate-500 dark:text-slate-300">Sparstand (‚Ç¨)</div>
                <div id="dSavings" class="text-2xl font-bold mono text-black dark:text-white">0.00</div>
              </div>
            </div>
          </div>

          <div class="card p-3">
            <div class="font-semibold mb-2">Level-Fortschritt</div>
            <div class="w-full bg-slate-200 dark:bg-slate-700 rounded h-3">
              <div id="dProgressBar" class="h-3 rounded bg-blue-600" style="width:0%"></div>
            </div>
            <div id="dProgressText" class="text-xs mt-1"></div>
          </div>

          <div class="card p-3">
            <div class="font-semibold mb-2">Heute offen</div>
            <div id="dToday" class="flex flex-wrap gap-2"></div>
          </div>

          <div class="card p-3">
            <div class="font-semibold mb-2">Meilenstein (n√§chster)</div>
            <div id="dMilestone">‚Äì</div>
          </div>
        </div>
      </section>

      <!-- Log -->
      <section id="view-log" class="view space-y-3">
        <div class="card p-3 space-y-2">
          <div class="grid md:grid-cols-4 gap-2">
            <input type="date" id="logDate">
            <select id="logQuest"></select>
            <input type="number" id="logPoints" placeholder="Punkte (optional)">
            <button id="btnLogAdd" class="btn">Eintragen</button>
          </div>
          <div id="quickRow" class="flex flex-wrap gap-2"></div>
        </div>
        <div id="logList" class="space-y-2"></div>
      </section>

      <!-- Katalog -->
      <section id="view-catalog" class="view space-y-3">
        <div class="card p-3 space-y-2">
          <div class="grid md:grid-cols-4 gap-2">
            <input id="qName" placeholder="Questname">
            <input id="qPoints" type="number" placeholder="Punkte">
            <select id="qBoss">
              <option value="false">Normale Quest</option>
              <option value="true">Bossquest</option>
            </select>
            <button id="btnAddQuest" class="btn">Zur Liste hinzuf√ºgen</button>
          </div>
          <div class="space-y-2">
            <div class="font-semibold">Kategorien & Multiplikatoren</div>
            <div id="catAssignRows" class="space-y-2"></div>
            <button id="btnAddCatRow" class="btn text-xs">+ Kategorie</button>
          </div>
          <div class="grid md:grid-cols-3 gap-2">
            <input id="qPenaltyDays" type="number" placeholder="Inaktivit√§ts-Tage (optional)">
            <input id="qPenaltyPts" type="number" placeholder="Strafpunkte (optional)">
          </div>
        </div>
        <div id="catalogList" class="space-y-2"></div>
      </section>

      <!-- Kategorien -->
      <section id="view-categories" class="view space-y-3">
        <div class="card p-3 space-y-2">
          <div class="grid md:grid-cols-4 gap-2">
            <input id="catName" placeholder="Name">
            <select id="catType">
              <option value="positive">Positiv</option>
              <option value="negative">Negativ</option>
            </select>
            <input id="catColor" type="color" value="#0ea5e9">
            <button id="btnAddCategory" class="btn">Kategorie anlegen</button>
          </div>
        </div>
        <div id="catList" class="space-y-2"></div>
      </section>

      <!-- Missionen -->
      <section id="view-missions" class="view space-y-3">
        <div class="card p-3 space-y-2">
          <div class="grid md:grid-cols-4 gap-2">
            <input id="mName" placeholder="Missionsname">
            <input id="mTaskName" placeholder="Aufgabe 1 Name">
            <input id="mTaskPts" type="number" placeholder="Punkte">
            <button id="btnAddMission" class="btn">Mission anlegen</button>
          </div>
        </div>
        <div id="missionList" class="space-y-2"></div>
      </section>

      <!-- Sonderaufgaben -->
      <section id="view-specials" class="view space-y-3">
        <div class="card p-3 space-y-2">
          <div class="grid md:grid-cols-4 gap-2">
            <input id="sName" placeholder="Sonderaufgabe (z. B. Blumen gie√üen)">
            <input id="sPoints" type="number" placeholder="Punkte">
            <input id="sCooldown" type="number" placeholder="Cooldown (Tage)">
            <button id="btnAddSpecial" class="btn">Hinzuf√ºgen</button>
          </div>
        </div>
        <div id="specialList" class="space-y-2"></div>
      </section>

      <!-- Meilensteine -->
      <section id="view-milestones" class="view space-y-3">
        <div id="msNext" class="card p-3"></div>
        <div id="msCategories" class="card p-3"></div>
      </section>

      <!-- Kontinuit√§t -->
      <section id="view-continuity" class="view space-y-3">
        <div id="contList" class="space-y-2"></div>
      </section>

      <!-- Einstellungen -->
      <section id="view-settings" class="view space-y-3">
        <div class="card p-3 grid md:grid-cols-3 gap-2">
          <label class="text-sm">‚Ç¨ pro Punkt
            <input id="sEuro" type="number" step="0.01">
          </label>
          <label class="text-sm">Basis-Inkrement
            <input id="sBase" type="number">
          </label>
          <label class="text-sm">Wachstum (z. B. 0.1)
            <input id="sGrowth" type="number" step="0.01">
          </label>
        </div>
        <div class="card p-3 grid md:grid-cols-4 gap-2">
          <button id="btnExport" class="btn">Export</button>
          <input type="file" id="fileImport" accept="application/json" class="hidden">
          <button id="btnImport" class="btn">Import</button>
          <button id="btnResetAll" class="btn btn-danger">Alles l√∂schen</button>
        </div>
      </section>
    </main>

    <!-- Bottom Safe-Area -->
    <div style="height: var(--safe-bottom)"></div>
  </div>

  <script>
  // ------------- State & Migration -------------
  const SKEY = "lifeRPG_p1";         // alter Key (deine Daten)
  const SKEY_V2 = "lifeRPG_v2";      // neuer Key (strukturierter)
  let state = load();

  function load(){
    let v2 = null; try{ v2 = JSON.parse(localStorage.getItem(SKEY_V2)||"null"); }catch{}
    if(v2) return v2;

    // Alte Daten √ºbernehmen, falls vorhanden
    let old = null; try{ old = JSON.parse(localStorage.getItem(SKEY)||"null"); }catch{}
    const base = {
      settings: { euro:0.1, base:100, growth:0.1, dark:false },
      log: [],
      catalog: [],
      categories: [],
      missions: [],
      specials: [],
      milestones: { series:{} },
      continuity: { lastPenaltyCheck: null }
    };
    if(old){
      base.log = Array.isArray(old.log)? old.log : [];
      base.catalog = Array.isArray(old.catalog)? old.catalog : [];
      base.settings = { ...base.settings, ...(old.settings||{}) };
    }
    // Mindest-Kategorien
    if(!base.categories || base.categories.length===0){
      base.categories = [
        {id:"cat_sonstige", name:"Sonstige", type:"positive", color:"#64748b"},
        {id:"cat_sport", name:"Sport", type:"positive", color:"#0ea5e9"},
        {id:"cat_haus", name:"Handwerk", type:"positive", color:"#f59e0b"},
        {id:"cat_bad", name:"Schlechter Lebensstil", type:"negative", color:"#ef4444"}
      ];
    }
    // Katalog-Eintr√§ge mit categories-Feld versehen
    base.catalog.forEach(q=>{ q.categories = q.categories || []; });
    save(base);
    return base;
  }

  function save(s=state){
    localStorage.setItem(SKEY_V2, JSON.stringify(s));
  }

  // ------------- Helpers -------------
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const todayISO = () => new Date().toISOString().slice(0,10);
  const sum = a => a.reduce((s,x)=>s+x,0);
  function totalPoints(){ return state.log.reduce((s,e)=>s+e.points,0); }
  function levelForPoints(p){
    let lvl=1, need=state.settings.base||100, growth=state.settings.growth||0.1;
    let remaining = p;
    while(remaining>=need){ lvl++; remaining-=need; need=Math.round(need*(1+growth)); }
    return {lvl, remaining, need};
  }
  function ensureDarkMode(){
    const dark = !!state.settings.dark;
    document.documentElement.classList.toggle("dark", dark);
    $("#toggleDark").checked = dark;
  }

  // ------------- Navigation -------------
  let navStack = ["menu"];
  function show(view){
    $$(".view").forEach(v=>v.classList.remove("active"));
    $("#view-"+view).classList.add("active");
    $("#title").textContent = view==="menu" ? "Life RPG" : ({
      dashboard:"Dashboard", log:"Log", catalog:"Katalog", categories:"Kategorien",
      missions:"Missionen", specials:"Sonderaufgaben", milestones:"Meilensteine",
      continuity:"Kontinuit√§t", settings:"Einstellungen & Backup"
    }[view]||"Life RPG");
    $("#btnBack").style.display = view==="menu" ? "none":"inline-flex";
  }
  function navTo(view){
    if(navStack[navStack.length-1]!==view) navStack.push(view);
    show(view); renderAll();
  }
  $("#btnBack").onclick = ()=>{
    if(navStack.length>1) navStack.pop();
    show(navStack[navStack.length-1]);
  };
  $$("#view-menu [data-nav]").forEach(b=> b.onclick = ()=> navTo(b.getAttribute("data-nav")));

  // ------------- Dashboard Render -------------
  function renderDashboard(){
    const p = totalPoints();
    const L = levelForPoints(p);
    $("#dTotal").textContent = p;
    $("#dLevel").textContent = L.lvl;
    $("#dSavings").textContent = (p*(state.settings.euro||0.1)).toFixed(2);
    const pct = Math.min(100, Math.round((L.remaining / L.need) * 100));
    $("#dProgressBar").style.width = pct+"%";
    $("#dProgressText").textContent = `Noch ${L.need - L.remaining} Punkte bis Level ${L.lvl+1}`;

    // Heute offen (erste 5 nicht erledigte aus Katalog)
    const today = todayISO();
    const doneToday = new Set(state.log.filter(e=>e.date===today).map(e=>e.quest));
    const open = state.catalog.filter(q=>!doneToday.has(q.name)).slice(0,5);
    const box = $("#dToday"); box.innerHTML="";
    open.forEach(q=>{
      const btn = document.createElement("button");
      btn.className="btn text-xs";
      btn.textContent = `+ ${q.name} (+${q.points})`;
      btn.onclick = ()=> addLogEntry(today, q.name, q.points);
      box.appendChild(btn);
    });

    // N√§chster Meilenstein (global: Quests erledigt)
    const m = computeNextMilestoneSummary();
    $("#dMilestone").textContent = m || "‚Äì";
  }

  // ------------- Log -------------
  function rebuildQuestSelect(){
    const sel = $("#logQuest"); sel.innerHTML="";
    state.catalog.forEach(q=>{
      const o=document.createElement("option");
      o.value=q.name; o.textContent = q.boss?`üëë ${q.name}`:q.name;
      sel.appendChild(o);
    });
  }
  function renderQuickRow(){
    const row=$("#quickRow"); row.innerHTML="";
    state.catalog.slice(0,10).forEach(q=>{
      const b=document.createElement("button");
      b.className="btn text-xs";
      b.textContent = `‚ûï ${q.name}`;
      b.onclick = ()=> addLogEntry(todayISO(), q.name, q.points);
      row.appendChild(b);
    });
  }
  function renderLog(){
    $("#logDate").value = todayISO();
    rebuildQuestSelect();
    renderQuickRow();
    const list=$("#logList"); list.innerHTML="";
    if(state.log.length===0){
      list.innerHTML = `<div class="text-slate-500 dark:text-slate-300">Noch keine Eintr√§ge.</div>`;
      return;
    }
    state.log.slice().reverse().forEach((e,idx)=>{
      const i = state.log.length-1-idx;
      const row=document.createElement("div");
      row.className="log-row p-2 border rounded card flex items-center justify-between";
      row.innerHTML = `
        <div>${e.date} ‚Ä¢ ${e.quest} <span class="mono ${e.points>=0?'text-green-600':'text-red-600'}">(${e.points>=0?'+':''}${e.points})</span></div>
        <div class="flex gap-2">
          <button class="btn text-xs" data-del="${i}">L√∂schen</button>
        </div>
      `;
      list.appendChild(row);
    });
    list.querySelectorAll("[data-del]").forEach(b=>{
      b.onclick=()=>{
        const i=Number(b.getAttribute("data-del"));
        if(confirm("Diesen Log-Eintrag l√∂schen?")){
          state.log.splice(i,1); save(); renderAll();
        }
      };
    });
  }
  function addLogEntry(date, name, basePoints){
    // Negative Kategorie macht Punkte negativ? -> hier vereinfachen: negative Kategorien z√§hlen positiv zur Kategorie-Summe,
    // aber global ziehen sie Punkte ab (Faktor 2 auf Wunsch einstellbar).
    const q = state.catalog.find(x=>x.name===name);
    let pts = Number($("#logPoints").value||basePoints||q?.points||0);
    if(!pts) return;
    const hasNegative = (q?.categories||[]).some(ac=>{
      const cat = state.categories.find(c=>c.id===ac.id);
      return cat && cat.type==="negative";
    });
    const negFactor = 2; // kannst du sp√§ter konfigurierbar machen
    if(hasNegative) pts = -Math.abs(pts*negFactor);

    state.log.push({date, quest:name, points: Math.round(pts), base: basePoints||q?.points||pts});
    save(); renderAll();
    $("#logPoints").value="";
  }
  $("#btnLogAdd").onclick = ()=>{
    const d=$("#logDate").value||todayISO();
    const name=$("#logQuest").value;
    const pts=$("#logPoints").value ? Number($("#logPoints").value) : undefined;
    addLogEntry(d,name,pts);
  };

  // ------------- Katalog -------------
  function addCatAssignRow(pre=null){
    const row=document.createElement("div");
    row.className="grid md:grid-cols-3 gap-2 items-center";
    const opts = state.categories.map(c=>`<option value="${c.id}">${c.name}${c.type==="negative"?" (negativ)":""}</option>`).join("");
    row.innerHTML = `
      <select class="input catSel">${opts}</select>
      <input type="number" step="0.01" class="input catMult" placeholder="Multiplikator (z. B. 1.2)" value="${pre?.mult??1}">
      <button class="btn btn-danger text-xs catDel">Entfernen</button>
    `;
    $("#catAssignRows").appendChild(row);
    if(pre?.id) row.querySelector(".catSel").value = pre.id;
    row.querySelector(".catDel").onclick = ()=> row.remove();
  }
  $("#btnAddCatRow").onclick = ()=> addCatAssignRow();

  function renderCatalog(){
    const list=$("#catalogList"); list.innerHTML="";
    if(state.catalog.length===0){
      list.innerHTML=`<div class="text-slate-500 dark:text-slate-300">Noch keine Quests im Katalog.</div>`;
      return;
    }
    state.catalog.forEach((q,idx)=>{
      const row=document.createElement("div");
      row.className="card p-2";
      const chips = (q.categories||[]).map(ac=>{
        const c = state.categories.find(x=>x.id===ac.id);
        const bg = c?.color||"#64748b";
        return `<span class="chip" style="background:${bg};color:#fff">${c?c.name:"?"}√ó${ac.mult||1}</span>`;
      }).join(" ") || `<span class="chip" style="background:#64748b;color:#fff">Sonstige</span>`;
      row.innerHTML = `
        <div class="flex items-center justify-between">
          <div class="font-medium">${q.boss?"üëë ":""}${q.name} <span class="text-slate-500 dark:text-slate-300">(+${q.points})</span></div>
          <div class="flex gap-2">
            <button class="btn text-xs" data-edit="${idx}">Bearb.</button>
            <button class="btn btn-danger text-xs" data-del="${idx}">L√∂schen</button>
          </div>
        </div>
        <div class="mt-1 flex flex-wrap gap-1">${chips}</div>
        ${(q.penaltyDays&&q.penaltyPoints)?`<div class="text-xs mt-1">Inaktivit√§t: ${q.penaltyDays} Tage ‚Üí ‚àí${q.penaltyPoints} Punkte</div>`:""}
      `;
      list.appendChild(row);
    });
    list.querySelectorAll("[data-del]").forEach(b=>{
      b.onclick=()=>{
        const i=Number(b.getAttribute("data-del"));
        if(confirm("Quest aus Katalog l√∂schen?")){
          state.catalog.splice(i,1); save(); renderAll();
        }
      }
    });
    list.querySelectorAll("[data-edit]").forEach(b=>{
      b.onclick=()=>{
        const i=Number(b.getAttribute("data-edit"));
        const q=state.catalog[i]; if(!q) return;
        // einfache Inline-Bearbeitung (Prompt), Fokus auf Kernfelder
        const name = prompt("Name:", q.name)||q.name;
        const pts  = Number(prompt("Punkte:", q.points)||q.points);
        const boss = (prompt("Bossquest? (ja/nein)", q.boss?"ja":"nein")||"nein").toLowerCase().startsWith("j");
        q.name=name; q.points=pts; q.boss=boss;
        save(); renderAll();
      };
    });
  }

  $("#btnAddQuest").onclick = ()=>{
    const name=$("#qName").value.trim();
    const points=Number($("#qPoints").value||0);
    const boss=$("#qBoss").value==="true";
    if(!name||!points) return alert("Name & Punkte angeben");

    const assigns = $$("#catAssignRows .grid").map(r=>{
      const id = r.querySelector(".catSel").value;
      const mult= Number(r.querySelector(".catMult").value||1);
      return {id, mult: mult||1};
    });
    const penaltyDays = Number($("#qPenaltyDays").value||0)||null;
    const penaltyPoints = Number($("#qPenaltyPts").value||0)||null;

    state.catalog.push({name, points, boss, categories:assigns, penaltyDays, penaltyPoints});
    save();
    $("#qName").value=""; $("#qPoints").value=""; $("#qPenaltyDays").value=""; $("#qPenaltyPts").value="";
    $("#catAssignRows").innerHTML=""; addCatAssignRow(); renderAll();
  };

  // ------------- Kategorien -------------
  function renderCategories(){
    const list=$("#catList"); list.innerHTML="";
    state.categories.forEach((c,idx)=>{
      const row=document.createElement("div");
      row.className="card p-2 flex items-center justify-between";
      row.innerHTML=`
        <div class="flex items-center gap-2">
          <span class="inline-block w-3 h-3 rounded" style="background:${c.color}"></span>
          <div>${c.name} ${c.type==="negative"?"<span class='text-xs text-red-600'>(negativ)</span>":""}</div>
        </div>
        <div class="flex gap-2">
          <button class="btn text-xs" data-edit="${idx}">Bearb.</button>
          ${c.id==="cat_sonstige"?"":`<button class="btn btn-danger text-xs" data-del="${idx}">L√∂schen</button>`}
        </div>
      `;
      list.appendChild(row);
    });
    list.querySelectorAll("[data-del]").forEach(b=>{
      b.onclick=()=>{
        const i=Number(b.getAttribute("data-del"));
        if(state.categories[i].id==="cat_sonstige") return;
        if(confirm("Kategorie l√∂schen? Zuweisungen in Quests werden entfernt.")){
          const id=state.categories[i].id;
          state.categories.splice(i,1);
          state.catalog.forEach(q=> q.categories=(q.categories||[]).filter(ac=>ac.id!==id));
          save(); renderAll();
        }
      }
    });
    list.querySelectorAll("[data-edit]").forEach(b=>{
      b.onclick=()=>{
        const i=Number(b.getAttribute("data-edit"));
        const c=state.categories[i];
        const name=prompt("Name:", c.name)||c.name;
        const type=(prompt("Typ (positive/negative):", c.type)||c.type).toLowerCase().startsWith("neg")?"negative":"positive";
        const color=prompt("Farbe (#rrggbb):", c.color)||c.color;
        c.name=name; c.type=type; c.color=color; save(); renderAll();
      }
    });
  }
  $("#btnAddCategory").onclick=()=>{
    const name=$("#catName").value.trim(); if(!name) return;
    const type=$("#catType").value;
    const color=$("#catColor").value||"#0ea5e9";
    const id="cat_"+Math.random().toString(36).slice(2,8);
    state.categories.push({id,name,type,color});
    save(); $("#catName").value=""; renderAll();
  };

  // ------------- Missionen -------------
  function renderMissions(){
    const list=$("#missionList"); list.innerHTML="";
    if(state.missions.length===0){
      list.innerHTML=`<div class="text-slate-500 dark:text-slate-300">Noch keine Missionen.</div>`;
      return;
    }
    state.missions.forEach((m,mi)=>{
      const all = m.tasks;
      const done = all.filter(t=>t.done).length;
      const total = all.length;
      const unlocked = all.filter(t=> (t.requires||[]).every(r=> all[r]?.done));
      const row=document.createElement("div");
      row.className="card p-2";
      row.innerHTML=`
        <div class="flex items-center justify-between">
          <div class="font-medium">${m.name} <span class="text-xs">(${done}/${total})</span></div>
          <div class="flex gap-2">
            <button class="btn text-xs" data-addtask="${mi}">+ Aufgabe</button>
            <button class="btn btn-danger text-xs" data-delm="${mi}">L√∂schen</button>
          </div>
        </div>
        <div class="mt-2 space-y-1" id="mt_${mi}"></div>
      `;
      const box=row.querySelector("#mt_"+mi);
      all.forEach((t,ti)=>{
        const lock = (t.requires||[]).some(r=> !all[r]?.done);
        const line=document.createElement("div");
        line.className="flex items-center justify-between p-2 border rounded";
        line.innerHTML=`
          <div>${lock?"üîí":"‚úÖ"} ${t.name} <span class="text-slate-500 dark:text-slate-300">(+${t.points})</span></div>
          <div class="flex gap-2">
            ${!t.done && !lock ? `<button class="btn text-xs" data-donet="${mi}:${ti}">Erledigt</button>`:""}
            <button class="btn btn-danger text-xs" data-delt="${mi}:${ti}">L√∂schen</button>
          </div>
        `;
        box.appendChild(line);
      });
      list.appendChild(row);
    });
    // Events
    list.querySelectorAll("[data-addtask]").forEach(b=>{
      b.onclick=()=>{
        const mi=Number(b.getAttribute("data-addtask"));
        const name=prompt("Aufgabenname?"); if(!name) return;
        const pts=Number(prompt("Punkte?", "10")||10);
        // optional: als Voraussetzung letzte Aufgabe?
        const requires = state.missions[mi].tasks.length>0 ? [state.missions[mi].tasks.length-1] : [];
        state.missions[mi].tasks.push({name,points:pts,requires,done:false});
        save(); renderAll();
      };
    });
    list.querySelectorAll("[data-delt]").forEach(b=>{
      b.onclick=()=>{
        const [mi,ti]=b.getAttribute("data-delt").split(":").map(Number);
        state.missions[mi].tasks.splice(ti,1);
        save(); renderAll();
      };
    });
    list.querySelectorAll("[data-delm]").forEach(b=>{
      b.onclick=()=>{
        const mi=Number(b.getAttribute("data-delm"));
        if(confirm("Mission l√∂schen?")){ state.missions.splice(mi,1); save(); renderAll(); }
      };
    });
    list.querySelectorAll("[data-donet]").forEach(b=>{
      b.onclick=()=>{
        const [mi,ti]=b.getAttribute("data-donet").split(":").map(Number);
        const m=state.missions[mi], t=m.tasks[ti];
        t.done=true; save();
        // Wenn Mission komplett -> Bonus (4√ó Summe)
        if(m.tasks.every(x=>x.done) && !m.bonusGranted){
          const sumPts = m.tasks.reduce((s,x)=>s+x.points,0);
          const bonus = sumPts*4;
          state.log.push({date:todayISO(),quest:`Mission abgeschlossen: ${m.name}`,points:bonus,base:bonus});
          m.bonusGranted=true; save();
          alert(`Mission abgeschlossen! Bonus +${bonus} Punkte`);
        }
        renderAll();
      };
    });
  }
  $("#btnAddMission").onclick=()=>{
    const mName=$("#mName").value.trim(); if(!mName) return;
    const tName=$("#mTaskName").value.trim(); if(!tName) return;
    const pts=Number($("#mTaskPts").value||0); if(!pts) return;
    state.missions.push({name:mName, bonusGranted:false, tasks:[{name:tName,points:pts,requires:[],done:false}]});
    save(); $("#mName").value=""; $("#mTaskName").value=""; $("#mTaskPts").value="";
    renderAll();
  };

  // ------------- Sonderaufgaben -------------
  function renderSpecials(){
    const list=$("#specialList"); list.innerHTML="";
    if(state.specials.length===0){
      list.innerHTML=`<div class="text-slate-500 dark:text-slate-300">Noch keine Sonderaufgaben.</div>`;
      return;
    }
    state.specials.forEach((s,idx)=>{
      const next = s.lastDone ? addDaysISO(s.lastDone, s.cooldown) : null;
      const available = !next || todayISO()>=next;
      const row=document.createElement("div");
      row.className="card p-2 flex items-center justify-between";
      row.innerHTML=`
        <div>${available?"üü¢":"‚õîÔ∏è"} ${s.name} <span class="text-slate-500 dark:text-slate-300">(+${s.points})</span>
          ${available?"":`<span class="text-xs ml-2">verf√ºgbar ab ${next}</span>`}
        </div>
        <div class="flex gap-2">
          ${available?`<button class="btn text-xs" data-dos="${idx}">Erledigt</button>`:""}
          <button class="btn btn-danger text-xs" data-dels="${idx}">L√∂schen</button>
        </div>
      `;
      list.appendChild(row);
    });
    list.querySelectorAll("[data-dos]").forEach(b=>{
      b.onclick=()=>{
        const i=Number(b.getAttribute("data-dos"));
        const s=state.specials[i];
        s.lastDone = todayISO();
        state.log.push({date:s.lastDone, quest:`Sonderaufgabe: ${s.name}`, points:s.points, base:s.points});
        save(); renderAll();
      };
    });
    list.querySelectorAll("[data-dels]").forEach(b=>{
      b.onclick=()=>{
        const i=Number(b.getAttribute("data-dels"));
        if(confirm("Sonderaufgabe l√∂schen?")){ state.specials.splice(i,1); save(); renderAll(); }
      };
    });
  }
  $("#btnAddSpecial").onclick=()=>{
    const name=$("#sName").value.trim();
    const points=Number($("#sPoints").value||0);
    const cooldown=Number($("#sCooldown").value||0);
    if(!name||!points||!cooldown) return alert("Name, Punkte, Cooldown angeben");
    state.specials.push({name, points, cooldown, lastDone:null});
    save(); $("#sName").value=""; $("#sPoints").value=""; $("#sCooldown").value="";
    renderAll();
  };
  function addDaysISO(iso, d){
    const dt=new Date(iso); dt.setDate(dt.getDate()+d); return dt.toISOString().slice(0,10);
    }

  // ------------- Meilensteine -------------
  function nextThresholdSeries(seriesName, current){
    // Sequenzen und Belohnungen nach Vorgaben
    // Quests: 100, 200, 500, 1000, 2500...
    // Bossquests: 10, 20, 50, 100, 250...
    // Missionen: 5, 10, 20, 50, 100...
    const map = {
      quests:   [100, 200, 500, 1000, 2500, 5000, 10000],
      boss:     [10, 20, 50, 100, 250, 500, 1000],
      missions: [5, 10, 20, 50, 100, 250, 500]
    };
    const rw  = [100, 400, 2500, 5000, 15000, 40000, 100000]; // Beispiel-Rewards steigend
    const seq = map[seriesName]||[100,200,500];
    for(let i=0;i<seq.length;i++){
      if(current < seq[i]) return {target:seq[i], reward:rw[i]||100};
    }
    // √ºber die Liste hinaus ‚Üí skaliere weiter (√ó2)
    const last = seq[seq.length-1];
    let t = last;
    let i = seq.length-1;
    while(current >= t){ t = Math.round(t*2); i++; }
    return {target:t, reward: rw[rw.length-1]||1000 };
  }

  function computeCounts(){
    const today = todayISO();
    const countQuests = state.log.filter(e=> e.points>0 && !String(e.quest).toLowerCase().includes("reward-kauf")).length;
    const countBoss   = state.log.filter(e=>{
      const q=state.catalog.find(x=>x.name===e.quest); return q?.boss && e.points>0;
    }).length;
    const countMissions = state.missions.filter(m=> m.tasks.length>0 && m.tasks.every(t=>t.done)).length;
    return {countQuests, countBoss, countMissions};
  }

  function computeNextMilestoneSummary(){
    const c = computeCounts();
    const nq = nextThresholdSeries("quests", c.countQuests);
    const nb = nextThresholdSeries("boss",   c.countBoss);
    const nm = nextThresholdSeries("missions", c.countMissions);
    return `Quests: ${c.countQuests}/${nq.target} (Reward ${nq.reward}) ‚Ä¢ Boss: ${c.countBoss}/${nb.target} ‚Ä¢ Missionen: ${c.countMissions}/${nm.target}`;
  }

  function renderMilestones(){
    // Global-Block
    const c = computeCounts();
    const nq = nextThresholdSeries("quests", c.countQuests);
    const nb = nextThresholdSeries("boss",   c.countBoss);
    const nm = nextThresholdSeries("missions", c.countMissions);
    $("#msNext").innerHTML = `
      <div class="font-semibold mb-2">N√§chste Meilensteine</div>
      <div>üß© Quests: ${c.countQuests}/${nq.target} ‚Äî Bonus: +${nq.reward}</div>
      <div>üëë Bossquests: ${c.countBoss}/${nb.target} ‚Äî Bonus: +${nb.reward}</div>
      <div>üó∫Ô∏è Missionen: ${c.countMissions}/${nm.target} ‚Äî Bonus: +${nm.reward}</div>
    `;
    // Kategorie-Meilensteine (nur der n√§chste pro Kategorie)
    const sums = categoryTotals();
    const rows = state.categories.map(cat=>{
      const base = sums[cat.id]||0;
      // einfache Skalierung: 500, 1000, 2500, 5000...
      const ladder = [500,1000,2500,5000,10000];
      let target = ladder.find(t=> base < t) || Math.ceil(base*2);
      let reward = Math.round(target*0.1); // 10% als Beispiel
      return `<div class="flex items-center justify-between">
        <button class="link" data-cdetail="${cat.id}">${cat.name}</button>
        <div class="text-sm">Punkte: ${(base).toFixed(0)} / ${target} ‚Äî Bonus: +${reward}</div>
      </div>`;
    }).join("");
    $("#msCategories").innerHTML = `
      <div class="font-semibold mb-2">Kategorien</div>
      ${rows}
    `;
    $("#msCategories").querySelectorAll("[data-cdetail]").forEach(b=>{
      b.onclick = ()=> openCategoryDetail(b.getAttribute("data-cdetail"));
    });
  }

  function categoryTotals(){
    const sums={};
    state.categories.forEach(c=> sums[c.id]=0);
    state.log.forEach(e=>{
      const q=state.catalog.find(x=>x.name===e.quest);
      const base = (typeof e.base==="number") ? e.base : (q?.points||e.points||0);
      if(q && (q.categories||[]).length){
        q.categories.forEach(ac=> sums[ac.id]+= Math.max(0, base*(ac.mult||1)));
      }else{
        sums["cat_sonstige"] += Math.max(0, base);
      }
    });
    return sums;
  }

  function openCategoryDetail(catId){
    const cat = state.categories.find(c=>c.id===catId);
    const sums= categoryTotals();
    const box=document.createElement("div");
    box.className="fixed inset-0 z-50 flex items-center justify-center";
    box.innerHTML=`
      <div class="absolute inset-0 bg-black/40"></div>
      <div class="relative card p-4 w-[90%] max-w-xl">
        <div class="flex items-center justify-between mb-2">
          <div class="font-semibold">${cat?.name||"Kategorie"}</div>
          <button class="btn text-xs" id="cClose">Schlie√üen</button>
        </div>
        <div class="text-sm mb-2">Punkte gesamt: ${(sums[catId]||0).toFixed(0)}</div>
        <div class="space-y-1" id="cRows"></div>
      </div>
    `;
    document.body.appendChild(box);
    $("#cClose").onclick=()=>box.remove();
    const rows = $("#cRows");
    const quests = state.catalog.filter(q=> (q.categories||[]).some(ac=>ac.id===catId));
    if(quests.length===0){
      rows.innerHTML=`<div class="text-slate-500 dark:text-slate-300">Keine Quests in dieser Kategorie.</div>`;
      return;
    }
    quests.forEach(q=>{
      const mult = (q.categories||[]).find(ac=>ac.id===catId)?.mult || 1;
      const line=document.createElement("div");
      line.className="p-2 border rounded";
      line.textContent = `${q.name} √ó${mult}`;
      rows.appendChild(line);
    });
  }

  // ------------- Kontinuit√§t & Inaktivit√§t -------------
  function applyOverduePenalties(){
    const lastCheck = state.continuity.lastPenaltyCheck || "1970-01-01";
    const today = todayISO();
    if(today===lastCheck) return;

    // f√ºr jede Quest mit penaltyDays/penaltyPoints pr√ºfen
    const byQuest = groupLastDoneDates();
    state.catalog.forEach(q=>{
      if(!q.penaltyDays || !q.penaltyPoints) return;
      const last = byQuest[q.name] || "1970-01-01";
      const days = daysBetween(last, today);
      if(days>=q.penaltyDays){
        state.log.push({date:today, quest:`Inaktivit√§t: ${q.name}`, points: -Math.abs(q.penaltyPoints), base:0});
      }
    });
    state.continuity.lastPenaltyCheck = today;
    save();
  }
  function groupLastDoneDates(){
    const map={};
    state.log.forEach(e=>{
      if(!map[e.quest] || map[e.quest] < e.date) map[e.quest]=e.date;
    });
    return map;
  }
  function daysBetween(isoA, isoB){
    const a = new Date(isoA+"T00:00:00Z").getTime();
    const b = new Date(isoB+"T00:00:00Z").getTime();
    return Math.round((b-a)/(1000*60*60*24));
  }
  function renderContinuity(){
    const list=$("#contList"); list.innerHTML="";
    const last = groupLastDoneDates();
    const items = state.catalog.filter(q=> q.penaltyDays && q.penaltyPoints);
    if(items.length===0){
      list.innerHTML=`<div class="text-slate-500 dark:text-slate-300">Keine Aufgaben mit Inaktivit√§ts-Watch.</div>`;
      return;
    }
    items.forEach(q=>{
      const l = last[q.name] || "‚Äî";
      const left = q.penaltyDays ? Math.max(0, q.penaltyDays - daysBetween(l||todayISO(), todayISO())) : "‚Äì";
      const row=document.createElement("div");
      row.className="card p-2 flex items-center justify-between";
      row.innerHTML=`
        <div><b>${q.name}</b> ‚Ä¢ letzte Aktivit√§t: ${l} ‚Ä¢ noch ${left} Tage</div>
        <button class="btn text-xs" data-do="${q.name}">Jetzt erledigt</button>
      `;
      list.appendChild(row);
    });
    list.querySelectorAll("[data-do]").forEach(b=>{
      b.onclick=()=>{
        const n=b.getAttribute("data-do");
        const q=state.catalog.find(x=>x.name===n);
        if(!q) return;
        addLogEntry(todayISO(), n, q.points);
      };
    });
  }

  // ------------- Settings / Backup -------------
  function renderSettings(){
    $("#sEuro").value = state.settings.euro||0.1;
    $("#sBase").value = state.settings.base||100;
    $("#sGrowth").value = state.settings.growth||0.1;
  }
  $("#sEuro").onchange = ()=>{ state.settings.euro=Number($("#sEuro").value||0); save(); renderAll(); };
  $("#sBase").onchange = ()=>{ state.settings.base=Number($("#sBase").value||100); save(); renderAll(); };
  $("#sGrowth").onchange = ()=>{ state.settings.growth=Number($("#sGrowth").value||0.1); save(); renderAll(); };
  $("#toggleDark").onchange = ()=>{ state.settings.dark=$("#toggleDark").checked; save(); ensureDarkMode(); };

  $("#btnExport").onclick = ()=>{
    const blob=new Blob([JSON.stringify(state,null,2)],{type:"application/json"});
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download="life_rpg_backup.json";
    a.click();
  };
  $("#btnImport").onclick = ()=> $("#fileImport").click();
  $("#fileImport").onchange = (e)=>{
    const f=e.target.files[0]; if(!f) return;
    const rd=new FileReader();
    rd.onload=()=>{
      try{
        const data=JSON.parse(rd.result);
        if(!data || typeof data!=="object") throw 0;
        state=data; save(); location.reload();
      }catch{ alert("Fehler beim Import."); }
    };
    rd.readAsText(f);
  };
  $("#btnResetAll").onclick=()=>{
    if(confirm("Wirklich ALLES l√∂schen?")){
      localStorage.removeItem(SKEY_V2);
      // alte Daten optional auch l√∂schen:
      // localStorage.removeItem(SKEY);
      location.reload();
    }
  };

  // ------------- Kategorie-Summen-Helfer (Dashboard & Milestones) -------------
  // (bereits weiter oben implementiert: categoryTotals)

  // ------------- Initialisierung -------------
  function renderAll(){
    ensureDarkMode();
    applyOverduePenalties();
    renderDashboard();
    renderLog();
    renderCatalog();
    renderCategories();
    renderMissions();
    renderSpecials();
    renderMilestones();
    renderContinuity();
    renderSettings();
  }

  // Start
  addCatAssignRow(); // initiale Zeile im Katalog
  show("menu");
  $("#logDate").value=todayISO();
  renderAll();
  </script>
</body>
</html>
