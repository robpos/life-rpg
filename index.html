<!doctype html>
<html lang="de" class="">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Life RPG</title>
  <script>
    // Tailwind CDN config ‚Äì Darkmode via .dark class
    tailwind = { config: { darkMode: 'class' } };
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
    }
    body { background:#f8fafc; color:#111; }
    .dark body { background:#0b1220; color:#e5e7eb; }
    .tab { display:none; }
    .tab.active { display:block; }
    .btn { border-radius:.75rem; padding:.5rem 1rem; border:1px solid #cbd5e1; background:#fff; }
    .dark .btn { border-color:#334155; background:#111827; color:#e5e7eb; }
    .input { width:100%; border-radius:.75rem; border:1px solid #cbd5e1; padding:.5rem .75rem; background:#fff; }
    .dark .input { border-color:#334155; background:#0f172a; color:#e5e7eb; }
    header.safe { padding-top: calc(var(--safe-top) + 28px); } /* weiter runter */
    .ach-card { background:#fff; color:#000; }                 /* Achievements immer schwarz */
    .ach-card.ok { background:#fde68a; }                       /* gelb bei ok */
    .ach-card.nok { background:#f1f5f9; }                      /* hellgrau sonst */
    .tile { @apply p-4 border rounded-xl bg-white dark:bg-slate-900 border-slate-200 dark:border-slate-700 flex items-center justify-between; }
    .menu-grid { @apply grid grid-cols-2 gap-3; }
  </style>
</head>
<body>
  <div class="max-w-xl mx-auto min-h-screen flex flex-col">
    <!-- Header -->
    <header class="safe px-4 pt-4 pb-3 sticky top-0 bg-white/80 dark:bg-slate-900/80 backdrop-blur z-10 border-b border-slate-200 dark:border-slate-700">
      <div class="flex items-center justify-between">
        <button id="btnHome" class="btn text-sm">‚ò∞ Men√º</button>
        <h1 class="text-xl font-bold flex items-center gap-2">üéÆ Life RPG</h1>
        <button id="themeToggle" class="btn text-sm">üåô/‚òÄÔ∏è</button>
      </div>
    </header>

    <!-- Main -->
    <main class="flex-1 px-4 pb-8 space-y-4">
      <!-- Hauptmen√º -->
      <section id="tab-home" class="tab active space-y-4">
        <h2 class="text-lg font-bold">Hauptmen√º</h2>
        <div class="menu-grid">
          <button class="tile" data-goto="dashboard"><span>üìä Dashboard</span> ‚ûú</button>
          <button class="tile" data-goto="log"><span>üìù Log</span> ‚ûú</button>
          <button class="tile" data-goto="catalog"><span>üìö Katalog</span> ‚ûú</button>
          <button class="tile" data-goto="special"><span>‚≠ê Sonderaufgaben</span> ‚ûú</button>
          <button class="tile" data-goto="milestones"><span>üéØ Meilensteine</span> ‚ûú</button>
          <button class="tile" data-goto="settings"><span>‚öôÔ∏è Einstellungen</span> ‚ûú</button>
          <button class="tile" data-goto="chat"><span>üí¨ Chat</span> ‚ûú</button>
        </div>
      </section>

      <!-- Dashboard -->
      <section id="tab-dashboard" class="tab space-y-4">
        <div class="grid grid-cols-3 gap-3 text-sm">
          <div class="p-3 rounded border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900">
            Punkte<br><span id="totalPoints" class="text-lg font-bold">0</span>
          </div>
          <div class="p-3 rounded border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900">
            Level<br><span id="currentLevel" class="text-lg font-bold">1</span>
          </div>
          <div class="p-3 rounded border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900">
            Sparstand<br>‚Ç¨<span id="savingsTotal" class="text-lg font-bold">0.00</span>
          </div>
        </div>

        <div>
          <h3 class="font-bold">Level-Fortschritt</h3>
          <div id="levelBar"></div>
        </div>

        <div>
          <h3 class="font-bold">Achievements</h3>
          <div id="achievements" class="space-y-2"></div>
        </div>

        <div>
          <h3 class="font-bold">Statistik (letzte 14 Tage)</h3>
          <canvas id="statsChart" class="w-full h-40 rounded border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900"></canvas>
        </div>

        <div>
          <h3 class="font-bold">Heute offen</h3>
          <div id="todaySuggestions" class="space-y-2"></div>
        </div>

        <div>
          <h3 class="font-bold">Tagesziel</h3>
          <div id="dailyGoalBox" class="p-2 border rounded bg-gray-50 dark:bg-slate-800 text-sm"></div>
        </div>

        <div class="pt-2">
          <button class="btn" data-goto="home">‚üµ Zur√ºck zum Hauptmen√º</button>
        </div>
      </section>

      <!-- Log -->
      <section id="tab-log" class="tab space-y-4">
        <div class="space-y-2">
          <input type="date" id="logDate" class="input" />
          <div class="grid gap-2">
            <!-- Schnellauswahl -->
            <select id="logQuick" class="input">
              <option value="">‚Äì Schnellauswahl aus Katalog ‚Äì</option>
            </select>
            <div id="logChips" class="flex flex-wrap gap-2"></div>
          </div>
          <input type="text" id="logQuest" class="input" placeholder="Questname (oder aus Schnellauswahl w√§hlen)" />
          <div class="grid grid-cols-2 gap-2">
            <input type="number" id="logPoints" class="input" placeholder="Punkte (optional)" />
            <input type="number" id="logMalus" class="input" placeholder="Malus (z. B. -10)" />
          </div>
          <button id="btnAddEntry" class="btn bg-blue-600 text-white">Eintragen</button>
        </div>
        <div id="logList" class="space-y-1 text-sm"></div>

        <div class="pt-2">
          <button class="btn" data-goto="home">‚üµ Zur√ºck zum Hauptmen√º</button>
        </div>
      </section>

      <!-- Katalog -->
      <section id="tab-catalog" class="tab space-y-4">
        <div class="space-y-2">
          <input id="qName" class="input" placeholder="Questname (z. B. 'Keller aufr√§umen')" />
          <input id="qPoints" type="number" class="input" placeholder="Punkte" />
          <label class="text-sm flex items-center gap-2">
            <input id="qBoss" type="checkbox" />
            Bossquest
          </label>
          <button id="btnAddQuest" class="btn bg-blue-600 text-white">Zur Liste hinzuf√ºgen</button>
        </div>
        <div id="catalogList" class="mt-2 space-y-2"></div>

        <div class="pt-2">
          <button class="btn" data-goto="home">‚üµ Zur√ºck zum Hauptmen√º</button>
        </div>
      </section>

      <!-- Sonderaufgaben (Cooldown) -->
      <section id="tab-special" class="tab space-y-4">
        <div class="space-y-2">
          <h3 class="font-bold text-lg">Sonderaufgaben (Cooldown)</h3>
          <div class="grid grid-cols-3 gap-2">
            <input id="spName" class="input col-span-3" placeholder="Name (z. B. Blumen gie√üen)" />
            <input id="spPoints" type="number" class="input" placeholder="Punkte" />
            <input id="spDays" type="number" class="input" placeholder="Alle X Tage" />
            <button id="btnAddSpecial" class="btn bg-blue-600 text-white">Hinzuf√ºgen</button>
          </div>
          <p class="text-xs text-slate-500">Nach dem Erledigen wird die Aufgabe f√ºr die angegebene Anzahl Tage gesperrt.</p>
        </div>

        <div>
          <h4 class="font-bold mt-2">Jetzt verf√ºgbar</h4>
          <div id="specialAvail" class="space-y-2"></div>
        </div>

        <div>
          <h4 class="font-bold mt-4">Gesperrt</h4>
          <div id="specialLocked" class="space-y-2 text-slate-600"></div>
        </div>

        <div class="pt-2">
          <button class="btn" data-goto="home">‚üµ Zur√ºck zum Hauptmen√º</button>
        </div>
      </section>

      <!-- Meilensteine -->
      <section id="tab-milestones" class="tab space-y-4">
        <h3 class="font-bold text-lg">Meilensteine</h3>
        <div id="milestoneBoxes" class="space-y-3"></div>

        <div class="pt-2">
          <button class="btn" data-goto="home">‚üµ Zur√ºck zum Hauptmen√º</button>
        </div>
      </section>

      <!-- Einstellungen -->
      <section id="tab-settings" class="tab space-y-4">
        <div class="space-y-2">
          <label class="text-sm">‚Ç¨ pro Punkt
            <input id="sEuro" type="number" step="0.01" class="input">
          </label>
          <label class="text-sm">Basis-Inkrement
            <input id="sBase" type="number" class="input">
          </label>
          <label class="text-sm">Wachstum (z. B. 0.1 = +10%)
            <input id="sGrowth" type="number" step="0.01" class="input">
          </label>
          <label class="text-sm">Tagesziel (Eintr√§ge pro Tag)
            <input id="sDailyGoal" type="number" class="input">
          </label>
          <label class="text-sm">Theme
            <select id="sTheme" class="input">
              <option value="light">Hell</option>
              <option value="dark">Dunkel</option>
              <option value="auto">System</option>
            </select>
          </label>
        </div>
        <div class="mt-4 space-y-2">
          <button id="btnExport" class="btn">Export</button>
          <input type="file" id="fileImport" class="hidden" accept="application/json" />
          <button id="btnImport" class="btn">Import</button>
          <button id="btnReset" class="btn bg-red-600 text-white">Alles l√∂schen</button>
        </div>

        <div class="pt-2">
          <button class="btn" data-goto="home">‚üµ Zur√ºck zum Hauptmen√º</button>
        </div>
      </section>

      <!-- Chat -->
      <section id="tab-chat" class="tab space-y-3">
        <div id="chatLog" class="h-64 overflow-y-auto border border-slate-200 dark:border-slate-700 p-2 rounded bg-white dark:bg-slate-900 text-sm"></div>
        <div class="flex gap-2">
          <input id="chatInput" class="input flex-1" placeholder="Frag nach Vorschl√§gen (‚ÄûWas soll ich machen?‚Äú) oder nenne eine Quest" />
          <button id="btnChatSend" class="btn bg-blue-600 text-white">Senden</button>
        </div>

        <div class="pt-2">
          <button class="btn" data-goto="home">‚üµ Zur√ºck zum Hauptmen√º</button>
        </div>
      </section>
    </main>
  </div>

  <script>
  // ====== STATE & STORAGE ======
  const SKEY = "lifeRPG_p1";
  const defaultState = {
    log: [],
    settings: { euro: 0.1, base: 100, growth: 0.1, dailyGoal: 3, theme: "light" },
    catalog: [
      {name:"Sport",points:20,boss:false},
      {name:"Kein Essen bestellt",points:10,boss:false},
      {name:"Aufr√§umen",points:5,boss:false}
    ],
    rewards: [],
    specialTasks: [], // {name, points, everyDays, lastDone}
    milestonesClaimed: [] // ['quests-100', 'boss-10', ...]
  };

  function load(){
    try {
      const s = JSON.parse(localStorage.getItem(SKEY));
      if(!s) return structuredClone(defaultState);
      return migrate(s);
    } catch {
      return structuredClone(defaultState);
    }
  }
  function save(){ localStorage.setItem(SKEY, JSON.stringify(state)); }

  function migrate(s){
    s.settings = Object.assign({ euro:0.1, base:100, growth:0.1, dailyGoal:3, theme:"light" }, s.settings||{});
    s.catalog = (s.catalog||[]).map(q=>({boss:false, ...q}));
    s.rewards = s.rewards || [];
    s.specialTasks = s.specialTasks || [];
    s.milestonesClaimed = s.milestonesClaimed || [];
    return s;
  }

  let state = load();

  // ====== HELPERS ======
  const todayISO = () => new Date().toISOString().slice(0,10);
  function totalPoints(){ return state.log.reduce((s,e)=>s+e.points,0); }
  function levelForPoints(p){
    let lvl=1, need=state.settings.base;
    while(p>=need){ lvl++; p-=need; need=Math.round(need*(1+state.settings.growth)); }
    return lvl;
  }
  function streakCount(){
    const days = [...new Set(state.log.map(e=>e.date))].sort();
    if(days.length===0) return 0;
    let streak = 1;
    for(let i=days.length-1;i>0;i--){
      const d1=new Date(days[i]), d0=new Date(days[i-1]);
      const diff=(d1-d0)/(1000*60*60*24);
      if(diff===1) streak++; else break;
    }
    return streak;
  }
  // Streak-Multiplikator (max +20%, +2%/Tag)
  const STREAK_PER_DAY = 0.02, STREAK_MAX = 0.2;
  function computePoints(base, dateISO){
    const mult = Math.min(STREAK_MAX, streakCount()*STREAK_PER_DAY);
    return Math.round((base||0)*(1+mult));
  }
  function euro(val){ return (val||0).toFixed(2); }

  // ====== THEME ======
  function applyTheme(){
    const t = state.settings.theme;
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    const dark = (t==='dark') || (t==='auto' && prefersDark);
    document.documentElement.classList.toggle('dark', dark);
  }
  document.getElementById('themeToggle').addEventListener('click', ()=>{
    state.settings.theme = state.settings.theme==='dark' ? 'light' : 'dark';
    save(); applyTheme();
  });

  // ====== NAVIGATION ======
  function goto(tabId){
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    document.getElementById("tab-"+tabId).classList.add("active");
    // Bei Wechsel in Dashboard: Statistik neu zeichnen
    if(tabId==='dashboard') renderStats();
    // Beim √ñffnen Log: Schnellauswahl aktualisieren
    if(tabId==='log') fillLogQuick();
  }
  function bindMenu(){
    document.getElementById("btnHome").addEventListener("click", ()=>goto('home'));
    document.querySelectorAll("[data-goto]").forEach(btn=>{
      btn.addEventListener("click", ()=>goto(btn.getAttribute("data-goto")));
    });
  }

  // ====== DASHBOARD ======
  function renderLevelProgress(){
    const total = totalPoints();
    const lvl = levelForPoints(total);
    let need = state.settings.base, sum=0;
    for(let i=1;i<lvl;i++){ sum+=need; need=Math.round(need*(1+state.settings.growth)); }
    const current = total - sum;
    const pct = Math.min(100, Math.round((current/need)*100));
    return `
      <div class="w-full bg-gray-200 dark:bg-slate-800 rounded h-3 overflow-hidden">
        <div class="bg-blue-500 h-3" style="width:${pct}%"></div>
      </div>
      <div class="text-xs mt-1">Noch ${Math.max(0, need-current)} Punkte bis Level ${lvl+1}</div>
    `;
  }
  function renderAchievements(){
    const total=totalPoints();
    const s=streakCount();
    const sportCount=state.log.filter(e=> (e.quest||'').toLowerCase().includes('sport')).length;
    const list=[
      {ok: total>=100, icon:"üèÖ", text:"100 Punkte erreicht"},
      {ok: s>=5, icon:"üî•", text:"5 Tage Streak"},
      {ok: sportCount>=10, icon:"üí™", text:"10x Sport gemacht"}
    ];
    return list.map(a=>`
      <div class="ach-card ${a.ok?'ok':'nok'} p-2 border rounded">
        ${a.icon} ${a.text} ${a.ok?'‚úÖ':'‚ùå'}
      </div>
    `).join('');
  }
  function renderStats(){
    const cvs=document.getElementById("statsChart");
    const ctx=cvs.getContext("2d");
    const W=cvs.width=cvs.clientWidth||300;
    const H=cvs.height=cvs.clientHeight||160;
    const today=new Date();
    const days=[];
    for(let i=13;i>=0;i--){
      const d=new Date(today);
      d.setDate(d.getDate()-i);
      const iso=d.toISOString().slice(0,10);
      const sum=state.log.filter(e=>e.date===iso).reduce((s,e)=>s+e.points,0);
      days.push({label:iso.slice(5),value:sum});
    }
    ctx.clearRect(0,0,W,H);
    const max=Math.max(10,...days.map(d=>d.value));
    const barW=W/days.length*0.6;
    const dark = document.documentElement.classList.contains('dark');
    days.forEach((d,i)=>{
      const x=i*(W/days.length)+barW*0.2;
      const h=(d.value/max)*(H-22);
      const y=H-h-18;
      ctx.fillStyle = dark ? "#60a5fa" : "#3b82f6";
      ctx.fillRect(x,y,barW,h);
      ctx.fillStyle = dark ? "#94a3b8" : "#64748b";
      ctx.font="10px sans-serif";
      if(i%2===0) ctx.fillText(d.label,x,H-5);
    });
  }
  function renderTodaySuggestions(){
    const box=document.getElementById("todaySuggestions");
    const today=todayISO();
    const doneToday=new Set(state.log.filter(e=>e.date===today).map(e=>e.quest));
    const available=state.catalog.filter(q=>!doneToday.has(q.name)).slice(0,5);
    box.innerHTML = available.length
      ? available.map(q=>`<button data-sug="${q.name}" class="btn w-full text-left">‚ûï ${q.name} (+${q.points} Punkte)</button>`).join('')
      : `<div class="text-slate-500 text-sm">Alles erledigt üéâ</div>`;
    box.querySelectorAll("[data-sug]").forEach(btn=>{
      btn.addEventListener("click",()=>{
        quickAdd(btn.getAttribute("data-sug"));
      });
    });
  }
  function renderDailyGoal(){
    const box=document.getElementById("dailyGoalBox");
    const today=todayISO();
    const count=state.log.filter(e=>e.date===today).length;
    const goal=state.settings.dailyGoal||3;
    if(count>=goal){
      box.innerHTML=`‚úÖ Tagesziel erreicht (${count}/${goal}) üéâ`;
      box.className="p-2 border rounded bg-green-100 dark:bg-green-900/40 text-sm";
    }else{
      box.innerHTML=`üîÑ ${count}/${goal} erledigt ‚Äì noch ${goal-count} offen`;
      box.className="p-2 border rounded bg-yellow-100 dark:bg-yellow-900/40 text-sm";
    }
  }
  function renderDashboard(){
    document.getElementById("totalPoints").textContent = totalPoints();
    document.getElementById("currentLevel").textContent = levelForPoints(totalPoints());
    document.getElementById("savingsTotal").textContent = euro(totalPoints()*state.settings.euro);
    document.getElementById("levelBar").innerHTML = renderLevelProgress();
    document.getElementById("achievements").innerHTML = renderAchievements();
    renderStats();
    renderTodaySuggestions();
    renderDailyGoal();
  }

  // ====== LOG ======
  function renderLogList(){
    const list=document.getElementById("logList");
    list.innerHTML = state.log.map(e=>{
      const neg = e.points<0;
      return `<div class="p-2 rounded border ${neg?'bg-red-50 dark:bg-red-900/30':'bg-white dark:bg-slate-900'} border-slate-200 dark:border-slate-700">
        ${e.date} ‚Ä¢ ${e.quest} ${e.points>=0?'+':''}${e.points}
      </div>`;
    }).join('') || "<div class='text-sm text-slate-500'>Noch keine Eintr√§ge.</div>";
  }
  function addLog(){
    const d = document.getElementById("logDate").value || todayISO();
    const q = (document.getElementById("logQuest").value||"").trim();
    const manualPts = Number(document.getElementById("logPoints").value||0);
    const malus = Number(document.getElementById("logMalus").value||0);

    // Basis bestimmen: manuell > Katalog > 0
    let base = manualPts;
    if(!base && q){
      const found = state.catalog.find(x=>x.name.toLowerCase()===q.toLowerCase());
      if(found) base = found.points;
    }
    if(!q && base===0){
      alert("Bitte Questname und/oder Punkte angeben.");
      return;
    }
    const name = q || "(ohne Name)";
    const pts = computePoints(base||0, d) + malus;

    state.log.push({date:d, quest:name, points:pts, base: base||0});
    save(); renderAll();

    // Felder leeren
    document.getElementById("logQuest").value="";
    document.getElementById("logPoints").value="";
    document.getElementById("logMalus").value="";
    document.getElementById("logQuick").value="";
  }

  // Quick-add f√ºr Vorschl√§ge/Buttons
  function quickAdd(questName){
    const q = state.catalog.find(x=>x.name===questName);
    const base = q ? q.points : 0;
    const pts = computePoints(base, todayISO());
    state.log.push({date:todayISO(), quest: questName, points: pts, base});
    save(); renderAll();
  }

  // Schnellauswahl im Log (Dropdown + Chips)
  function fillLogQuick(){
    const sel = document.getElementById("logQuick");
    const chips = document.getElementById("logChips");
    // Dropdown
    sel.innerHTML = `<option value="">‚Äì Schnellauswahl aus Katalog ‚Äì</option>` +
      state.catalog.map(q=>`<option value="${q.name}">${q.boss?'üëë ':''}${q.name} (+${q.points})</option>`).join('');
    sel.onchange = ()=>{
      const name=sel.value;
      if(!name) return;
      const q = state.catalog.find(x=>x.name===name);
      document.getElementById("logQuest").value = q.name;
      document.getElementById("logPoints").value = q.points;
    };
    // Chips: Top 6 nach H√§ufigkeit
    const stats = {};
    state.log.forEach(e=>{ stats[e.quest]=(stats[e.quest]||0)+1; });
    const top = Object.entries(stats).sort((a,b)=>b[1]-a[1]).slice(0,6).map(([name])=>name);
    chips.innerHTML = top.map(n=>`<button class="btn text-xs" data-chip="${n}">‚ûï ${n}</button>`).join('') ||
      `<div class="text-xs text-slate-500">Noch keine Schnellvorschl√§ge ‚Äì trage ein paar Quests ein.</div>`;
    chips.querySelectorAll("[data-chip]").forEach(b=>{
      b.onclick=()=> quickAdd(b.getAttribute("data-chip"));
    });
  }

  function renderLog(){
    document.getElementById("logDate").value = todayISO();
    fillLogQuick();
    renderLogList();
  }

  // ====== KATALOG ======
  function renderCatalog(){
    const list=document.getElementById("catalogList");
    list.innerHTML = state.catalog.map((q,i)=>`
      <div class="p-2 border rounded flex items-center justify-between ${q.boss?'bg-yellow-50 dark:bg-yellow-900/30':'bg-white dark:bg-slate-900'} border-slate-200 dark:border-slate-700">
        <span>${q.boss?'üëë ':''}${q.name} (+${q.points} Punkte)</span>
        <div class="flex gap-2">
          <button class="btn text-sm" data-quick="${i}">‚ûï</button>
          <button class="btn text-sm text-red-600" data-del="${i}">L√∂schen</button>
        </div>
      </div>
    `).join('') || "<div class='text-sm text-slate-500'>Noch keine Eintr√§ge im Katalog.</div>";

    list.querySelectorAll("[data-del]").forEach(btn=>{
      btn.addEventListener("click",()=>{
        const idx=Number(btn.getAttribute("data-del"));
        state.catalog.splice(idx,1);
        save(); renderAll();
      });
    });
    list.querySelectorAll("[data-quick]").forEach(btn=>{
      btn.addEventListener("click",()=>{
        const idx=Number(btn.getAttribute("data-quick"));
        quickAdd(state.catalog[idx].name);
      });
    });
  }
  function addQuest(){
    const name=(document.getElementById("qName").value||"").trim();
    const points=Number(document.getElementById("qPoints").value||0);
    const boss=document.getElementById("qBoss").checked;
    if(!name || !points){ alert("Bitte Name und Punkte angeben."); return; }
    state.catalog.push({name,points,boss});
    save(); renderAll();
    document.getElementById("qName").value="";
    document.getElementById("qPoints").value="";
    document.getElementById("qBoss").checked=false;
  }

  // ====== SONDERAUFGABEN (Cooldown) ======
  const daysBetween = (a,b)=> Math.floor((new Date(b)-new Date(a))/(1000*60*60*24));
  function spIsAvailable(t){
    if(!t.lastDone) return true;
    return daysBetween(t.lastDone, todayISO()) >= Number(t.everyDays||1);
  }
  function spNextDate(t){
    if(!t.lastDone) return todayISO();
    const d=new Date(t.lastDone);
    d.setDate(d.getDate()+Number(t.everyDays||1));
    return d.toISOString().slice(0,10);
  }
  function renderSpecial(){
    const avail=document.getElementById("specialAvail");
    const lock=document.getElementById("specialLocked");
    const list=state.specialTasks.map((t,i)=>({...t,i}));
    const available=list.filter(spIsAvailable);
    const locked=list.filter(t=>!spIsAvailable(t));

    avail.innerHTML = available.length ? available.map(t=>`
      <div class="p-2 border rounded flex items-center justify-between bg-white dark:bg-slate-900 border-slate-200 dark:border-slate-700">
        <div>
          <div class="font-medium">‚≠ê ${t.name}</div>
          <div class="text-xs text-slate-500">+${t.points} Punkte ‚Ä¢ alle ${t.everyDays} Tage</div>
        </div>
        <div class="flex gap-2">
          <button class="btn text-sm" data-sp-done="${t.i}">Erledigt</button>
          <button class="btn text-sm" data-sp-edit="${t.i}">‚úé</button>
          <button class="btn text-sm text-red-600" data-sp-del="${t.i}">L√∂schen</button>
        </div>
      </div>
    `).join('') : `<div class="text-sm text-slate-500">Zurzeit nichts verf√ºgbar.</div>`;

    lock.innerHTML = locked.length ? locked.map(t=>{
      const nd=spNextDate(t);
      const rest=Math.max(0, daysBetween(todayISO(), nd));
      return `
        <div class="p-2 border rounded bg-gray-50 dark:bg-slate-800 flex items-center justify-between border-slate-200 dark:border-slate-700">
          <div>
            <div class="font-medium">‚õî ${t.name}</div>
            <div class="text-xs">wieder am ${nd}${rest>0?` (in ${rest} Tagen)`:''}</div>
          </div>
          <div class="flex gap-2">
            <button class="btn text-sm" data-sp-edit="${t.i}">‚úé</button>
            <button class="btn text-sm text-red-600" data-sp-del="${t.i}">L√∂schen</button>
          </div>
        </div>`;
    }).join('') : `<div class="text-sm text-slate-500">Keine gesperrten Aufgaben.</div>`;

    document.querySelectorAll("[data-sp-done]").forEach(b=>{
      b.onclick=()=>{
        const i=Number(b.getAttribute("data-sp-done"));
        const t=state.specialTasks[i];
        if(!t) return;
        const pts=computePoints(Number(t.points||0), todayISO());
        state.log.push({date:todayISO(),quest:`Sonder: ${t.name}`,points:pts,base:Number(t.points||0)});
        t.lastDone = todayISO();
        save(); renderAll();
      };
    });
    document.querySelectorAll("[data-sp-del]").forEach(b=>{
      b.onclick=()=>{
        const i=Number(b.getAttribute("data-sp-del"));
        if(confirm("Sonderaufgabe wirklich l√∂schen?")){
          state.specialTasks.splice(i,1);
          save(); renderAll();
        }
      };
    });
    document.querySelectorAll("[data-sp-edit]").forEach(b=>{
      b.onclick=()=>{
        const i=Number(b.getAttribute("data-sp-edit"));
        const t=state.specialTasks[i]; if(!t) return;
        const name=prompt("Name:", t.name); if(name===null) return;
        const points=prompt("Punkte:", t.points); if(points===null) return;
        const days=prompt("Alle wie viele Tage?", t.everyDays); if(days===null) return;
        Object.assign(t,{
          name: (name||"").trim()||t.name,
          points: Number(points)||t.points,
          everyDays: Math.max(1, Number(days)||t.everyDays)
        });
        save(); renderAll();
      };
    });
  }
  function bindSpecialForm(){
    const btn=document.getElementById("btnAddSpecial");
    if(btn && !btn._bound){
      btn._bound=true;
      btn.addEventListener("click", ()=>{
        const name=(document.getElementById("spName").value||"").trim();
        const points=Number(document.getElementById("spPoints").value||0);
        const days=Math.max(1, Number(document.getElementById("spDays").value||0));
        if(!name || !points || !days){ alert("Bitte Name, Punkte und Tage ausf√ºllen."); return; }
        state.specialTasks.push({name, points, everyDays: days, lastDone: null});
        save(); renderAll();
        document.getElementById("spName").value="";
        document.getElementById("spPoints").value="";
        document.getElementById("spDays").value="";
      });
    }
  }

  // ====== MEILENSTEINE ======
  const MS = {
    quests:  [ {count:100,reward:100}, {count:200,reward:400}, {count:500,reward:2500}, {count:1000,reward:10000} ],
    boss:    [ {count:10,reward:100}, {count:20,reward:200}, {count:50,reward:2500}, {count:100,reward:10000} ],
    missions:[ {count:5,reward:50}, {count:10,reward:100}, {count:20,reward:400}, {count:50,reward:2500} ] // Placeholder ‚Äì Missionssystem sp√§ter
  };
  function msKey(group, count){ return `${group}-${count}`; }

  function countQuestsDone(){
    // alle Log-Eintr√§ge mit Punkten != 0 (Rewards ‚ÄûKauf‚Äú mit negativ z√§hlen auch)
    return state.log.filter(e=>typeof e.points==='number').length;
  }
  function countBossDone(){
    const bossNames = new Set(state.catalog.filter(q=>q.boss).map(q=>q.name));
    return state.log.filter(e=> bossNames.has(e.quest)).length;
  }
  function countMissionsDone(){
    // Missionssystem noch nicht aktiv ‚Üí 0 (Struktur vorhanden, UI zeigt Status)
    return 0;
  }

  function renderMilestones(){
    const box = document.getElementById("milestoneBoxes");
    const qDone = countQuestsDone();
    const bDone = countBossDone();
    const mDone = countMissionsDone();

    const groups = [
      {id:'quests',    title:'üìö Quests gesamt',      done:qDone, conf:MS.quests},
      {id:'boss',      title:'üëë Bossquests',         done:bDone, conf:MS.boss},
      {id:'missions',  title:'üß≠ Missionen (bald)',   done:mDone, conf:MS.missions}
    ];

    box.innerHTML = groups.map(g=>{
      const items = g.conf.map(ms=>{
        const reached = g.done >= ms.count;
        const key = msKey(g.id, ms.count);
        const claimed = state.milestonesClaimed.includes(key);
        return `
          <div class="p-2 border rounded bg-white dark:bg-slate-900 border-slate-200 dark:border-slate-700 flex items-center justify-between">
            <div>
              <div class="font-medium">${g.title}: ${ms.count}</div>
              <div class="text-xs text-slate-500">Belohnung: +${ms.reward} Punkte</div>
            </div>
            <div>
              ${reached
                ? (claimed
                    ? `<span class="text-green-600">‚úÖ Eingel√∂st</span>`
                    : `<button class="btn text-sm bg-green-600 text-white" data-claim="${g.id}|${ms.count}|${ms.reward}">Einl√∂sen</button>`
                  )
                : `<span class="text-slate-500">${g.done}/${ms.count}</span>`}
            </div>
          </div>
        `;
      }).join('');
      return `<div class="space-y-2">${items}</div>`;
    }).join('');

    // Claim-Buttons
    box.querySelectorAll("[data-claim]").forEach(b=>{
      b.onclick=()=>{
        const [id,count,reward] = b.getAttribute("data-claim").split("|");
        const key = msKey(id, Number(count));
        if(state.milestonesClaimed.includes(key)) return;
        state.milestonesClaimed.push(key);
        state.log.push({date:todayISO(), quest:`Milestone: ${id} ${count}`, points: Number(reward)});
        save(); renderAll();
        alert(`üéØ Meilenstein eingel√∂st: ${id} ${count} (+${reward} Punkte)`);
      };
    });
  }

  // ====== SETTINGS ======
  function renderSettings(){
    const s=state.settings;
    document.getElementById("sEuro").value = s.euro;
    document.getElementById("sBase").value = s.base;
    document.getElementById("sGrowth").value = s.growth;
    document.getElementById("sDailyGoal").value = s.dailyGoal;
    document.getElementById("sTheme").value = s.theme;

    document.getElementById("sEuro").onchange = e=>{ s.euro=Number(e.target.value||0); save(); renderAll(); };
    document.getElementById("sBase").onchange = e=>{ s.base=Number(e.target.value||100); save(); renderAll(); };
    document.getElementById("sGrowth").onchange = e=>{ s.growth=Number(e.target.value||0.1); save(); renderAll(); };
    document.getElementById("sDailyGoal").onchange = e=>{ s.dailyGoal=Number(e.target.value||1); save(); renderAll(); };
    document.getElementById("sTheme").onchange = e=>{ s.theme=e.target.value; save(); applyTheme(); };

    document.getElementById("btnExport").onclick=()=>{
      const blob=new Blob([JSON.stringify(state,null,2)],{type:"application/json"});
      const a=document.createElement("a");
      a.href=URL.createObjectURL(blob);
      a.download="life_rpg_backup.json";
      a.click();
    };
    document.getElementById("btnImport").onclick=()=> document.getElementById("fileImport").click();
    document.getElementById("fileImport").onchange=(e)=>{
      const f=e.target.files[0]; if(!f) return;
      const reader=new FileReader();
      reader.onload=()=>{
        try{
          const obj=JSON.parse(reader.result);
          state=migrate(obj); save(); renderAll();
          alert("Import erfolgreich.");
        }catch{ alert("Fehler beim Import!"); }
      };
      reader.readAsText(f);
    };
    document.getElementById("btnReset").onclick=()=>{
      if(confirm("Alles wirklich l√∂schen?")){
        state = structuredClone(defaultState);
        save(); renderAll();
      }
    };
  }

  // ====== CHAT (leicht) ======
  function chatAdd(msg, from="bot"){
    const log=document.getElementById("chatLog");
    const row=document.createElement("div");
    row.className = from==="user" ? "text-right" : "text-left text-blue-700";
    row.textContent = msg;
    log.appendChild(row);
    log.scrollTop = log.scrollHeight;
  }
  function processMessage(msg){
    const text = (msg||"").trim().toLowerCase();
    // Vorschl√§ge
    if((text.includes("was") && text.includes("machen")) || text.includes("vorschlag")){
      const today=todayISO();
      const done=new Set(state.log.filter(e=>e.date===today).map(e=>e.quest));
      const open=state.catalog.filter(q=>!done.has(q.name)).slice(0,5);
      if(open.length===0) return ["üéâ Alles erledigt!"];
      open.forEach(q=> chatAdd(`‚ûï ${q.name} (+${q.points} Punkte)`,"bot"));
      return ["üëâ Vorschl√§ge oben als Liste."];
    }
    // R√ºckg√§ngig
    if(text.includes("r√ºckg√§ngig") || text.includes("letzte quest")){
      if(state.log.length===0) return ["Kein Eintrag vorhanden."];
      const last=state.log.pop(); save(); renderAll();
      return [`üóëÔ∏è Letzte Quest gel√∂scht: ${last.quest} (${last.points} Punkte)`];
    }
    // ‚Äûzeige ‚Äú
    if(text.startsWith("zeige ")){
      const q=text.replace("zeige ","").trim();
      const res=state.log.filter(e=> e.quest.toLowerCase().includes(q));
      if(res.length===0) return ["‚ùå Nichts gefunden."];
      return ["üîç Ergebnisse:", ...res.slice(-10).map(e=>`${e.date} ‚Ä¢ ${e.quest} (${e.points} Punkte)`)];
    }
    // Falls ein Katalogname genannt ‚Üí eintragen
    const found = state.catalog.find(q=> text.includes(q.name.toLowerCase()));
    if(found){
      const pts=computePoints(found.points, todayISO());
      state.log.push({date:todayISO(), quest:found.name, points:pts, base:found.points});
      save(); renderAll();
      return [`‚úÖ Eingetragen: ${found.name} (+${pts} Punkte)`];
    }
    // Sonst neue Quest mit +5
    const nq = msg.trim();
    if(nq){
      state.catalog.push({name:nq,points:5,boss:false});
      const pts=computePoints(5, todayISO());
      state.log.push({date:todayISO(), quest:nq, points:pts, base:5});
      save(); renderAll();
      return [`‚ûï Neue Quest angelegt & eingetragen: ${nq} (+${pts} Punkte)`];
    }
    return ["Ich habe dich nicht verstanden üòÖ"];
  }
  function bindChat(){
    const input=document.getElementById("chatInput");
    document.getElementById("btnChatSend").addEventListener("click", ()=>{
      const txt=(input.value||"").trim();
      if(!txt) return;
      chatAdd(txt,"user");
      const res=processMessage(txt);
      (res||[]).forEach(r=>chatAdd(r,"bot"));
      input.value="";
    });
  }

  // ====== RENDER ALL ======
  function renderAll(){
    applyTheme();
    renderDashboard();
    renderLog();
    renderCatalog();
    renderSpecial();
    bindSpecialForm();
    renderSettings();
    renderMilestones();
  }

  // ====== INIT ======
  (function init(){
    applyTheme();
    bindMenu();
    document.getElementById("btnAddEntry").addEventListener("click", addLog);
    document.getElementById("btnAddQuest").addEventListener("click", addQuest);
    bindChat();
    renderAll();
    window.addEventListener("resize", ()=>{ if(document.getElementById("tab-dashboard").classList.contains("active")) renderStats(); });
  })();
  </script>
</body>
</html>